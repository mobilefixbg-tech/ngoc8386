<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ngọc Phát Tài 1990</title>

    <style>
        :root{
            --ui-font-size:14px;
            --primary:#6366f1;
            --primary-hover:#4f46e5;
            --secondary:#8b5cf6;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
            --surface:#ffffff;
            --surface-elevated:#f8fafc;
            --border:#e2e8f0;
            --text:#1e293b;
            --text-secondary:#64748b;
            --text-muted:#94a3b8;
            --shadow-sm:0 1px 2px rgba(0,0,0,0.05);
            --shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-xl:0 20px 25px -5px rgba(0,0,0,0.1),0 8px 10px -6px rgba(0,0,0,0.1);
            --radius-sm:6px;
            --radius:10px;
            --radius-lg:16px;
            --radius-xl:24px;
            --transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --glass:rgba(255, 255, 255, 0.7);
            --glass-border:rgba(255, 255, 255, 0.3);
        }
        *{box-sizing:border-box}
        html,body{
            margin:0;
            height:100%;
            display:flex;
            flex-direction:column;
            font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow:hidden;
            background:linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            color:var(--text);
        }
        ::-webkit-scrollbar{width:8px;height:8px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
        ::-webkit-scrollbar-thumb:hover{background:#94a3b8}

        .navbar{
            display:flex;
            align-items:center;
            padding:10px 16px;
            background:var(--glass);
            backdrop-filter:blur(20px);
            -webkit-backdrop-filter:blur(20px);
            border-bottom:1px solid var(--glass-border);
            gap:10px;
            box-shadow:var(--shadow-sm);
            position:relative;
            z-index:100;
        }
        .navbar button{
            margin-right:0;
            padding:10px 16px;
            border:none;
            border-radius:var(--radius);
            background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            font-size:var(--ui-font-size);
            font-weight:600;
            color:var(--text);
            cursor:pointer;
            pointer-events:auto !important;
            transition:var(--transition);
            box-shadow:var(--shadow-sm);
        }
        .navbar button:hover{
            transform:translateY(-1px);
            box-shadow:var(--shadow);
            background:linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        }
        .navbar button:active{
            transform:translateY(0);
        }
        .navbar button.primary{
            background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color:white;
        }
        .navbar button.primary:hover{
            background:linear-gradient(135deg, var(--primary-hover) 0%, #7c3aed 100%);
        }
        .navbar input{
            flex:1;
            padding:12px 18px;
            border-radius:var(--radius-xl);
            border:2px solid transparent;
            background:rgba(255,255,255,0.8);
            font-size:var(--ui-font-size);
            transition:var(--transition);
            box-shadow:inset 0 2px 4px rgba(0,0,0,0.04);
        }
        .navbar input:focus{
            outline:none;
            border-color:var(--primary);
            background:white;
            box-shadow:var(--shadow),0 0 0 3px rgba(99,102,241,0.15);
        }
        .zoom-wrap{display:flex;align-items:center;gap:8px;margin-left:8px}
        .zoom-wrap span{font-size:13px;color:var(--text-secondary);white-space:nowrap;font-weight:500}
        .zoom-input{
            width:80px;
            padding:10px 12px;
            border:2px solid transparent;
            border-radius:var(--radius);
            font-size:13px;
            background:rgba(255,255,255,0.8);
            transition:var(--transition);
        }
        .zoom-input:focus{
            outline:none;
            border-color:var(--primary);
            background:white;
        }
        .brand-script{
            margin-left:8px;
            margin-right:12px;
            font-family:'Dancing Script', 'Great Vibes', 'Brush Script MT', cursive;
            font-size:32px;
            font-weight:700;
            letter-spacing:0.5px;
            white-space:nowrap;
            background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899, #f43f5e, #6366f1);
            background-size:300% 300%;
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            animation:brandShift 4s ease infinite;
            text-shadow:0 2px 10px rgba(99,102,241,0.3);
        }
        @keyframes brandShift{
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        .main{flex:1;display:flex;min-height:0;position:relative}
        .main.hidden{display:none}
        #browserArea{flex:1;display:flex;min-height:0;border-radius:var(--radius-lg);overflow:hidden;margin:12px;margin-top:0;box-shadow:var(--shadow-lg)}
        webview{flex:1;width:100%;height:100%;display:flex;border:none;border-radius:var(--radius-lg)}
        .history-wrap{
            padding:16px;
            border-top:1px solid var(--border);
            max-height:280px;
            overflow:auto;
            background:rgba(255,255,255,0.5);
            backdrop-filter:blur(10px);
            border-radius:var(--radius-lg) var(--radius-lg) 0 0;
        }
        .history-wrap.hidden{display:none}
        .history-wrap.full-view{flex:1;max-height:none;border-top:none;border-radius:var(--radius-lg)}
        .kqxs-actions{display:flex;justify-content:flex-end;gap:10px;margin-bottom:12px}
        .kqxs-layout-toolbar{display:flex;justify-content:flex-start;gap:8px;margin-bottom:12px;flex-wrap:wrap}
        .kqxs-layout-toolbar button{padding:8px 14px;font-size:13px}
        .kqxs-layout-toolbar .danger-btn{background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%)}
        .kqxs-layout-toolbar .danger-btn:hover{background:linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)}
        .history-boards.drag-active{outline:2px dashed var(--primary);outline-offset:4px}
        .history-boards .history-draw.selected{outline:2px solid var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,0.15)}

        .kqxs-grid{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:8px;
            margin-top:20px;
        }
        .kqxs-grid .number{
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding:16px;
            font-size:36px;
            font-weight:800;
            text-align:center;
            border-radius:var(--radius-lg);
            box-shadow:var(--shadow);
            transition:var(--transition);
        }
        .kqxs-grid .number:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg);
        }

        .prob-item{
            display:flex;
            justify-content:space-between;
            padding:14px 18px;
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            margin-bottom:8px;
            border-radius:var(--radius);
            font-weight:600;
            box-shadow:var(--shadow-sm);
            transition:var(--transition);
        }
        .prob-item:hover{
            transform:translateX(4px);
            box-shadow:var(--shadow);
        }
        .prob-num{
            font-size:22px;
            background:linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            font-weight:800;
        }

        .province-card{
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding:24px;
            border-radius:var(--radius-xl);
            margin-bottom:20px;
            box-shadow:var(--shadow-lg);
            transition:var(--transition);
            border:1px solid rgba(255,255,255,0.8);
        }
        .province-card:hover{
            transform:translateY(-4px);
            box-shadow:var(--shadow-xl);
        }
        .province-card h3{
            margin-bottom:12px;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            font-weight:700;
        }

        .scan-btn,.danger-btn,.primary-btn{
            padding:10px 18px;
            border:none;
            border-radius:var(--radius);
            background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color:#fff;
            cursor:pointer;
            font-weight:600;
            font-size:14px;
            transition:var(--transition);
            box-shadow:var(--shadow);
        }
        .scan-btn:hover,.primary-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg),0 4px 12px rgba(99,102,241,0.4);
        }
        .danger-btn{
            background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .danger-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg),0 4px 12px rgba(239,68,68,0.4);
        }
        .top-box{font-size:13px;margin-bottom:10px;color:var(--text);font-weight:500}
        .top-note{font-size:13px;background:linear-gradient(135deg, var(--primary), var(--secondary));-webkit-background-clip:text;background-clip:text;color:transparent;margin-top:8px;font-weight:600}
        .analysis-boards{display:grid;grid-template-columns:1fr;gap:16px}
        .analysis-card{
            border:none;
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:var(--radius-xl);
            box-shadow:var(--shadow-lg);
            overflow:hidden;
        }
        .analysis-card-wide{overflow:auto}
        .analysis-title{
            background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            text-align:center;
            font-weight:800;
            font-size:22px;
            padding:16px 12px;
            color:#92400e;
        }
        .analysis-station{
            text-align:center;
            font-weight:900;
            font-size:32px;
            background:linear-gradient(135deg, #1e3a8a, #1e40af);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            padding:12px 10px;
            background:#fff;
            border-bottom:none;
            letter-spacing:0.5px;
        }
        .analysis-table{width:100%;border-collapse:collapse;font-size:24px;border-radius:var(--radius-lg);overflow:hidden}
        .analysis-table th,.analysis-table td{
            border:none;
            text-align:center;
            padding:12px;
            background:#fff;
        }
        .analysis-table th{
            font-weight:800;
            background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color:var(--text);
        }
        .analysis-number{font-weight:900;background:linear-gradient(135deg, #f59e0b, #ef4444);-webkit-background-clip:text;background-clip:text;color:transparent}
        .analysis-columns-table{min-width:720px;font-size:22px}
        .analysis-rank{font-weight:700;color:var(--text);white-space:nowrap}
        .analysis-count{font-size:17px;color:var(--text-secondary);font-weight:600}
        .analysis-smart-grid{
            display:grid;
            grid-template-columns:repeat(3,minmax(0,1fr));
            gap:16px;
        }
        .analysis-subtitle{
            font-size:15px;
            font-weight:700;
            color:var(--text);
            margin:12px 0 8px;
        }
        .analysis-chip-list{
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            padding:0 10px 12px;
        }
        .analysis-chip{
            border-radius:999px;
            border:none;
            background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding:8px 14px;
            font-size:15px;
            font-weight:600;
            color:var(--text);
            box-shadow:var(--shadow-sm);
            transition:var(--transition);
        }
        .analysis-chip:hover{
            transform:scale(1.05);
            box-shadow:var(--shadow);
        }
        .analysis-chip strong{
            background:linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            margin-right:4px;
        }
        .analysis-mini-table{
            width:100%;
            border-collapse:separate;
            border-spacing:0;
            font-size:15px;
            margin-top:6px;
            border-radius:var(--radius);
            overflow:hidden;
        }
        .analysis-mini-table th,.analysis-mini-table td{
            border:none;
            padding:10px 12px;
            text-align:left;
            background:#fff;
        }
        .analysis-mini-table th{
            background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            font-size:14px;
            color:#92400e;
            font-weight:700;
        }
        .analysis-mini-table td:nth-child(1){
            width:34%;
            font-weight:700;
            background:linear-gradient(135deg, #1e3a8a, #1e40af);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        .analysis-mini-table td:nth-child(n+2){
            font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
            font-weight:700;
            background:linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        @media (max-width: 1200px){.analysis-smart-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
        @media (max-width: 980px){.analysis-smart-grid{grid-template-columns:1fr}}
        .history-boards{display:flex;flex-direction:column;gap:12px}
        .history-draw{
            border:none;
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:var(--radius-xl);
            overflow:hidden;
            box-shadow:var(--shadow-lg);
        }
        .history-draw table.layout-editable th{
            cursor:move;
            transition:var(--transition);
        }
        .history-draw table.layout-editable th:hover{
            background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        .history-draw table.layout-editable th.dragging{
            opacity:0.6;
            background:linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
        }
        .history-draw-title{
            background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            font-weight:800;
            font-size:20px;
            text-align:center;
            padding:12px;
            color:#92400e;
        }
        .result-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow)}
        .result-table th,.result-table td{
            border:none;
            text-align:center;
            padding:10px;
            background:#fff;
            vertical-align:middle;
        }
        .result-table th{font-size:36px;background:linear-gradient(135deg, #1e3a8a, #1e40af);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800}
        .result-prize{width:80px;font-size:36px;font-weight:700;color:#374151}
        .result-values{font-size:52px;font-weight:900;line-height:1.1;background:linear-gradient(135deg, #1e293b, #334155);-webkit-background-clip:text;background-clip:text;color:transparent}
        .result-values.db,.result-values.g7{background:linear-gradient(135deg, #f59e0b, #ef4444);-webkit-background-clip:text;background-clip:text;color:transparent}
        .copy-raw{
            margin:0;
            white-space:pre-wrap;
            word-break:break-word;
            font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
            line-height:1.6;
            background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding:16px;
            border-radius:var(--radius);
        }
        .ticket-card{
            border:none;
            border-radius:var(--radius-lg);
            padding:14px;
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow:var(--shadow);
        }
        .ticket-head{
            font-weight:700;
            margin-bottom:8px;
            color:var(--text);
            font-size:15px;
        }
        .ticket-meta{
            font-size:13px;
            margin-bottom:8px;
            color:var(--text-secondary);
        }
        .ticket-tools{display:flex;justify-content:flex-end;margin-bottom:8px}
        .print-ticket-btn{
            padding:8px 14px;
            border:none;
            border-radius:var(--radius);
            background:linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color:#fff;
            font-size:13px;
            font-weight:700;
            cursor:pointer;
            transition:var(--transition);
            box-shadow:var(--shadow);
        }
        .print-ticket-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg),0 4px 12px rgba(245,158,11,0.4);
        }
        .ticket-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:var(--radius);overflow:hidden}
        .ticket-table th,.ticket-table td{border:none;padding:10px 12px;text-align:left;background:#fff}
        .ticket-table th{background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);font-weight:700}
        .modal-overlay{
            position:fixed;
            inset:0;
            background:rgba(15,23,42,0.6);
            backdrop-filter:blur(8px);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:999;
            animation:fadeIn 0.2s ease;
        }
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .modal-overlay.show{display:flex;animation:slideUp 0.3s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .modal-box{
            width:min(760px,92vw);
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:var(--radius-xl);
            box-shadow:var(--shadow-xl);
            padding:24px;
            animation:scaleIn 0.3s ease;
        }
        @keyframes scaleIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        .modal-title{font-weight:700;margin-bottom:16px;font-size:20px;background:linear-gradient(135deg, var(--text), var(--primary));-webkit-background-clip:text;background-clip:text;color:transparent}
        .modal-box textarea{
            width:100%;
            height:240px;
            border:2px solid var(--border);
            border-radius:var(--radius-lg);
            padding:14px;
            resize:vertical;
            font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size:14px;
            transition:var(--transition);
            background:rgba(255,255,255,0.8);
        }
        .modal-box textarea:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 4px rgba(99,102,241,0.15);
        }
        .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
        .manual-scan-toolbar{display:flex;gap:8px;margin-bottom:12px}
        .manual-scan-toolbar button{padding:8px 14px;font-size:13px}
        .lens-result-meta{
            margin-bottom:10px;
            font-size:13px;
            color:var(--text-secondary);
            white-space:pre-wrap;
        }
        .lens-editor-toolbar{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:12px;
            padding:12px;
            background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius:var(--radius);
        }
        .lens-editor-toolbar span{
            font-size:13px;
            font-weight:600;
            min-width:45px;
            text-align:center;
        }
        .lens-editor-toolbar .ghost-btn{padding:8px 12px;font-size:13px}
        .lens-editor-toolbar.active{background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)}
        #lensResultInput.lens-fullscreen{height:70vh;font-size:17px}
        #lensResultInput.lens-edit-mode{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;line-height:1.6}
        .lotoai-modal{width:min(980px,96vw);max-height:94vh;overflow:auto}
        .lotoai-toolbar{
            display:grid;
            grid-template-columns:160px minmax(240px,1fr) auto auto auto auto;
            gap:10px;
            margin-bottom:14px;
            align-items:center;
        }
        .lotoai-toolbar select,.lotoai-toolbar input{
            border:2px solid var(--border);
            border-radius:var(--radius);
            padding:10px 12px;
            font-size:13px;
            transition:var(--transition);
            background:rgba(255,255,255,0.8);
        }
        .lotoai-toolbar select:focus,.lotoai-toolbar input:focus{
            outline:none;
            border-color:var(--primary);
        }
        .lotoai-btn{
            padding:10px 16px;
            border:none;
            border-radius:var(--radius);
            background:linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color:#fff;
            cursor:pointer;
            font-size:13px;
            font-weight:600;
            white-space:nowrap;
            transition:var(--transition);
            box-shadow:var(--shadow);
        }
        .lotoai-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg),0 4px 12px rgba(13,148,136,0.4);
        }
        .lotoai-log{
            border:none;
            border-radius:var(--radius-xl);
            min-height:300px;
            max-height:50vh;
            overflow:auto;
            padding:16px;
            background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            display:flex;
            flex-direction:column;
            gap:12px;
            box-shadow:inset var(--shadow);
        }
        .lotoai-msg{
            border-radius:var(--radius-xl);
            padding:14px 18px;
            white-space:pre-wrap;
            line-height:1.5;
            font-size:14px;
            box-shadow:var(--shadow-sm);
        }
        .lotoai-msg.user{
            background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color:#fff;
            align-self:flex-end;
            max-width:85%;
        }
        .lotoai-msg.assistant{
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color:var(--text);
            align-self:flex-start;
            max-width:95%;
            border:1px solid var(--border);
        }
        .lotoai-meta{
            margin-top:10px;
            font-size:13px;
            color:var(--text-secondary);
            font-weight:500;
        }
        .gemini-float-btn{
            position:fixed;
            bottom:24px;
            right:24px;
            width:64px;
            height:64px;
            border-radius:50%;
            background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
            background-size:200% 200%;
            animation:gradientShift 3s ease infinite;
            border:none;
            color:#fff;
            font-size:28px;
            cursor:pointer;
            box-shadow:0 8px 32px rgba(99,102,241,0.5);
            z-index:9998;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:var(--transition);
        }
        @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .gemini-float-btn:hover{
            transform:scale(1.15) rotate(5deg);
            box-shadow:0 12px 40px rgba(99,102,241,0.6);
        }
        .gemini-float-panel{
            position:fixed;
            bottom:100px;
            right:24px;
            width:380px;
            max-height:520px;
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:var(--radius-xl);
            box-shadow:var(--shadow-xl),0 0 0 1px rgba(255,255,255,0.3);
            z-index:9999;
            display:none;
            flex-direction:column;
            overflow:hidden;
            animation:slideUp 0.3s ease;
        }
        .gemini-float-panel.show{display:flex}
        .gemini-float-header{
            padding:16px 20px;
            background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color:#fff;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .gemini-float-header span{font-weight:700;font-size:15px}
        .gemini-float-close{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:0;line-height:1;opacity:0.9;transition:var(--transition)}
        .gemini-float-close:hover{opacity:1;transform:scale(1.1)}
        .gemini-float-body{
            flex:1;
            overflow-y:auto;
            padding:16px;
            background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            display:flex;
            flex-direction:column;
            gap:12px;
            min-height:240px;
            max-height:340px;
        }
        .gemini-float-input-wrap{
            padding:14px;
            border-top:1px solid var(--border);
            display:flex;
            gap:10px;
            background:rgba(255,255,255,0.8);
        }
        .gemini-float-input{
            flex:1;
            padding:12px 14px;
            border:2px solid var(--border);
            border-radius:var(--radius-xl);
            font-size:14px;
            resize:none;
            height:48px;
            font-family:inherit;
            transition:var(--transition);
            background:rgba(255,255,255,0.9);
        }
        .gemini-float-input:focus{
            outline:none;
            border-color:var(--primary);
        }
        .gemini-float-send{
            padding:12px 20px;
            background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color:#fff;
            border:none;
            border-radius:var(--radius);
            cursor:pointer;
            font-weight:600;
            font-size:14px;
            transition:var(--transition);
            box-shadow:var(--shadow);
        }
        .gemini-float-send:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg);
        }
        .gemini-float-send:disabled{background:#94a3b8;cursor:not-allowed;transform:none;box-shadow:none}
        .gemini-float-meta{
            padding:10px 14px;
            font-size:12px;
            color:var(--text-muted);
            background:rgba(248,250,252,0.8);
            border-top:1px solid var(--border);
            font-weight:500;
        }
        @media (max-width: 980px){.lotoai-toolbar{grid-template-columns:1fr}}
        .ghost-btn{
            padding:10px 16px;
            border:2px solid var(--border);
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:var(--radius);
            cursor:pointer;
            font-size:var(--ui-font-size);
            font-weight:600;
            color:var(--text);
            transition:var(--transition);
        }
        .ghost-btn:hover{
            border-color:var(--primary);
            color:var(--primary);
            transform:translateY(-1px);
        }
        .settings-modal{
            width:min(900px,96vw);
            max-height:92vh;
            overflow-y:auto;
            overflow-x:hidden;
            scroll-behavior:smooth;
            scrollbar-width:thin;
            overscroll-behavior:contain;
        }
        .settings-modal::-webkit-scrollbar{width:8px}
        .settings-modal::-webkit-scrollbar-track{background:transparent;border-radius:4px}
        .settings-modal::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#cbd5e1,#94a3b8);border-radius:4px}
        .settings-modal::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#94a3b8,#64748b)}
        .dark .settings-modal::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#475569,#334155)}
        .dark .settings-modal::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#64748b,#475569)}
        
        .settings-panel textarea#customCssInput{
            background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color:#e2e8f0;
            font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
            font-size:13px;
            line-height:1.5;
            border-color:#334155;
        }
        .settings-panel textarea#customCssInput:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 4px rgba(99,102,241,0.15);
        }
        .settings-panel pre{
            background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color:#e2e8f0;
            font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
            font-size:12px;
            overflow-x:auto;
            border-radius:var(--radius);
            padding:14px;
        }
        .settings-tabs{
            display:flex;
            gap:10px;
            margin-bottom:16px;
            border-bottom:1px solid var(--border);
            padding-bottom:12px;
        }
        .settings-tab{
            padding:12px 20px;
            border:2px solid var(--border);
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:var(--radius);
            cursor:pointer;
            font-weight:600;
            font-size:var(--ui-font-size);
            transition:var(--transition);
        }
        .settings-tab:hover{border-color:var(--primary);color:var(--primary)}
        .settings-tab.active{
            background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color:#fff;
            border-color:transparent;
            box-shadow:var(--shadow);
        }
        .settings-panel{display:none}
        .settings-panel.show{display:block}
        .settings-grid{
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:16px;
        }
        .settings-field{
            display:flex;
            flex-direction:column;
            gap:8px;
        }
        .settings-field label{
            font-size:13px;
            color:var(--text-secondary);
            font-weight:600;
        }
        .settings-field input,.settings-field select{
            border:2px solid var(--border);
            border-radius:var(--radius);
            padding:12px 14px;
            font-size:var(--ui-font-size);
            transition:var(--transition);
            background:rgba(255,255,255,0.8);
        }
        .settings-field input:focus,.settings-field select:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 4px rgba(99,102,241,0.15);
        }
        .settings-inline{display:flex;align-items:center;gap:10px;font-size:var(--ui-font-size);font-weight:500}
        .settings-inline input[type="checkbox"]{width:20px;height:20px;accent-color:var(--primary)}
        .ai-tools-list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
        .ai-tool-row{
            border:none;
            border-radius:var(--radius-xl);
            padding:14px;
            display:grid;
            grid-template-columns:auto minmax(140px,200px) minmax(200px,1fr) auto;
            gap:12px;
            align-items:center;
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow:var(--shadow);
            transition:var(--transition);
        }
        .ai-tool-row:hover{box-shadow:var(--shadow-lg);transform:translateX(4px)}
        .ai-tool-row input[type="text"]{
            width:100%;
            border:2px solid var(--border);
            border-radius:var(--radius);
            padding:10px 12px;
            font-size:var(--ui-font-size);
            transition:var(--transition);
            background:rgba(255,255,255,0.8);
        }
        .ai-tool-row input[type="text"]:focus{
            outline:none;
            border-color:var(--primary);
        }
        .ai-open-btn{
            padding:10px 16px;
            border:none;
            border-radius:var(--radius);
            background:linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color:#fff;
            cursor:pointer;
            font-size:var(--ui-font-size);
            font-weight:600;
            transition:var(--transition);
            box-shadow:var(--shadow);
        }
        .ai-open-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg),0 4px 12px rgba(13,148,136,0.4);
        }
        .settings-actions-grid{
            display:grid;
            grid-template-columns:repeat(3,minmax(0,1fr));
            gap:10px;
        }
        .settings-action-btn{
            padding:12px 16px;
            border:none;
            border-radius:var(--radius);
            background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color:#fff;
            cursor:pointer;
            font-size:var(--ui-font-size);
            font-weight:600;
            white-space:nowrap;
            transition:var(--transition);
            box-shadow:var(--shadow);
        }
        .settings-action-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow-lg),0 4px 12px rgba(99,102,241,0.4);
        }
        .adb-status-line{margin-top:10px;font-size:13px;color:var(--text-secondary);font-weight:500}
        .adb-terminal{
            margin-top:12px;
            border:none;
            border-radius:var(--radius-lg);
            padding:14px;
            background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            box-shadow:inset var(--shadow);
        }
        .adb-terminal-row{display:flex;gap:10px;align-items:center}
        .adb-terminal-input{
            flex:1;
            border:2px solid var(--border);
            border-radius:var(--radius);
            padding:12px 14px;
            font-size:13px;
            font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
            transition:var(--transition);
            background:rgba(255,255,255,0.8);
        }
        .adb-terminal-input:focus{
            outline:none;
            border-color:var(--primary);
        }
        .adb-terminal-output{
            margin-top:10px;
            border:none;
            border-radius:var(--radius-lg);
            background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color:#e2e8f0;
            padding:16px;
            min-height:140px;
            max-height:280px;
            overflow:auto;
            font-size:13px;
            font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
            white-space:pre-wrap;
            word-break:break-word;
            box-shadow:inset var(--shadow-lg);
        }
        .brand-script.hidden{display:none}
        @media (max-width: 900px){.settings-grid{grid-template-columns:1fr}.ai-tool-row{grid-template-columns:1fr}.settings-actions-grid{grid-template-columns:repeat(2,1fr)}}
        .history-wrap table{width:100%;border-collapse:separate;border-spacing:0;border-radius:var(--radius);overflow:hidden;font-size:13px}
        .history-wrap th,.history-wrap td{border:none;padding:10px 12px;vertical-align:top;background:#fff}
        .history-wrap th{background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);text-align:left;font-weight:700}

        /* DARK MODE */
        .dark{--surface:#0f172a;--surface-elevated:#1e293b;--border:#334155;--text:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--glass:rgba(15,23,42,0.8)}
        .dark body{background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%);color:white}
        .dark .navbar{background:var(--glass);border-color:rgba(255,255,255,0.1)}
        .dark .navbar button{background:linear-gradient(135deg, #1e293b 0%, #334155 100%);color:white;border:1px solid rgba(255,255,255,0.1)}
        .dark .navbar button:hover{background:linear-gradient(135deg, #334155 0%, #475569 100%)}
        .dark .navbar input{background:rgba(30,41,59,0.9);color:white;border-color:transparent}
        .dark .navbar input:focus{border-color:var(--primary);background:#1e293b}
        .dark .zoom-wrap span{color:var(--text-secondary)}
        .dark .zoom-input{background:rgba(30,41,59,0.9);color:#e5e7eb;border-color:transparent}
        .dark .zoom-input:focus{border-color:var(--primary)}
        .dark .scan-btn{background:linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);color:#0f172a}
        .dark .scan-btn:hover{background:linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)}
        .dark .danger-btn{background:linear-gradient(135deg, #f87171 0%, #ef4444 100%);color:#0f172a}
        .dark .danger-btn:hover{background:linear-gradient(135deg, #fca5a5 0%, #f87171 100%)}
        .dark .top-box{color:#e5e7eb}
        .dark .top-note{background:linear-gradient(135deg, #60a5fa, #3b82f6);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .analysis-card,.dark .history-draw{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:none}
        .dark .analysis-title,.dark .history-draw-title{background:linear-gradient(135deg, #422006 0%, #451a03 100%);color:#fcd34d}
        .dark .analysis-station{background:linear-gradient(135deg, #1e3a8a, #1e40af);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .analysis-table th,.dark .analysis-table td,.dark .result-table th,.dark .result-table td{background:#1e293b;color:#e5e7eb;border:none}
        .dark .analysis-subtitle{color:#e5e7eb}
        .dark .analysis-chip{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:1px solid #334155;color:#e5e7eb}
        .dark .analysis-mini-table th,.dark .analysis-mini-table td{background:#1e293b;color:#e5e7eb;border:none}
        .dark .analysis-mini-table th{background:linear-gradient(135deg, #422006 0%, #451a03 100%);color:#fcd34d}
        .dark .analysis-mini-table td:nth-child(1){background:linear-gradient(135deg, #1e3a8a, #1e40af);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .analysis-mini-table td:nth-child(n+2){background:linear-gradient(135deg, #fb923c, #f97316);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .analysis-number,.dark .result-values.db,.dark .result-values.g7{background:linear-gradient(135deg, #fb923c, #f97316);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .analysis-rank{color:#cbd5e1}
        .dark .analysis-count{color:#a5b4fc}
        .dark .result-table th{background:linear-gradient(135deg, #1e3a8a, #1e40af);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .result-prize{color:#d4d4d4}
        .dark .result-values{background:linear-gradient(135deg, #e5e7eb, #cbd5e1);-webkit-background-clip:text;background-clip:text;color:transparent}
        .dark .ticket-card{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:none}
        .dark .ticket-head{color:#e5e7eb}
        .dark .ticket-meta{color:#60a5fa}
        .dark .ticket-table th,.dark .ticket-table td{background:#1e293b;border-color:#334155}
        .dark .ticket-table th{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%)}
        .dark .print-ticket-btn{background:linear-gradient(135deg, #fb923c, #f97316);color:#0f172a}
        .dark .print-ticket-btn:hover{background:linear-gradient(135deg, #fdba74, #fb923c)}
        .dark .modal-box{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);color:#e5e7eb}
        .dark .modal-box textarea{background:rgba(15,23,42,0.9);color:#e5e7eb;border-color:#334155}
        .dark .lens-result-meta{color:#cbd5e1}
        .dark .lotoai-log{background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%);border:none}
        .dark .lotoai-toolbar select,.dark .lotoai-toolbar input{background:rgba(15,23,42,0.9);color:#e5e7eb;border-color:#334155}
        .dark .lotoai-btn{background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)}
        .dark .lotoai-btn:hover{background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)}
        .dark .lotoai-msg.user{background:linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);color:#dbeafe}
        .dark .lotoai-msg.assistant{background:linear-gradient(135deg, #1e293b 0%, #334155 100%);color:#e5e7eb;border:1px solid #334155}
        .dark .lotoai-meta{color:#cbd5e1}
        .dark .gemini-float-panel{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%)}
        .dark .gemini-float-body{background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%)}
        .dark .gemini-float-input{background:rgba(15,23,42,0.9);color:#e5e7eb;border-color:#334155}
        .dark .gemini-float-meta{background:rgba(15,23,42,0.9);color:#94a3b8;border-color:#334155}
        .dark .ghost-btn{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);color:#e5e7eb;border-color:#334155}
        .dark .ghost-btn:hover{border-color:var(--primary);color:var(--primary)}
        .dark .settings-tab{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);color:#e5e7eb;border-color:#334155}
        .dark .settings-tab.active{background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);color:#fff;border-color:transparent}
        .dark .settings-tabs{border-color:#334155}
        .dark .settings-field label{color:#cbd5e1}
        .dark .settings-field input,.dark .settings-field select{background:rgba(15,23,42,0.9);color:#e5e7eb;border-color:#334155}
        .dark .ai-tool-row{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:none}
        .dark .ai-tool-row input[type="text"]{background:rgba(15,23,42,0.9);color:#e5e7eb;border-color:#334155}
        .dark .settings-action-btn{background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)}
        .dark .settings-action-btn:hover{background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)}
        .dark .adb-status-line{color:#cbd5e1}
        .dark .adb-terminal{background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%)}
        .dark .adb-terminal-input{background:rgba(15,23,42,0.9);color:#e5e7eb;border-color:#334155}
        .dark .adb-terminal-output{background:linear-gradient(135deg, #020617 0%, #0f172a 100%);color:#dbeafe;border:none}

        .print-region-overlay{position:absolute;inset:0;z-index:9999;cursor:crosshair;background:rgba(15,23,42,0.1);user-select:none}
        .print-region-tip{position:absolute;top:12px;left:12px;background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);color:#fff;padding:10px 14px;border-radius:var(--radius);font-size:13px;font-weight:600;box-shadow:var(--shadow)}
        .print-region-box{position:absolute;border:2px dashed var(--primary);background:rgba(99,102,241,0.2);display:none;border-radius:var(--radius)}
        .terminal-modal{width:min(900px,96vw);height:min(80vh,600px);max-height:90vh}
        .terminal-output{
            background:linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color:#c9d1d9;
            font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace;
            font-size:14px;
            line-height:1.5;
            padding:16px;
            border-radius:var(--radius-lg);
            min-height:320px;
            max-height:50vh;
            overflow:auto;
            white-space:pre-wrap;
            word-break:break-all;
            box-shadow:inset var(--shadow-lg);
        }
        .terminal-output .cmd{color:#58a6ff;font-weight:600}
        .terminal-output .result{color:#c9d1d9}
        .terminal-output .error{color:#f85149;font-weight:600}
        .terminal-output .success{color:#3fb950;font-weight:600}
        .terminal-input-row{display:flex;gap:10px;margin-top:10px}
        .terminal-input-row input{
            flex:1;
            background:linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color:#c9d1d9;
            border:2px solid #30363d;
            border-radius:var(--radius);
            padding:14px 16px;
            font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;
            font-size:14px;
            transition:var(--transition);
        }
        .terminal-input-row input:focus{
            outline:none;
            border-color:#58a6ff;
            box-shadow:0 0 0 4px rgba(88,166,255,0.15);
        }
        .terminal-toolbar{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
        .terminal-toolbar button{padding:10px 14px;font-size:13px}
        .dark .terminal-output{background:linear-gradient(135deg, #0d1117 0%, #161b22 100%);color:#c9d1d9}
        .dark .terminal-input-row input{background:linear-gradient(135deg, #0d1117 0%, #161b22 100%);color:#c9d1d9;border-color:#30363d}

        /* === NEW THEMES === */
        :root{
            --theme-primary:var(--primary);
            --theme-secondary:var(--secondary);
            --theme-gradient:linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        /* Ocean Theme */
        [data-theme="ocean"]{
            --primary:#0ea5e9;
            --primary-hover:#0284c7;
            --secondary:#06b6d4;
            --primary:#0ea5e9;
            --background:linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            --surface:#ffffff;
        }
        [data-theme="ocean"] body{background:linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)}
        [data-theme="ocean"] .navbar{background:rgba(224,242,254,0.85)}
        [data-theme="ocean"] .brand-script{background:linear-gradient(135deg, #0369a1,#0891b2,#0ea5e9,#0284c7,#0369a1);-webkit-background-clip:text;background-clip:text}
        
        /* Sunset Theme */
        [data-theme="sunset"]{
            --primary:#f97316;
            --primary-hover:#ea580c;
            --secondary:#ef4444;
        }
        [data-theme="sunset"] body{background:linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%)}
        [data-theme="sunset"] .navbar{background:rgba(255,237,213,0.85)}
        [data-theme="sunset"] .brand-script{background:linear-gradient(135deg, #c2410c,#ea580c,#f97316,#fb923c,#c2410c);-webkit-background-clip:text;background-clip:text}
        [data-theme="sunset"] .scan-btn,[data-theme="sunset"] .settings-action-btn,[data-theme="sunset"] .lotoai-btn{background:linear-gradient(135deg, #f97316, #ef4444)}
        
        /* Forest Theme */
        [data-theme="forest"]{
            --primary:#22c55e;
            --primary-hover:#16a34a;
            --secondary:#14b8a6;
        }
        [data-theme="forest"] body{background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)}
        [data-theme="forest"] .navbar{background:rgba(240,253,244,0.85)}
        [data-theme="forest"] .brand-script{background:linear-gradient(135deg, #15803d,#22c55e,#14b8a6,#10b981,#15803d);-webkit-background-clip:text;background-clip:text}
        [data-theme="forest"] .scan-btn,[data-theme="forest"] .settings-action-btn,[data-theme="forest"] .lotoai-btn{background:linear-gradient(135deg, #22c55e, #14b8a6)}
        
        /* Luxury Theme */
        [data-theme="luxury"]{
            --primary:#d4af37;
            --primary-hover:#b8962e;
            --secondary:#8b4513;
        }
        [data-theme="luxury"] body{background:linear-gradient(135deg, #fef9e7 0%, #fdebd0 100%)}
        [data-theme="luxury"] .navbar{background:rgba(254,249,231,0.9);border-bottom:2px solid #d4af37}
        [data-theme="luxury"] .brand-script{background:linear-gradient(135deg, #d4af37,#f4c430,#d4af37,#b8962e,#d4af37);-webkit-background-clip:text;background-clip:text;font-size:34px}
        [data-theme="luxury"] .scan-btn,[data-theme="luxury"] .settings-action-btn,[data-theme="luxury"] .lotoai-btn{background:linear-gradient(135deg, #d4af37, #b8860b);color:#1a1a1a}
        [data-theme="luxury"] .gemini-float-btn{background:linear-gradient(135deg, #d4af37,#f4c430,#d4af37);box-shadow:0 8px 32px rgba(212,175,55,0.5)}

        /* Theme Selector */
        .theme-selector{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
        .theme-option{
            padding:10px 18px;
            border-radius:var(--radius);
            border:2px solid var(--border);
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            cursor:pointer;
            font-weight:600;
            font-size:13px;
            transition:var(--transition);
            display:flex;
            align-items:center;
            gap:8px;
        }
        .theme-option:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
        .theme-option.active{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.2)}
        .theme-option .theme-dot{width:16px;height:16px;border-radius:50%}
        .theme-option[data-value="default"] .theme-dot{background:linear-gradient(135deg, #6366f1, #8b5cf6)}
        .theme-option[data-value="ocean"] .theme-dot{background:linear-gradient(135deg, #0ea5e9, #06b6d4)}
        .theme-option[data-value="sunset"] .theme-dot{background:linear-gradient(135deg, #f97316, #ef4444)}
        .theme-option[data-value="forest"] .theme-dot{background:linear-gradient(135deg, #22c55e, #14b8a6)}
        .theme-option[data-value="luxury"] .theme-dot{background:linear-gradient(135deg, #d4af37, #f4c430)}
        .dark .theme-option{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);color:#e5e7eb;border-color:#334155}

        /* === PREMIUM NAVBAR === */
        .navbar.premium{
            padding:12px 20px;
            background:linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.85));
            backdrop-filter:blur(24px);
            -webkit-backdrop-filter:blur(24px);
            border-bottom:1px solid rgba(255,255,255,0.5);
            box-shadow:0 4px 20px rgba(0,0,0,0.08);
        }
        .dark .navbar.premium{
            background:linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.85));
            border-bottom:1px solid rgba(255,255,255,0.1);
        }
        .navbar.premium button{
            padding:10px 18px;
            background:linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border:1px solid #e2e8f0;
            box-shadow:0 2px 8px rgba(0,0,0,0.06);
        }
        .dark .navbar.premium button{
            background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color:#334155;
        }
        .navbar.premium button:hover{
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(99,102,241,0.25);
            border-color:var(--primary);
        }
        .navbar.premium button.nav-icon{
            width:38px;
            height:38px;
            padding:0;
            display:inline-flex !important;
            align-items:center;
            justify-content:center;
            border-radius:50%;
            font-size:18px;
            background:linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border:1px solid #e2e8f0;
            cursor:pointer;
            pointer-events:auto !important;
        }
        .navbar.premium button.nav-icon:hover{
            transform:scale(1.1);
            box-shadow:0 4px 12px rgba(99,102,241,0.3);
        }
        .navbar.premium button.nav-icon:active{
            transform:scale(0.95);
        }
        .dark .navbar.premium button.nav-icon{
            background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color:#334155;
        }
        .navbar.premium button.nav-icon svg{width:18px;height:18px}
        .navbar.premium .brand-script{
            font-size:30px;
            margin:0 16px;
            text-shadow:0 2px 8px rgba(99,102,241,0.3);
        }
        .navbar.premium input{
            padding:12px 20px;
            border-radius:24px;
            background:rgba(255,255,255,0.9);
            border:2px solid #e2e8f0;
        }
        .dark .navbar.premium input{
            background:rgba(30,41,59,0.9);
            border-color:#334155;
        }
        .navbar.premium .url-group{
            flex:1;
            display:flex;
            align-items:center;
            gap:8px;
            max-width:500px;
        }
        .navbar.premium .url-group input{flex:1}
        .navbar.premium .url-go-btn{
            width:44px;
            height:44px;
            border-radius:50%;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            color:white;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 12px rgba(99,102,241,0.4);
        }
        .navbar.premium .url-go-btn:hover{
            transform:scale(1.1);
            box-shadow:0 6px 16px rgba(99,102,241,0.5);
        }

        /* === NEW KQXS GRID === */
        .kqxs-grid{
            display:grid;
            gap:3px;
            background:linear-gradient(135deg, #d1d5db, #9ca3af);
            border-radius:18px;
            overflow:hidden;
            box-shadow:var(--shadow-lg);
            margin:16px 0;
        }
        
        .kqxs-header,
        .kqxs-row{
            display:grid;
            grid-template-columns:90px 1fr 1fr 1fr;
        }
        
        .kqxs-header div{
            background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight:800;
            font-size:18px;
            padding:14px 12px;
            text-align:center;
            background:linear-gradient(135deg, #1e3a8a, #1e40af);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        .dark .kqxs-header div{background:linear-gradient(135deg, #1e3a8a, #1e40af);-webkit-background-clip:text;background-clip:text;color:transparent}
        
        .kqxs-row div{
            background:#ffffff;
            padding:14px 10px;
            text-align:center;
        }
        .dark .kqxs-row div{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%)}
        
        .kqxs-row .prize{
            font-weight:700;
            font-size:18px;
            background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .dark .kqxs-row .prize{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important}
        
        .kqxs-row .number{
            font-size:32px;
            font-weight:800;
            background:linear-gradient(135deg, #1e293b, #334155);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        .dark .kqxs-row .number{background:linear-gradient(135deg, #f1f5f9, #e2e8f0);-webkit-background-clip:text;background-clip:text;color:transparent}
        
        .kqxs-row .number.highlight,
        .kqxs-row .number.highlight{
            background:linear-gradient(135deg, #ea580c, #dc2626);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        
        .kqxs-row.jackpot{
            background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        .dark .kqxs-row.jackpot{background:linear-gradient(135deg, #422006 0%, #451a03 100%)}
        
        .kqxs-row.jackpot .prize{
            background:linear-gradient(135deg, #b45309, #92400e) !important;
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        
        .kqxs-row.jackpot .number.jackpot-num{
            font-size:38px;
            background:linear-gradient(135deg, #dc2626, #ea580c);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            text-shadow:0 2px 8px rgba(234,88,12,0.3);
        }

        /* === LOTO STATS === */
        .loto-stats{
            display:grid;
            grid-template-columns:repeat(5,1fr);
            gap:12px;
            margin-top:24px;
        }
        
        .loto-item{
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius:16px;
            padding:18px 12px;
            text-align:center;
            box-shadow:0 4px 16px rgba(0,0,0,0.08);
            transition:var(--transition);
            border:1px solid rgba(255,255,255,0.8);
        }
        .dark .loto-item{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border-color:#334155}
        .loto-item:hover{
            transform:translateY(-4px) scale(1.02);
            box-shadow:0 8px 24px rgba(99,102,241,0.2);
        }
        
        .loto-number{
            font-size:36px;
            font-weight:900;
            background:linear-gradient(135deg, #ea580c, #dc2626);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }
        
        .loto-count{
            font-size:14px;
            color:var(--text-secondary);
            font-weight:600;
            margin-top:4px;
        }
        .dark .loto-count{color:#94a3b8}

        /* === AI ANALYSIS BLOCK === */
        .ai-analysis{
            margin-top:28px;
            padding:24px;
            border-radius:20px;
            background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
            background-size:200% 200%;
            animation:gradientShift 4s ease infinite;
            color:white;
            box-shadow:0 8px 32px rgba(99,102,241,0.4);
        }
        @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        
        .ai-analysis h3{
            margin:0 0 16px;
            font-size:20px;
            font-weight:700;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .ai-analysis h3::before{
            content:"🤖";
            font-size:24px;
        }
        
        .ai-analysis-content{
            background:rgba(255,255,255,0.15);
            backdrop-filter:blur(10px);
            border-radius:14px;
            padding:16px;
            font-size:14px;
            line-height:1.7;
        }
        
        .ai-analysis .stat-row{
            display:flex;
            justify-content:space-between;
            padding:8px 0;
            border-bottom:1px solid rgba(255,255,255,0.2);
        }
        .ai-analysis .stat-row:last-child{border:none}
        .ai-analysis .stat-label{font-weight:600;opacity:0.9}
        .ai-analysis .stat-value{font-weight:700;font-size:16px}

        /* === PREMIUM GEMINI BUTTON === */
        .gemini-float-btn.premium{
            width:72px;
            height:72px;
            border-radius:50%;
            background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899, #f43f5e);
            background-size:300% 300%;
            animation:premiumGlow 3s ease infinite, gradientShift 4s ease infinite;
            border:3px solid rgba(255,255,255,0.3);
            box-shadow:0 8px 32px rgba(99,102,241,0.5),0 0 60px rgba(139,92,246,0.3),inset 0 2px 4px rgba(255,255,255,0.3);
            z-index:9998;
        }
        @keyframes premiumGlow{
            0%,100%{box-shadow:0 8px 32px rgba(99,102,241,0.5),0 0 60px rgba(139,92,246,0.3),inset 0 2px 4px rgba(255,255,255,0.3)}
            50%{box-shadow:0 12px 48px rgba(139,92,246,0.6),0 0 80px rgba(236,72,153,0.4),inset 0 2px 4px rgba(255,255,255,0.4)}
        }
        .gemini-float-btn.premium:hover{
            transform:scale(1.2) rotate(8deg);
        }
        .gemini-float-btn.premium::after{
            content:"✨";
            position:absolute;
            top:-4px;
            right:-4px;
            font-size:16px;
            animation:sparkle 1.5s ease infinite;
        }
        @keyframes sparkle{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.2)}}

        /* === LUXURIOUS MODAL === */
        .modal-overlay.luxurious{
            background:rgba(0,0,0,0.7);
            backdrop-filter:blur(12px);
        }
        .modal-box.luxurious{
            width:min(800px,94vw);
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            border-radius:24px;
            box-shadow:0 25px 50px -12px rgba(0,0,0,0.25),0 0 0 1px rgba(255,255,255,0.1);
            padding:28px;
            position:relative;
            overflow:hidden;
        }
        .modal-box.luxurious::before{
            content:"";
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:4px;
            background:linear-gradient(90deg, var(--primary), var(--secondary), #ec4899, var(--primary));
            background-size:300% 100%;
            animation:shimmer 3s linear infinite;
        }
        @keyframes shimmer{0%{background-position:0% 0%}100%{background-position:300% 0%}}
        .modal-box.luxurious .modal-title{
            font-size:24px;
            font-weight:800;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            margin-bottom:20px;
            padding-bottom:12px;
            border-bottom:2px solid #f1f5f9;
        }
        .dark .modal-box.luxurious{background:linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%)}
        .dark .modal-box.luxurious::before{height:4px}
        .dark .modal-box.luxurious .modal-title{border-color:#334155}
        .modal-box.luxurious textarea{
            border-radius:16px;
            padding:16px;
            font-size:15px;
            background:rgba(255,255,255,0.8);
            border:2px solid #e2e8f0;
        }
        .dark .modal-box.luxurious textarea{background:rgba(15,23,42,0.8);border-color:#334155}
        .modal-box.luxurious textarea:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 4px rgba(99,102,241,0.15),0 4px 12px rgba(99,102,241,0.1);
        }
        .modal-box.luxurious .modal-actions{
            margin-top:20px;
            padding-top:16px;
            border-top:1px solid #f1f5f9;
        }
        .dark .modal-box.luxurious .modal-actions{border-color:#334155}

        /* Province Card Premium */
        .province-card.premium{
            background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding:24px;
            border-radius:20px;
            margin-bottom:20px;
            box-shadow:0 8px 30px rgba(0,0,0,0.1);
            border:1px solid rgba(255,255,255,0.8);
            position:relative;
            overflow:hidden;
        }
        .province-card.premium::before{
            content:"";
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:4px;
            background:linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .dark .province-card.premium{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%)}
        .province-card.premium h3{
            margin-bottom:12px;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
            font-weight:700;
        }

        /* Quick Action Buttons */
        .quick-actions{
            display:flex;
            gap:10px;
            margin-bottom:16px;
            flex-wrap:wrap;
        }
        .quick-action-btn{
            padding:12px 20px;
            border-radius:14px;
            border:none;
            background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            font-weight:600;
            font-size:13px;
            cursor:pointer;
            transition:var(--transition);
            display:flex;
            align-items:center;
            gap:8px;
            box-shadow:var(--shadow-sm);
        }
        .quick-action-btn:hover{
            transform:translateY(-2px);
            box-shadow:var(--shadow);
        }
        .quick-action-btn.primary{
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            color:white;
        }
        .quick-action-btn.success{background:linear-gradient(135deg, #10b981, #059669);color:white}
        .quick-action-btn.danger{background:linear-gradient(135deg, #ef4444, #dc2626);color:white}
        .dark .quick-action-btn{background:linear-gradient(135deg, #1e293b, #0f172a);color:#e5e7eb;border:1px solid #334155}

        /* Responsive */
        @media (max-width:768px){
            .kqxs-header,.kqxs-row{grid-template-columns:60px 1fr 1fr}
            .kqxs-header div:nth-child(4),.kqxs-row>div:nth-child(4){display:none}
            .loto-stats{grid-template-columns:repeat(3,1fr)}
            .navbar.premium{flex-wrap:wrap;gap:8px}
            .navbar.premium .brand-script{font-size:24px;margin:0 8px}
        }
    </style>
</head>

<body>

<div class="navbar premium">
    <button class="nav-icon" onclick="openSettingsModal()" title="Cài đặt">⚙️</button>
    <button class="nav-icon" onclick="scanKqxsFromWeb()" title="KQXS">📊</button>
    <button class="nav-icon" onclick="startLensOcr()" title="Lens+OCR">🔍</button>
    <button class="nav-icon" onclick="startLensAi()" title="Lens+AI">🤖</button>
    <button class="nav-icon" onclick="openAssistant()" title="Assistant">💬</button>
    <button class="nav-icon" onclick="switchAiTool()" title="AI Switch">🔄</button>
    <div class="brand-script">Ngọc Phát Tài 1990</div>
    <div class="url-group">
        <input id="url" placeholder="Nhập URL hoặc lệnh: mở AgentGPT, quay lại, KQXS...">
        <button class="url-go-btn" onclick="openUrl()" title="Đi">➤</button>
    </div>
    <div class="zoom-wrap">
        <span>🔍</span>
        <input id="zoomPercent" class="zoom-input" type="number" min="30" max="300" value="100" onchange="applyZoom()">
        <button onclick="zoomStep(-10)">−</button>
        <button onclick="zoomStep(10)">+</button>
    </div>
</div>

<div class="main">
    <div id="browserArea">
        <webview id="mainWebview" src="about:blank" allowpopups></webview>
    </div>
</div>
<div class="history-wrap hidden" id="historyWrap">
    <div class="kqxs-layout-toolbar">
        <button class="scan-btn" onclick="enableKqxsCustomLayout()">Tùy chỉnh bố cục</button>
        <button class="scan-btn" onclick="aiRecognizeLayout()">AI nhận diện</button>
        <button class="ghost-btn" onclick="copyKqxsSelection()">Sao chép</button>
        <button class="ghost-btn" onclick="pasteKqxsData()">Dán dữ liệu</button>
        <button class="ghost-btn" onclick="addKqxsFromImage()">Thêm từ ảnh</button>
        <button class="ghost-btn" onclick="deleteKqxsSelection()">Xoá chọn</button>
        <button class="danger-btn" onclick="clearKQXSHistory()">Xoá lịch sử</button>
    </div>
    <div class="top-box">
        <div id="analysisBoards" class="analysis-boards"></div>
        <div id="topStatsNote" class="top-note"></div>
    </div>
    <div id="historyBoards" class="history-boards"></div>
</div>
<div class="modal-overlay luxurious" id="manualScanModal">
    <div class="modal-box luxurious">
        <div class="modal-title">Dán bảng KQXS để quét vé dò</div>
        <div class="manual-scan-toolbar">
            <button class="ghost-btn" onclick="pasteFromClipboard()">Dán (Ctrl+V)</button>
            <button class="ghost-btn" onclick="pasteImageFromClipboard()">Dán ảnh</button>
            <button class="ghost-btn" onclick="openFileForKqxs()">Mở file</button>
            <button class="ghost-btn" onclick="clearManualScanInput()">Xoá</button>
        </div>
        <textarea id="manualScanInput" placeholder="Ví dụ: ĐB: 12345&#10;Giải 1: 54321&#10;Giải 2: 11223 44556...&#10;&#10;Hoặc dán ảnh (Ctrl+V) để nhận diện text."></textarea>
        <div class="modal-actions">
            <button class="ghost-btn" onclick="closeManualScanModal()">Huỷ</button>
            <button class="scan-btn" onclick="saveManualScanText()">Lưu vào lịch sử</button>
        </div>
    </div>
</div>
<div class="modal-overlay luxurious" id="lensResultModal">
    <div class="modal-box luxurious">
        <div class="modal-title" id="lensResultTitle">Kết quả Lens</div>
        <div class="lens-result-meta" id="lensResultMeta"></div>
        <div class="lens-editor-toolbar">
            <button class="ghost-btn" onclick="adjustLensFontSize(-2)">A-</button>
            <span id="lensFontSizeLabel">16px</span>
            <button class="ghost-btn" onclick="adjustLensFontSize(2)">A+</button>
            <button class="ghost-btn" onclick="toggleLensFullView()">Toàn màn hình</button>
            <button class="ghost-btn" onclick="toggleLensEditMode()">Chế độ edit</button>
        </div>
        <textarea id="lensResultInput" placeholder="Nội dung từ vùng quét lens..."></textarea>
        <div class="modal-actions">
            <button class="ghost-btn" onclick="copyLensResultText()">Chép</button>
            <button class="scan-btn" onclick="saveLensResultToHistory()">Lưu vào lịch sử KQXS</button>
            <button class="scan-btn" onclick="analyzeLensWithAI()">Phân tích AI</button>
            <button class="ghost-btn" onclick="closeLensResultModal()">Đóng</button>
        </div>
    </div>
</div>
<div class="modal-overlay luxurious" id="settingsModal" onclick="if(event.target === this) closeSettingsModal()">
    <div class="modal-box luxurious settings-modal" id="settingsModalBox" onwheel="handleSettingsWheel(event)" tabindex="0">
        <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:inherit;z-index:10;padding-bottom:12px;border-bottom:1px solid var(--border);">
            <span>⚙️ Cài đặt ứng dụng</span>
            <div style="display:flex;gap:6px;">
                <button class="nav-icon" style="width:32px;height:32px;padding:0;border-radius:8px;font-size:14px;" onclick="scrollSettingsUp()" title="Lên đầu (PageUp)">⬆</button>
                <button class="nav-icon" style="width:32px;height:32px;padding:0;border-radius:8px;font-size:14px;" onclick="scrollSettingsDown()" title="Xuống cuối (PageDown)">⬇</button>
                <button class="nav-icon" style="width:32px;height:32px;padding:0;border-radius:8px;font-size:14px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;" onclick="closeSettingsModal()" title="Đóng (Esc)">✕</button>
            </div>
        </div>
        <div class="settings-tabs">
            <button id="settingsTabUi" class="settings-tab active" onclick="switchSettingsTab('ui')">Giao diện</button>
            <button id="settingsTabAi" class="settings-tab" onclick="switchSettingsTab('ai')">Công cụ AI</button>
            <button id="settingsTabCustom" class="settings-tab" onclick="switchSettingsTab('custom')">🎨 Custom CSS</button>
        </div>

        <div id="settingsPanelUi" class="settings-panel show">
            <div class="settings-field" style="grid-column:1 / -1;">
                <label>Chọn Giao Diện</label>
                <div class="theme-selector">
                    <div class="theme-option active" data-value="default" onclick="selectTheme('default')">
                        <span class="theme-dot"></span>
                        <span>Mặc định</span>
                    </div>
                    <div class="theme-option" data-value="ocean" onclick="selectTheme('ocean')">
                        <span class="theme-dot"></span>
                        <span>🌊 Ocean</span>
                    </div>
                    <div class="theme-option" data-value="sunset" onclick="selectTheme('sunset')">
                        <span class="theme-dot"></span>
                        <span>🌅 Sunset</span>
                    </div>
                    <div class="theme-option" data-value="forest" onclick="selectTheme('forest')">
                        <span class="theme-dot"></span>
                        <span>🌲 Forest</span>
                    </div>
                    <div class="theme-option" data-value="luxury" onclick="selectTheme('luxury')">
                        <span class="theme-dot"></span>
                        <span>👑 Luxury</span>
                    </div>
                </div>
            </div>
            <div class="settings-grid">
                <div class="settings-field">
                    <label for="settingTheme">Chế độ sáng/tối</label>
                    <select id="settingTheme" onchange="toggleDarkMode(this.value === 'dark')">
                        <option value="light">Sáng</option>
                        <option value="dark">Tối</option>
                    </select>
                </div>
                <div class="settings-field">
                    <label for="settingUiFontSize">Cỡ chữ thanh điều khiển (px)</label>
                    <input id="settingUiFontSize" type="number" min="11" max="20" step="1">
                </div>
                <div class="settings-field">
                    <label for="settingDefaultZoom">Mức zoom mặc định của trang web (%)</label>
                    <input id="settingDefaultZoom" type="number" min="30" max="300" step="5">
                </div>
                <div class="settings-inline">
                    <input id="settingShowBrand" type="checkbox">
                    <label for="settingShowBrand">Hiện chữ thương hiệu trên thanh công cụ</label>
                </div>
                <div class="settings-field" style="grid-column:1 / -1;">
                    <label>🎨 Tác vụ nhanh & Terminal</label>
                    <div class="settings-actions-grid">
                        <button class="settings-action-btn" onclick="openTerminalModal()">⬛ Terminal</button>
                        <button class="settings-action-btn" onclick="toggleDarkMode(false)">☀️ Sáng</button>
                        <button class="settings-action-btn" onclick="toggleDarkMode(true)">🌙 Tối</button>
                        <button class="settings-action-btn" onclick="printLatestTicket()">🖨️ IN vé</button>
                        <button class="settings-action-btn" onclick="translateCurrentWeb()">🌐 Dịch web</button>
                        <button class="settings-action-btn" onclick="restoreOriginalWebLanguage()">📝 Gốc</button>
                        <button id="settingMicBtn" class="settings-action-btn" onclick="toggleVoiceCommand()">🎤 Mic</button>
                        <button class="settings-action-btn success" onclick="checkForAppUpdate()">🔄 Cập nhật</button>
                    </div>
                </div>
                <div class="settings-field" style="grid-column:1 / -1;">
                    <label>Điều khiển Android (ADB)</label>
                    <div class="settings-actions-grid">
                        <button class="settings-action-btn" onclick="installAndroidPlatformTools()">Cài Platform Tools</button>
                        <button class="settings-action-btn" onclick="linkAdbFromFile()">Chọn file ADB</button>
                        <button class="settings-action-btn" onclick="installScrcpyFiles()">Cài scrcpy</button>
                        <button class="settings-action-btn" onclick="refreshAdbToolsStatus(true)">Kiểm tra ADB</button>
                        <button class="settings-action-btn" onclick="runAdbDevicesQuick()">ADB Devices</button>
                        <button class="settings-action-btn" onclick="startAdbMirrorAuto()">Phản chiếu ADB</button>
                        <button class="settings-action-btn" onclick="connectAdbWifi()">ADB WiFi</button>
                        <button class="settings-action-btn" onclick="startAdbMirrorUsb()">Mirror USB</button>
                        <button class="settings-action-btn" onclick="startAdbMirrorWifi()">Mirror WiFi</button>
                        <button class="settings-action-btn" onclick="openAndroidCameraUsb()">Cam USB</button>
                        <button class="settings-action-btn" onclick="openAndroidCameraWifi()">Cam WiFi</button>
                        <button class="settings-action-btn" onclick="captureAndroidPhotoUsb()">Chụp USB</button>
                        <button class="settings-action-btn" onclick="captureAndroidPhotoWifi()">Chụp WiFi</button>
                    </div>
                    <div id="adbStatusLine" class="adb-status-line">ADB: chưa kiểm tra</div>
                    <div class="adb-status-line" style="margin-top:4px;">Remote Android từ app</div>
                    <div class="settings-actions-grid">
                        <button class="settings-action-btn" onclick="remoteAndroidBack()">Android Back</button>
                        <button class="settings-action-btn" onclick="remoteAndroidHome()">Android Home</button>
                        <button class="settings-action-btn" onclick="remoteAndroidRecent()">Android Recent</button>
                        <button class="settings-action-btn" onclick="remoteAndroidVolumeUp()">Vol +</button>
                        <button class="settings-action-btn" onclick="remoteAndroidVolumeDown()">Vol -</button>
                        <button class="settings-action-btn" onclick="remoteAndroidPower()">Power</button>
                    </div>
                    <div class="adb-terminal-row" style="margin-top:8px;">
                        <input id="adbRemoteTextInput" class="adb-terminal-input" type="text" placeholder="Gửi text vào Android qua ADB...">
                        <button class="settings-action-btn" onclick="remoteAndroidSendText()">Gửi text</button>
                    </div>
                    <div class="adb-status-line" style="margin-top:10px;">Remote ngược lại (Android điều khiển app)</div>
                    <div class="settings-actions-grid">
                        <button class="settings-action-btn" onclick="startAppRemoteControl()">Bật Remote App</button>
                        <button class="settings-action-btn" onclick="enableAppRemoteReverseUsb()">ADB Reverse USB</button>
                        <button class="settings-action-btn" onclick="enableAppRemoteReverseWifi()">ADB Reverse WiFi</button>
                        <button class="settings-action-btn" onclick="stopAppRemoteControl()">Tắt Remote App</button>
                    </div>
                    <div id="appRemoteStatusLine" class="adb-status-line">Remote App: chưa bật</div>
                    <div class="adb-terminal">
                        <div class="adb-terminal-row">
                            <input
                              id="adbTerminalInput"
                              class="adb-terminal-input"
                              type="text"
                              placeholder='Lệnh ADB, ví dụ: devices -l hoặc shell getprop ro.product.model'
                            >
                            <button class="settings-action-btn" onclick="runAdbTerminalCommand()">Chạy</button>
                            <button class="settings-action-btn" onclick="clearAdbTerminalOutput()">Xoá log</button>
                        </div>
                        <div id="adbTerminalOutput" class="adb-terminal-output">ADB terminal sẵn sàng.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settingsPanelAi" class="settings-panel">
            <div class="settings-grid">
                <div class="settings-field">
                    <label for="settingStartupTool">Công cụ AI mở khi khởi động app</label>
                    <select id="settingStartupTool"></select>
                </div>
                <div class="settings-field">
                    <label for="settingOpenAiModel">Model AI mặc định nội bộ</label>
                    <input id="settingOpenAiModel" type="text" placeholder="gpt-4o-mini">
                </div>
                <div class="settings-field">
                    <label for="settingOllamaHost">Ollama Host</label>
                    <input id="settingOllamaHost" type="text" placeholder="http://127.0.0.1:11434">
                </div>
                <div class="settings-field">
                    <label for="settingOllamaModel">Model Ollama mặc định</label>
                    <input id="settingOllamaModel" type="text" placeholder="llama2:7b">
                </div>
                <div class="settings-field" style="grid-column:1 / -1;">
                    <label>Ollama Tools</label>
                    <div class="settings-actions-grid">
                        <button class="settings-action-btn" onclick="testOllamaConnection()">Kiểm tra Ollama</button>
                        <button class="settings-action-btn" onclick="refreshLotoAiModels(true)">Refresh Models</button>
                        <button class="settings-action-btn" onclick="pullAllOllamaPresets()">Pull All Presets</button>
                        <button class="settings-action-btn" onclick="openOllamaWebUI()">Mở Web UI</button>
                    </div>
                </div>
                <div class="settings-field" style="grid-column:1 / -1;">
                    <label for="settingOpenAiApiKey">OPENAI API Key (lưu cục bộ trên máy này)</label>
                    <input id="settingOpenAiApiKey" type="password" placeholder="sk-...">
                </div>
                <div class="settings-field" style="grid-column:1 / -1;">
                    <label for="settingGeminiApiKey">Google Gemini API Key (điều khiển app không giới hạn)</label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input id="settingGeminiApiKey" type="password" placeholder="AIza..." style="flex:1;">
                        <button class="scan-btn" onclick="testAndSaveGeminiKey()">🔑 Lưu & Test</button>
                    </div>
                    <div id="geminiKeyStatus" style="font-size:12px;margin-top:6px;color:var(--text-secondary);"></div>
                </div>
            </div>
            <div class="ai-tools-list" id="aiToolsList"></div>
        </div>

        <div id="settingsPanelCustom" class="settings-panel">
            <div class="settings-field" style="grid-column:1 / -1;">
                <label>🎨 Chỉnh sửa CSS tuỳ chỉnh</label>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">
                    Thêm CSS để tuỳ chỉnh giao diện app. Ví dụ: .navbar { background: red; }
                </div>
                <textarea id="customCssInput" style="width:100%;height:200px;border:2px solid var(--border);border-radius:var(--radius);padding:12px;font-family:ui-monospace,monospace;font-size:13px;resize:vertical;" placeholder="/* Tuỳ chỉnh CSS */&#10;.navbar {&#10;  background: linear-gradient(135deg, #ff6b6b, #4ecdc4);&#10;}"></textarea>
            </div>
            <div class="settings-actions-grid" style="margin-top:12px;">
                <button class="settings-action-btn" onclick="applyCustomCss()">✅ Áp dụng</button>
                <button class="settings-action-btn" onclick="previewCustomCss()">👁️ Xem trước</button>
                <button class="settings-action-btn" onclick="resetCustomCss()">🔄 Khôi phục</button>
                <button class="settings-action-btn danger" onclick="clearCustomCss()">🗑️ Xoá CSS</button>
            </div>
            <div id="customCssStatus" style="margin-top:10px;font-size:13px;"></div>
            
            <div class="settings-field" style="grid-column:1 / -1;margin-top:20px;">
                <label>📝 CSS Variables có sẵn</label>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">
                    Sử dụng các biến này để dễ dàng tuỳ chỉnh:
                </div>
                <pre style="background:var(--surface-elevated);padding:12px;border-radius:var(--radius);font-size:12px;overflow-x:auto;"><code>--primary: #6366f1;
--secondary: #8b5cf6;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
--surface: #ffffff;
--text: #1e293b;
--text-secondary: #64748b;
--border: #e2e8f0;
--radius: 10px;
--shadow: 0 4px 6px rgba(0,0,0,0.1);</code></pre>
            </div>
            
            <div class="settings-field" style="grid-column:1 / -1;margin-top:20px;">
                <label>⚡ Snippets có sẵn</label>
                <div class="settings-actions-grid">
                    <button class="ghost-btn" style="font-size:11px;padding:6px 10px;" onclick="insertSnippet('neon')">💡 Neon Mode</button>
                    <button class="ghost-btn" style="font-size:11px;padding:6px 10px;" onclick="insertSnippet('glass')">🔮 Glass</button>
                    <button class="ghost-btn" style="font-size:11px;padding:6px 10px;" onclick="insertSnippet('minimal')">⬜ Minimal</button>
                    <button class="ghost-btn" style="font-size:11px;padding:6px 10px;" onclick="insertSnippet('colorful')">🌈 Colorful</button>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="ghost-btn" onclick="closeSettingsModal()">Huỷ</button>
            <button class="scan-btn" onclick="saveSettings()">Lưu cài đặt</button>
        </div>
    </div>
</div>
<div class="modal-overlay luxurious" id="lotoAiModal">
    <div class="modal-box luxurious lotoai-modal">
        <div class="modal-title">💬 Assistant Offline - Miễn phí</div>
        <div class="lotoai-toolbar">
            <select id="lotoAiProvider">
                <option value="ollama">Ollama Local (Free)</option>
                <option value="openai">OpenAI Cloud</option>
            </select>
            <select id="lotoAiModel"></select>
            <button class="lotoai-btn" onclick="testOllamaConnection()">Check</button>
            <button class="lotoai-btn" onclick="refreshLotoAiModels()">Refresh</button>
            <button class="lotoai-btn" onclick="pullAllLotoAiPresets()">Pull All</button>
            <button class="lotoai-btn" onclick="pullSelectedLotoAiModel()">Pull</button>
        </div>
        <div id="lotoAiLog" class="lotoai-log"></div>
        <div class="lotoai-meta" id="lotoAiMeta">Assistant dùng AI local (Ollama) - Miễn phí, offline. Nhập lệnh: mở web, quay lại, lens ocr, adb devices...</div>
        <textarea id="lotoAiInput" placeholder="Nhập câu hỏi hoặc lệnh điều khiển app..."></textarea>
        <div class="modal-actions">
            <button class="ghost-btn" onclick="clearLotoAiChat()">Xoá chat</button>
            <button class="scan-btn" id="lotoAiSendBtn" onclick="sendLotoAiMessage()">Gửi</button>
            <button class="ghost-btn" onclick="closeLotoAiModal()">Đóng</button>
        </div>
    </div>
</div>
<div class="modal-overlay luxurious" id="geminiAiModal">
    <div class="modal-box luxurious lotoai-modal">
        <div class="modal-title">✨ Gemini AI - Điều khiển App</div>
        <div class="lotoai-toolbar">
            <select id="geminiModel">
                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
            <button class="lotoai-btn" onclick="testGeminiConnection()">Check API</button>
        </div>
        <div id="geminiAiLog" class="lotoai-log"></div>
        <div class="lotoai-meta" id="geminiAiMeta">Gemini AI có quyền điều khiển đầy đủ app: mở web, chụp lens, adb, mirror, chụp ảnh, v.v.</div>
        <textarea id="geminiAiInput" placeholder="Nhập lệnh hoặc câu hỏi cho Gemini AI..."></textarea>
        <div class="modal-actions">
            <button class="ghost-btn" onclick="clearGeminiAiChat()">Xoá chat</button>
            <button class="scan-btn" id="geminiAiSendBtn" onclick="sendGeminiAiMessage()">Gửi Gemini</button>
            <button class="ghost-btn" onclick="closeGeminiAiModal()">Đóng</button>
        </div>
    </div>
</div>
<button class="gemini-float-btn premium" id="geminiFloatBtn" onclick="toggleGeminiFloatPanel()" title="Gemini AI">🤖</button>
<div class="gemini-float-panel" id="geminiFloatPanel">
    <div class="gemini-float-header">
        <span>Gemini AI</span>
        <button class="gemini-float-close" onclick="toggleGeminiFloatPanel()">×</button>
    </div>
    <div class="gemini-float-body" id="geminiFloatLog"></div>
    <div class="gemini-float-input-wrap">
        <textarea class="gemini-float-input" id="geminiFloatInput" placeholder="Nhập lệnh..." rows="1"></textarea>
        <button class="gemini-float-send" id="geminiFloatSendBtn" onclick="sendGeminiFloatMessage()">Gửi</button>
    </div>
    <div class="gemini-float-meta" id="geminiFloatMeta">AI điều khiển: web, adb, mirror, lens, camera...</div>
</div>
<div class="modal-overlay luxurious" id="terminalModal">
        <div class="modal-box luxurious terminal-modal">
        <div class="modal-title">⬛ Terminal</div>
        <div class="terminal-toolbar">
            <button class="ghost-btn" onclick="runTerminalCommand()">Chạy (Enter)</button>
            <button class="ghost-btn" onclick="clearTerminalOutput()">Xoá output</button>
            <button class="ghost-btn" onclick="toggleTerminalFullscreen()">Fullscreen</button>
            <button class="ghost-btn" onclick="killTerminalProcess()">Dừng lệnh</button>
            <button class="ghost-btn" onclick="openTerminalSettings()">Cài đặt</button>
            <button class="ghost-btn" onclick="clearTerminalHistory()">Xoá lịch sử</button>
        </div>
        <div id="terminalOutput" class="terminal-output">
            <span class="success">Terminal sẵn sàng. Nhập lệnh và bấm Enter hoặc Chạy.</span>
        </div>
        <div class="terminal-input-row">
            <input id="terminalInput" placeholder="Nhập lệnh shell..." onkeydown="handleTerminalKeydown(event)">
            <button class="scan-btn" onclick="runTerminalCommand()">Chạy</button>
        </div>
        <div class="modal-actions">
            <button class="ghost-btn" onclick="closeTerminalModal()">Đóng</button>
        </div>
    </div>
</div>

<script>
    const { ipcRenderer } = require("electron")
    const AGENT_GPT_URL = "https://agentgpt.reworkd.ai/"
    const AGENT_GPT_HOST = "agentgpt.reworkd.ai"
    const AUTOMA_APP_URL = "https://app.automa.site/"
    const NO_TRANSLATE_HOST_SUFFIXES = [
      "chatgpt.com",
      "openai.com",
      "auth.openai.com",
      AGENT_GPT_HOST,
      "claude.ai",
      "gemini.google.com"
    ]
    const SETTINGS_STORAGE_KEY = "comet_ultra_settings_v2"
    const DEFAULT_OLLAMA_HOST = "http://127.0.0.1:11434"
    const ADB_DEFAULT_TCP_PORT = 5555
    const OLLAMA_PRESET_MODELS = [
      { id: "llama2_7b", label: "LLaMA-2 7B", model: "llama2:7b", stars: "⭐⭐⭐⭐" },
      { id: "alpaca_7b_q4", label: "Alpaca 7B Q4", model: "alpaca-7b-q4:latest", stars: "⭐⭐" },
      { id: "vicuna_7b_q4", label: "Vicuna 7B Q4", model: "vicuna-7b-q4:latest", stars: "⭐⭐" },
      { id: "gptq_4bit_alias", label: "GPTQ-4bit Alias", model: "llama2-gptq-4bit:latest", stars: "⭐⭐⭐⭐" },
      { id: "mistral_mini", label: "Mistral Mini", model: "mistral:7b-instruct-q4_0", stars: "⭐⭐⭐" },
      { id: "tinytext_nano", label: "TinyText/NanoGPT", model: "tinyllama:latest", stars: "⭐⭐" }
    ]
    const AGENT_GPT_VI_DICTIONARY = {
      "Deploy Agent": "Khởi chạy Agent",
      "New Agent": "Agent mới",
      "Agent Name": "Tên Agent",
      "Name your AI": "Đặt tên AI",
      "Goal": "Mục tiêu",
      "Add Goal": "Thêm mục tiêu",
      "Start": "Bắt đầu",
      "Run": "Chạy",
      "Stop": "Dừng",
      "Delete": "Xóa",
      "Save": "Lưu",
      "Settings": "Cài đặt",
      "Log out": "Đăng xuất",
      "Sign in": "Đăng nhập",
      "Sign up": "Đăng ký",
      "Continue with Google": "Tiếp tục với Google",
      "Create Agent": "Tạo Agent",
      "Task": "Nhiệm vụ",
      "Thinking": "Đang suy nghĩ",
      "Completed": "Hoàn thành",
      "Paused": "Tạm dừng",
      "Error": "Lỗi",
      "Try again": "Thử lại",
      "Welcome back": "Chào mừng quay lại",
      "Dashboard": "Bảng điều khiển",
      "Email": "Email",
      "Password": "Mật khẩu",
      "Continue": "Tiếp tục",
      "Cancel": "Hủy",
      "Loading": "Đang tải",
      "Previous": "Trước",
      "Next": "Tiếp theo",
      "Goals": "Mục tiêu",
      "Result": "Kết quả",
      "Results": "Các kết quả",
      "Prompt": "Yêu cầu",
      "Prompt your AI": "Nhập yêu cầu cho AI"
    }
    const AI_TOOL_DEFAULTS = [
      { id: "agentgpt", name: "AgentGPT", url: AGENT_GPT_URL, enabled: true },
      { id: "chatgpt", name: "ChatGPT", url: "https://chatgpt.com/", enabled: true },
      { id: "openai", name: "OpenAI", url: "https://chatgpt.com/", enabled: true },
      { id: "automa", name: "Automa", url: AUTOMA_APP_URL, enabled: true },
      { id: "lotoai", name: "LotoAI Nội Bộ", url: "internal://lotoai", enabled: true },
      { id: "ollama_llama2_7b", name: "LLaMA-2 7B Local", url: "internal://ollama/llama2:7b", enabled: true },
      { id: "ollama_alpaca_7b", name: "Alpaca 7B Local", url: "internal://ollama/alpaca-7b-q4:latest", enabled: true },
      { id: "ollama_vicuna_7b", name: "Vicuna 7B Local", url: "internal://ollama/vicuna-7b-q4:latest", enabled: true },
      { id: "ollama_gptq_4bit", name: "GPTQ-4bit Local", url: "internal://ollama/llama2-gptq-4bit:latest", enabled: true },
      { id: "ollama_mistral_mini", name: "Mistral Mini Local", url: "internal://ollama/mistral:7b-instruct-q4_0", enabled: true },
      { id: "ollama_tiny", name: "TinyText Local", url: "internal://ollama/tinyllama:latest", enabled: true },
      { id: "gemini", name: "Gemini", url: "https://gemini.google.com/", enabled: false },
      { id: "claude", name: "Claude", url: "https://claude.ai/", enabled: false },
      { id: "flutterflow", name: "FlutterFlow", url: "https://flutterflow.io/", enabled: true },
      { id: "flutter", name: "Flutter", url: "https://flutter.dev/", enabled: true }
    ]
    let latestHistory=[]
    let lensRegionState = null
    let lensResultState = {
      title: "Kết quả Lens",
      meta: "",
      text: ""
    }
    let lensEditorState = {
      fontSize: 16,
      fullscreen: false,
      editMode: false
    }
    let kqxsLayoutState = {
      customLayout: null,
      enableCustomLayout: false
    }
    let voiceRecognition = null
    let isVoiceListening = false
    let activeAiToolId = ""
    let lotoAiState = {
      loading: false,
      messages: [],
      ollamaOnline: false,
      ollamaModels: []
    }
    let geminiAiState = {
      loading: false,
      messages: []
    }
    let adbState = {
      wifiHost: "",
      wifiSerial: "",
      terminalBusy: false,
      appRemotePort: 17321
    }

    let lotoHistoryByProvince = {
      "dongnai": [],
      "cantho": [],
      "soctrang": []
    }

    function saveProvinceResult(province, numbers){

        if(!lotoHistoryByProvince[province]){
            lotoHistoryByProvince[province] = []
        }

        lotoHistoryByProvince[province].push({
            date:new Date().toISOString(),
            numbers
        })
    }

    function analyzeProvince(province){

        const history = lotoHistoryByProvince[province] || []

        const allNumbers = history.flatMap(d=>d.numbers)

        return analyzeWithProbability(allNumbers)
    }

    function analyzeProvinceFull(province){

        const history = lotoHistoryByProvince[province] || []
        const allNumbers = history.flatMap(d=>d.numbers)

        return analyzeWithProbability(allNumbers)
    }

    function renderProvinceDashboard(){

        const container = document.getElementById("historyBoards")
        container.innerHTML = ""

        Object.keys(lotoHistoryByProvince).forEach(province=>{

            const data = analyzeProvince(province).slice(0,5)

            const box = document.createElement("div")
            box.className = "province-card"

            box.innerHTML = `
                <h3>${province.toUpperCase()}</h3>
                ${data.map(x=>`
                    <div class="prob-item">
                        <span>${x.num}</span>
                        <span>${x.probability}%</span>
                        <span>${rankStrength(parseFloat(x.probability))}</span>
                    </div>
                `).join("")}
            `

            container.appendChild(box)
        })
    }

    function generateProvinceSuggestion(province){

        const top = analyzeProvince(province).slice(0,3)

        return top.map(x=>`
            🔥 ${x.num} – ${x.probability}% – ${rankStrength(parseFloat(x.probability))}
        `).join("<br>")
    }

    let appSettings = loadAppSettings()
    document.documentElement.setAttribute("lang", "vi")
    ipcRenderer.on("app:navigate-in-webview", (_event, rawUrl)=>{
      const target = String(rawUrl || "").trim()
      if(!target){
        return
      }
      navigateTo(target, { skipTranslate: true })
    })
    ipcRenderer.on("app:remote-command", async (_event, rawCommand)=>{
      const command = String(rawCommand || "").trim()
      if(!command){
        return
      }
      appendAdbTerminalOutput(`Remote app -> ${command}`)
      if(await executeVietnameseCommand(command)){
        return
      }
      if(await executeAiControlCommand(command, { source: "remote" })){
        return
      }
      navigateTo(normalizeNavigationInput(command))
    })

    function createDefaultSettings(){
      return {
        language: "vi",
        interface: {
          theme: "light",
          colorTheme: "default",
          uiFontSize: 13,
          defaultZoom: 100,
          showBrand: true,
          autoTranslateWeb: false
        },
        ai: {
          internalProvider: "ollama",
          startupToolId: "agentgpt",
          openaiApiKey: "",
          openaiModel: "gpt-4o-mini",
          geminiApiKey: "AIzaSyCdMcPcwE5NxqGpqOQvPQLNtisBMcNjkN8",
          ollamaHost: DEFAULT_OLLAMA_HOST,
          ollamaModel: "llama2:7b",
          tools: AI_TOOL_DEFAULTS.map((tool)=>({ ...tool }))
        }
      }
    }

    function clampNumber(value, min, max, fallback){
      const n = Number(value)
      if(!Number.isFinite(n)){
        return fallback
      }
      return Math.max(min, Math.min(max, n))
    }

    function normalizeToolUrl(url){
      const value = String(url || "").trim()
      if(!value){
        return ""
      }
      if(/^internal:\/\//i.test(value)){
        return value
      }
      if(/^https?:\/\//i.test(value)){
        return value
      }
      return `https://${value}`
    }

    function normalizeSettings(raw){
      const defaults = createDefaultSettings()
      const source = raw && typeof raw === "object" ? raw : {}

      const mergedTools = AI_TOOL_DEFAULTS.map((def)=>{
        const fromSaved = Array.isArray(source?.ai?.tools)
          ? source.ai.tools.find((item)=>item && item.id === def.id)
          : null
        const name = String(fromSaved?.name || def.name).trim() || def.name
        let url = normalizeToolUrl(fromSaved?.url || def.url) || def.url
        if(def.id === "openai" && /platform\.openai\.com/i.test(url)){
          url = "https://chatgpt.com/"
        }
        return {
          id: def.id,
          name: name.slice(0, 40),
          url,
          enabled: typeof fromSaved?.enabled === "boolean" ? fromSaved.enabled : def.enabled
        }
      })

      return {
        language: "vi",
        interface: {
          theme: source?.interface?.theme === "dark" ? "dark" : "light",
          uiFontSize: clampNumber(source?.interface?.uiFontSize, 11, 20, defaults.interface.uiFontSize),
          defaultZoom: clampNumber(source?.interface?.defaultZoom, 30, 300, defaults.interface.defaultZoom),
          showBrand: typeof source?.interface?.showBrand === "boolean"
            ? source.interface.showBrand
            : defaults.interface.showBrand,
          autoTranslateWeb: false
        },
        ai: {
          internalProvider: String(source?.ai?.internalProvider || defaults.ai.internalProvider) === "openai" ? "openai" : "ollama",
          startupToolId: String(source?.ai?.startupToolId || defaults.ai.startupToolId),
          openaiApiKey: String(source?.ai?.openaiApiKey || ""),
          openaiModel: String(source?.ai?.openaiModel || defaults.ai.openaiModel),
          geminiApiKey: String(source?.ai?.geminiApiKey || defaults.ai.geminiApiKey || "AIzaSyCKCsA3vlfOZLOrbYrnzCrD4rYNcwHPFqM"),
          ollamaHost: String(source?.ai?.ollamaHost || defaults.ai.ollamaHost),
          ollamaModel: String(source?.ai?.ollamaModel || defaults.ai.ollamaModel),
          tools: mergedTools
        }
      }
    }

    function loadAppSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_STORAGE_KEY)
        if(!raw){
          return createDefaultSettings()
        }
        return normalizeSettings(JSON.parse(raw))
      }catch(_e){
        return createDefaultSettings()
      }
    }

    function persistAppSettings(){
      appSettings = normalizeSettings(appSettings)
      localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(appSettings))
    }

    async function syncAiRuntimeConfig(){
      try{
        const payload = {
          model: String(appSettings.ai.openaiModel || "gpt-4o-mini"),
          ollamaHost: String(appSettings.ai.ollamaHost || DEFAULT_OLLAMA_HOST)
        }
        if(String(appSettings.ai.openaiApiKey || "").trim()){
          payload.apiKey = String(appSettings.ai.openaiApiKey || "").trim()
        }
        await ipcRenderer.invoke("ai:set-config", payload)
      }catch(_e){
        // Ignore sync failures to avoid blocking UI flows.
      }
    }

    function getAiToolById(toolId){
      return appSettings.ai.tools.find((tool)=>tool.id === toolId) || null
    }

    function getAiToolUrl(tool){
      const directUrl = normalizeToolUrl(tool?.url || "")
      if(!directUrl){
        return ""
      }
      if(/^internal:\/\//i.test(directUrl)){
        return directUrl
      }
      return directUrl
    }

    function getEnabledTools(){
      return appSettings.ai.tools.filter((tool)=>tool.enabled)
    }

    function normalizeVietnameseCommand(text){
      return String(text || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/đ/g, "d")
        .replace(/Đ/g, "d")
        .toLowerCase()
        .replace(/\s+/g, " ")
        .trim()
    }

    function isAgentGPTUrl(url){
      try{
        const parsed = new URL(String(url || ""))
        if(parsed.hostname.includes(AGENT_GPT_HOST)){
          return true
        }
        if(parsed.hostname.includes("translate.google")){
          const target = parsed.searchParams.get("u") || parsed.searchParams.get("url") || ""
          return target.includes(AGENT_GPT_HOST)
        }
        return false
      }catch(_e){
        return false
      }
    }

    function isHistoryPanelVisible(){
      const panel = document.getElementById("historyWrap")
      return !!panel && !panel.classList.contains("hidden")
    }

    function showHistoryPanel(){
      if(!isHistoryPanelVisible()){
        toggleHistoryPanel()
      }
    }

    function showBrowserPanel(){
      if(isHistoryPanelVisible()){
        toggleHistoryPanel()
      }
    }

    function getSelectedLotoAiProvider(){
      const select = document.getElementById("lotoAiProvider")
      const raw = String(select?.value || appSettings.ai.internalProvider || "ollama")
      return raw === "openai" ? "openai" : "ollama"
    }

    function getSelectedLotoAiModel(){
      const select = document.getElementById("lotoAiModel")
      const model = String(select?.value || appSettings.ai.ollamaModel || "llama2:7b").trim()
      return model || "llama2:7b"
    }

    function setLotoAiMeta(text){
      const el = document.getElementById("lotoAiMeta")
      if(el){
        el.textContent = String(text || "")
      }
    }

    function parseInternalOllamaModel(tool){
      const internalUrl = normalizeToolUrl(tool?.url || "")
      const match = /^internal:\/\/ollama\/(.+)$/i.exec(internalUrl)
      if(!match?.[1]){
        return ""
      }
      return decodeURIComponent(match[1]).trim()
    }

    function renderLotoAiModelOptions(extraModels=[]){
      const select = document.getElementById("lotoAiModel")
      if(!select){
        return
      }

      const modelSet = new Set()
      OLLAMA_PRESET_MODELS.forEach((item)=>modelSet.add(item.model))
      ;(extraModels || []).forEach((name)=>modelSet.add(String(name || "").trim()))

      const models = Array.from(modelSet).filter(Boolean)
      select.innerHTML = models.map((name)=>{
        const preset = OLLAMA_PRESET_MODELS.find((item)=>item.model === name)
        const label = preset ? `${preset.label} ${preset.stars} (${name})` : name
        return `<option value="${escapeHtml(name)}">${escapeHtml(label)}</option>`
      }).join("")

      const current = String(appSettings.ai.ollamaModel || "llama2:7b")
      select.value = models.includes(current) ? current : (models[0] || "llama2:7b")
    }

    function findOllamaPresetByModel(model){
      const token = String(model || "").trim()
      return OLLAMA_PRESET_MODELS.find((item)=>item.model === token) || null
    }

    async function refreshLotoAiModels(notify=false){
      const host = String(appSettings.ai.ollamaHost || DEFAULT_OLLAMA_HOST)
      try{
        const res = await ipcRenderer.invoke("ollama:get-status", { host })
        if(!res?.ok){
          lotoAiState.ollamaOnline = false
          lotoAiState.ollamaModels = []
          renderLotoAiModelOptions([])
          const errorMsg = res?.error || ""
          if(host !== DEFAULT_OLLAMA_HOST){
            const useDefault = confirm(`Ollama không kết nối được tại: ${host}\nLỗi: ${errorMsg}\n\nBạn có muốn xóa host này và dùng mặc định (${DEFAULT_OLLAMA_HOST})?`)
            if(useDefault){
              appSettings.ai.ollamaHost = DEFAULT_OLLAMA_HOST
              document.getElementById("settingOllamaHost").value = DEFAULT_OLLAMA_HOST
              persistAppSettings()
              await refreshLotoAiModels(notify)
              return
            }
          }
          setLotoAiMeta(`Ollama offline tại ${host}. ${errorMsg}`.trim())
          if(notify){
            alert(`Ollama chưa sẵn sàng: ${errorMsg}`)
          }
          return
        }
        const installed = Array.isArray(res.models)
          ? res.models.map((m)=>String(m?.name || "").trim()).filter(Boolean)
          : []
        lotoAiState.ollamaOnline = true
        lotoAiState.ollamaModels = installed
        renderLotoAiModelOptions(installed)
        const provider = getSelectedLotoAiProvider()
        setLotoAiMeta(`Ollama online (${installed.length} model). Provider hiện tại: ${provider.toUpperCase()}.`)
        if(notify){
          alert(`Đã cập nhật danh sách model Ollama (${installed.length}).`)
        }
      }catch(e){
        lotoAiState.ollamaOnline = false
        lotoAiState.ollamaModels = []
        renderLotoAiModelOptions([])
        if(host !== DEFAULT_OLLAMA_HOST){
          const useDefault = confirm(`Lỗi kết nối Ollama tại: ${host}\n${e.message}\n\nBạn có muốn xóa host này và dùng mặc định?`)
          if(useDefault){
            appSettings.ai.ollamaHost = DEFAULT_OLLAMA_HOST
            document.getElementById("settingOllamaHost").value = DEFAULT_OLLAMA_HOST
            persistAppSettings()
            await refreshLotoAiModels(notify)
            return
          }
        }
        setLotoAiMeta(`Lỗi kết nối Ollama tại ${host}.`)
        if(notify){
          alert("Không thể kết nối Ollama.")
        }
      }
    }

    async function testOllamaConnection(){
      const host = String(appSettings.ai.ollamaHost || DEFAULT_OLLAMA_HOST)
      setLotoAiMeta(`Đang kiểm tra Ollama tại ${host}...`)
      
      try{
        const res = await ipcRenderer.invoke("ollama:get-status", { host })
        if(res?.ok){
          const modelCount = Array.isArray(res.models) ? res.models.length : 0
          const modelNames = Array.isArray(res.models) 
            ? res.models.slice(0, 5).map(m => m.name).join(", ") 
            : ""
          const moreText = modelCount > 5 ? ` (+${modelCount - 5} khác)` : ""
          
          setLotoAiMeta(`Ollama online! ${modelCount} model: ${modelNames}${moreText}`)
          alert(`Ollama đang chạy!\n\nHost: ${host}\nSố model: ${modelCount}\n\nDanh sách model:\n${modelNames}${moreText}`)
        }else{
          setLotoAiMeta(`Ollama offline: ${res?.error || "không rõ lỗi"}`)
          alert(`Ollama không kết nối được!\n\nLỗi: ${res?.error || "không rõ lỗi"}\n\nHãy đảm bảo Ollama đang chạy và host đúng.`)
        }
      }catch(e){
        setLotoAiMeta(`Lỗi: ${e.message}`)
        alert(`Lỗi kết nối Ollama: ${e.message}`)
      }
    }

    async function pullAllOllamaPresets(){
      const provider = getSelectedLotoAiProvider()
      if(provider !== "ollama"){
        alert("Hãy chọn provider Ollama trước.")
        return
      }
      
      if(!confirm("Bạn có muốn tải tất cả các model preset? Điều này sẽ tải nhiều GB dữ liệu.")){
        return
      }
      
      setLotoAiMeta("Đang pull tất cả model presets...")
      setLotoAiLoading(true)
      
      try{
        const res = await ipcRenderer.invoke("ollama:pull-all-presets", {
          host: appSettings.ai.ollamaHost
        })
        
        if(res?.ok){
          const done = Array.isArray(res.done) ? res.done.length : 0
          const failed = Array.isArray(res.failed) ? res.failed.length : 0
          
          setLotoAiMeta(`Pull hoàn tất! ${done} model, ${failed} lỗi.`)
          alert(`Hoàn tất!\n\nThành công: ${done}\nLỗi: ${failed}`)
          
          await refreshLotoAiModels(false)
        }else{
          setLotoAiMeta(`Pull thất bại: ${res?.error || ""}`)
          alert(`Pull thất bại: ${res?.error || "lỗi không xác định"}`)
        }
      }catch(e){
        setLotoAiMeta(`Lỗi: ${e.message}`)
        alert(`Lỗi: ${e.message}`)
      }finally{
        setLotoAiLoading(false)
      }
    }

    function openOllamaWebUI(){
      const host = String(appSettings.ai.ollamaHost || DEFAULT_OLLAMA_HOST)
      const webUrl = host.replace("11434", "8080") + "/"
      const webview = getActiveWebview()
      if(webview){
        webview.loadURL(webUrl).catch(() => {
          window.open(webUrl, "_blank")
        })
      }else{
        window.open(webUrl, "_blank")
      }
    }

    function processKqxsHtml(html){

        const parser = new DOMParser()
        const doc = parser.parseFromString(html, "text/html")

        const numbers = []

        doc.querySelectorAll("td").forEach(td=>{
            const text = td.textContent.trim()
            if(/^[0-9]{2,6}$/.test(text)){
                numbers.push(text)
            }
        })

        renderKqxsLayout(numbers)
    }

    function renderKqxsLayout(numbers){

        const container = document.getElementById("historyBoards")
        container.innerHTML = ""

        const grid = document.createElement("div")
        grid.className = "kqxs-grid"

        numbers.forEach(n=>{
            const div = document.createElement("div")
            div.className = "number"
            div.textContent = n
            grid.appendChild(div)
        })

        container.appendChild(grid)

        runAiLotoAnalysis(numbers)
    }

    function analyzeWithProbability(numbers){

        const stats = {}

        numbers.forEach(n=>{
            const last2 = n.slice(-2)
            stats[last2] = (stats[last2]||0)+1
        })

        const total = Object.values(stats).reduce((a,b)=>a+b,0)

        const result = Object.entries(stats).map(([num,count])=>{
            const probability = ((count/total)*100).toFixed(2)
            return {num,count,probability}
        })

        return result.sort((a,b)=>b.probability-a.probability)
    }

    function rankStrength(prob){

        if(prob>8) return "🔥 RẤT CAO"
        if(prob>5) return "⚡ CAO"
        if(prob>3) return "📈 TRUNG BÌNH"
        return "❄ THẤP"
    }

    function generateAiSuggestion(){

        const analysis = analyzeMultiDay().slice(0,5)

        return analysis.map(x=>`
            Lô ${x.num} – ${x.probability}% – ${rankStrength(x.probability)}
        `).join("<br>")
    }

    function renderProbabilityAnalysis(numbers){

        const data = analyzeWithProbability(numbers).slice(0,10)

        const box = document.createElement("div")
        box.className = "ai-analysis"

        box.innerHTML = `
            <h3>📈 AI Dự Đoán Xác Suất Lô 2 Số</h3>
            ${data.map(x=>`
                <div class="prob-item">
                    <span class="prob-num">${x.num}</span>
                    <span>${x.count} lần</span>
                    <span>${x.probability}%</span>
                </div>
            `).join("")}
        `

        document.getElementById("historyBoards").appendChild(box)
    }

    function runAiLotoAnalysis(numbers){

        const result = analyzeWithProbability(numbers)

        const analysisBox = document.createElement("div")
        analysisBox.className = "ai-analysis"

        analysisBox.innerHTML = `
            <h3>🔥 Top Lô 2 Số</h3>
            ${result.slice(0,10).map(x=>`<div>${x.num} - ${x.count} lần (${x.probability}%)</div>`).join("")}
        `

        document.getElementById("historyBoards").appendChild(analysisBox)
    }

    async function scanKqxsFromWeb(){
      const webview = document.getElementById("mainWebview")

      const html = await webview.executeJavaScript(`
        document.documentElement.outerHTML
      `)

      processKqxsHtml(html)
    }

    async function pullSelectedLotoAiModel(){
      const provider = getSelectedLotoAiProvider()
      if(provider !== "ollama"){
        alert("Hãy chọn provider Ollama để pull model local.")
        return
      }
      if(lotoAiState.loading){
        return
      }
      const model = getSelectedLotoAiModel()
      if(!model){
        alert("Chưa chọn model để pull.")
        return
      }
      setLotoAiLoading(true)
      setLotoAiMeta(`Đang pull model ${model}...`)
      try{
        const preset = findOllamaPresetByModel(model)
        const res = preset
          ? await ipcRenderer.invoke("ollama:pull-preset", {
              host: appSettings.ai.ollamaHost,
              presetId: preset.id
            })
          : await ipcRenderer.invoke("ollama:pull-model", {
              host: appSettings.ai.ollamaHost,
              model
            })
        if(!res?.ok){
          setLotoAiMeta(`Pull thất bại: ${res?.error || "lỗi không xác định"}`)
          alert(`Pull model thất bại: ${res?.error || "không rõ lỗi"}`)
          return
        }
        await refreshLotoAiModels(false)
        setLotoAiMeta(`Đã pull xong model ${model}.`)
        alert(`Đã pull model ${model}.`)
      }catch(e){
        setLotoAiMeta(`Pull thất bại: ${e?.message || "lỗi không xác định"}`)
        alert("Pull model thất bại.")
      }finally{
        setLotoAiLoading(false)
      }
    }

    async function startSelectedLotoAiModel(){
      const provider = getSelectedLotoAiProvider()
      if(provider !== "ollama"){
        alert("Start model chỉ áp dụng cho Ollama local.")
        return
      }
      if(lotoAiState.loading){
        return
      }
      const model = getSelectedLotoAiModel()
      setLotoAiLoading(true)
      setLotoAiMeta(`Đang khởi chạy model ${model}...`)
      try{
        const res = await ipcRenderer.invoke("ollama:chat", {
          host: appSettings.ai.ollamaHost,
          model,
          prompt: "Xin chào, phản hồi READY.",
          messages: []
        })
        if(!res?.ok){
          setLotoAiMeta(`Khởi chạy thất bại: ${res?.error || "không rõ lỗi"}`)
          alert(`Khởi chạy model thất bại: ${res?.error || "không rõ lỗi"}`)
          return
        }
        appSettings.ai.ollamaModel = model
        appSettings.ai.internalProvider = "ollama"
        persistAppSettings()
        setLotoAiMeta(`Model ${model} đã sẵn sàng (READY).`)
      }catch(_e){
        setLotoAiMeta("Khởi chạy model thất bại.")
      }finally{
        setLotoAiLoading(false)
      }
    }

    async function pullAllLotoAiPresets(){
      const provider = getSelectedLotoAiProvider()
      if(provider !== "ollama"){
        alert("Hãy chọn provider Ollama để pull bộ model local.")
        return
      }
      if(lotoAiState.loading){
        return
      }
      const ok = confirm("Pull toàn bộ preset local (LLaMA2/Alpaca/Vicuna/GPTQ/Tiny/Mistral) có thể tốn nhiều GB. Tiếp tục?")
      if(!ok){
        return
      }
      setLotoAiLoading(true)
      setLotoAiMeta("Đang pull toàn bộ preset local...")
      try{
        const res = await ipcRenderer.invoke("ollama:pull-all-presets", {
          host: appSettings.ai.ollamaHost
        })
        await refreshLotoAiModels(false)
        if(res?.ok){
          setLotoAiMeta(`Đã pull xong tất cả preset local (${res?.done?.length || 0} model).`)
          alert("Đã pull xong tất cả preset local.")
        }else{
          const failCount = Array.isArray(res?.failed) ? res.failed.length : 0
          setLotoAiMeta(`Hoàn tất pull với ${failCount} preset lỗi. Kiểm tra lại log/host Ollama.`)
          alert(`Pull preset hoàn tất nhưng có ${failCount} mục lỗi.`)
        }
      }catch(_e){
        setLotoAiMeta("Pull preset thất bại.")
        alert("Pull preset thất bại.")
      }finally{
        setLotoAiLoading(false)
      }
    }

    function renderLotoAiMessages(){
      const log = document.getElementById("lotoAiLog")
      if(!log){
        return
      }
      if(!Array.isArray(lotoAiState.messages) || !lotoAiState.messages.length){
        log.innerHTML = `<div class="lotoai-msg assistant">LotoAI sẵn sàng. Bạn có thể hỏi: "Top số đài Cần Thơ", "so sánh 3 ngày gần nhất", hoặc nhập lệnh app như "mở KQXS".</div>`
        return
      }
      log.innerHTML = lotoAiState.messages.map((msg)=>{
        const roleCls = msg.role === "user" ? "user" : "assistant"
        return `<div class="lotoai-msg ${roleCls}">${escapeHtml(msg.content || "")}</div>`
      }).join("")
      log.scrollTop = log.scrollHeight
    }

    function setLotoAiLoading(loading){
      lotoAiState.loading = Boolean(loading)
      const sendBtn = document.getElementById("lotoAiSendBtn")
      if(sendBtn){
        sendBtn.disabled = lotoAiState.loading
        sendBtn.textContent = lotoAiState.loading ? "Đang xử lý..." : "Gửi LotoAI"
      }
    }

    function pushLotoAiMessage(role, content){
      const text = String(content || "").trim()
      if(!text){
        return
      }
      lotoAiState.messages.push({ role: role === "assistant" ? "assistant" : "user", content: text })
      if(lotoAiState.messages.length > 30){
        lotoAiState.messages = lotoAiState.messages.slice(-30)
      }
      renderLotoAiMessages()
    }

    function openLotoAiModal(){
      document.getElementById("lotoAiModal").classList.add("show")
      const providerSelect = document.getElementById("lotoAiProvider")
      providerSelect.value = String(appSettings.ai.internalProvider || "ollama")
      providerSelect.onchange = ()=>{
        appSettings.ai.internalProvider = getSelectedLotoAiProvider()
        persistAppSettings()
        const provider = getSelectedLotoAiProvider()
        setLotoAiMeta(provider === "ollama"
          ? `Ollama local tại ${appSettings.ai.ollamaHost || DEFAULT_OLLAMA_HOST}`
          : "Đang dùng OpenAI cloud cho chat LotoAI."
        )
      }
      renderLotoAiModelOptions(lotoAiState.ollamaModels)
      refreshLotoAiModels(false)
      renderLotoAiMessages()
      const input = document.getElementById("lotoAiInput")
      if(input){
        input.focus()
      }
    }

    function closeLotoAiModal(){
      document.getElementById("lotoAiModal").classList.remove("show")
    }

    let terminalState = {
      history: [],
      historyIndex: -1,
      currentProcess: null,
      fullscreen: false
    }

    function openTerminalModal(){
      document.getElementById("terminalModal").classList.add("show")
      document.getElementById("terminalInput").focus()
    }

    function closeTerminalModal(){
      document.getElementById("terminalModal").classList.remove("show")
    }

    function appendTerminalOutput(text, type="result"){
      const output = document.getElementById("terminalOutput")
      const line = document.createElement("div")
      line.className = type
      line.textContent = text
      output.appendChild(line)
      output.scrollTop = output.scrollHeight
    }

    function handleTerminalKeydown(event){
      if(event.key === "Enter"){
        event.preventDefault()
        runTerminalCommand()
      }else if(event.key === "ArrowUp"){
        event.preventDefault()
        navigateTerminalHistory(-1)
      }else if(event.key === "ArrowDown"){
        event.preventDefault()
        navigateTerminalHistory(1)
      }else if(event.key === "c" && event.ctrlKey){
        event.preventDefault()
        killTerminalProcess()
      }else if(event.key === "l" && event.ctrlKey){
        event.preventDefault()
        clearTerminalOutput()
      }
    }

    function navigateTerminalHistory(direction){
      const input = document.getElementById("terminalInput")
      if(terminalState.history.length === 0) return
      
      terminalState.historyIndex += direction
      
      if(terminalState.historyIndex < 0){
        terminalState.historyIndex = 0
      }else if(terminalState.historyIndex >= terminalState.history.length){
        terminalState.historyIndex = terminalState.history.length
        input.value = ""
        return
      }
      
      input.value = terminalState.history[terminalState.historyIndex]
    }

    async function runTerminalCommand(){
      const input = document.getElementById("terminalInput")
      const command = String(input.value || "").trim()
      
      if(!command){
        return
      }
      
      if(terminalState.currentProcess){
        appendTerminalOutput("Đang chạy lệnh khác, vui lòng chờ hoặc bấm Dừng lệnh", "error")
        return
      }
      
      if(!terminalState.history.includes(command)){
        terminalState.history.push(command)
      }
      terminalState.historyIndex = terminalState.history.length
      
      appendTerminalOutput(`$ ${command}`, "cmd")
      input.value = ""
      
      try{
        const res = await ipcRenderer.invoke("terminal:run", { command, timeoutMs: 120000 })
        
        if(res?.output){
          appendTerminalOutput(res.output, "result")
        }
        if(res?.error){
          appendTerminalOutput(`Lỗi: ${res.error}`, "error")
        }
        if(res?.exitCode !== undefined && res.exitCode !== 0){
          appendTerminalOutput(`Exit code: ${res.exitCode}`, "error")
        }else if(res?.exitCode === 0){
          appendTerminalOutput(`✓ Hoàn tất (exit: 0)`, "success")
        }
      }catch(e){
        appendTerminalOutput(`Lỗi: ${e.message}`, "error")
      }
    }

    function clearTerminalOutput(){
      const output = document.getElementById("terminalOutput")
      output.innerHTML = '<span class="success">Terminal đã được làm sạch.</span>'
    }

    function toggleTerminalFullscreen(){
      terminalState.fullscreen = !terminalState.fullscreen
      const modal = document.querySelector(".terminal-modal")
      if(terminalState.fullscreen){
        modal.style.width = "98vw"
        modal.style.height = "95vh"
      }else{
        modal.style.width = ""
        modal.style.height = ""
      }
    }

    async function killTerminalProcess(){
      if(terminalState.currentProcess){
        try{
          await ipcRenderer.invoke("terminal:kill")
          appendTerminalOutput("Đã gửi tín hiệu dừng lệnh.", "result")
        }catch(e){
          appendTerminalOutput(`Lỗi khi dừng: ${e.message}`, "error")
        }
      }else{
        appendTerminalOutput("Không có lệnh đang chạy.", "result")
      }
    }

    function openTerminalSettings(){
      openSettingsModal()
      setTimeout(() => {
        switchSettingsTab("ui")
      }, 100)
    }

    function clearTerminalHistory(){
      if(confirm("Xoá lịch sử lệnh?")){
        terminalState.history = []
        terminalState.historyIndex = -1
        appendTerminalOutput("Đã xoá lịch sử lệnh.", "success")
      }
    }

    function clearLotoAiChat(){
      lotoAiState.messages = []
      renderLotoAiMessages()
    }

    async function sendLotoAiMessage(){
      if(lotoAiState.loading){
        return
      }
      const input = document.getElementById("lotoAiInput")
      const prompt = String(input?.value || "").trim()
      if(!prompt){
        alert("Bạn chưa nhập nội dung cho LotoAI.")
        return
      }

      pushLotoAiMessage("user", prompt)
      input.value = ""
      setLotoAiLoading(true)

      try{
        const commandApplied =
          (await executeVietnameseCommand(prompt)) ||
          (await executeAiControlCommand(prompt, { source: "lotoai" }))

        if(commandApplied){
          pushLotoAiMessage("assistant", "Đã thực thi lệnh điều khiển app theo yêu cầu.")
          setLotoAiLoading(false)
          return
        }

        const provider = getSelectedLotoAiProvider()
        let res = null
        if(provider === "ollama"){
          const model = getSelectedLotoAiModel()
          appSettings.ai.ollamaModel = model
          appSettings.ai.internalProvider = "ollama"
          persistAppSettings()
          setLotoAiMeta(`Đang chat local bằng model ${model}...`)
          res = await ipcRenderer.invoke("ollama:chat", {
            host: appSettings.ai.ollamaHost,
            model,
            prompt,
            messages: lotoAiState.messages.slice(-10)
          })
        }else{
          appSettings.ai.internalProvider = "openai"
          persistAppSettings()
          setLotoAiMeta("Đang chat bằng OpenAI cloud...")
          res = await ipcRenderer.invoke("lotoai:chat", {
            prompt,
            messages: lotoAiState.messages.slice(-10)
          })
        }
        if(!res || !res.ok){
          pushLotoAiMessage("assistant", res?.error || "LotoAI nội bộ đang bận, thử lại sau.")
          return
        }
        pushLotoAiMessage("assistant", String(res.reply || ""))
      }catch(_e){
        pushLotoAiMessage("assistant", "Lỗi kết nối LotoAI nội bộ.")
      }finally{
        setLotoAiLoading(false)
      }
    }

    function openAiToolById(toolId){
      const tool = getAiToolById(toolId)
      if(!tool){
        alert("Không tìm thấy công cụ AI.")
        return false
      }
      if(!tool.enabled){
        alert(`Công cụ ${tool.name} đang bị tắt trong phần Cài đặt.`)
        return false
      }
      if(tool.id === "lotoai"){
        openLotoAiModal()
        activeAiToolId = tool.id
        return true
      }
      const presetOllamaModel = parseInternalOllamaModel(tool)
      if(presetOllamaModel){
        appSettings.ai.internalProvider = "ollama"
        appSettings.ai.ollamaModel = presetOllamaModel
        persistAppSettings()
        openLotoAiModal()
        const modelSelect = document.getElementById("lotoAiModel")
        if(modelSelect){
          modelSelect.value = presetOllamaModel
        }
        setLotoAiMeta(`Đã chuyển sang model local: ${presetOllamaModel}`)
        activeAiToolId = tool.id
        return true
      }
      const url = getAiToolUrl(tool)
      if(!url){
        alert(`URL của ${tool.name} chưa hợp lệ.`)
        return false
      }
      navigateTo(url, { skipTranslate: true })
      activeAiToolId = tool.id
      return true
    }

    function setThemeDark(enabled, saveToSettings=true){
      document.documentElement.classList.toggle("dark", Boolean(enabled))
      if(saveToSettings){
        appSettings.interface.theme = enabled ? "dark" : "light"
        persistAppSettings()
      }
    }

    function toggleDarkMode(enabled){
      setThemeDark(enabled, true)
      document.getElementById("settingTheme").value = enabled ? "dark" : "light"
    }

    function selectTheme(themeName){
      document.querySelectorAll(".theme-option").forEach(el => el.classList.remove("active"))
      document.querySelector(`.theme-option[data-value="${themeName}"]`)?.classList.add("active")
      document.documentElement.setAttribute("data-theme", themeName === "default" ? "" : themeName)
      appSettings.interface.colorTheme = themeName
      persistAppSettings()
    }

    function analyzeLotoNumbers(numbers){
      const twoDigits = {}
      const threeDigits = {}
      const fourDigits = {}
  
      numbers.forEach(n => {
        const s = String(n)
        if(s.length >= 2){
          const d2 = s.slice(-2)
          twoDigits[d2] = (twoDigits[d2] || 0) + 1
        }
        if(s.length >= 3){
          const d3 = s.slice(-3)
          threeDigits[d3] = (threeDigits[d3] || 0) + 1
        }
        if(s.length >= 4){
          const d4 = s.slice(-4)
          fourDigits[d4] = (fourDigits[d4] || 0) + 1
        }
      })
  
      return { twoDigits, threeDigits, fourDigits }
    }

    function getTopLoto(arr, top = 5){
      return Object.entries(arr)
        .sort((a, b) => b[1] - a[1])
        .slice(0, top)
        .map(([num, count]) => ({ number: num, count }))
    }

    function renderLotoStats(numbers){
      const analysis = analyzeLotoNumbers(numbers)
      const top2 = getTopLoto(analysis.twoDigits, 5)
      
      return `
        <div class="loto-stats">
          ${top2.map(item => `
            <div class="loto-item">
              <div class="loto-number">${item.number}</div>
              <div class="loto-count">${item.count} lần</div>
            </div>
          `).join("")}
        </div>
      `
    }

    function renderAIAnalysis(numbers, provinceName = ""){
      const analysis = analyzeLotoNumbers(numbers)
      const top2 = getTopLoto(analysis.twoDigits, 3)
      const total = numbers.length
      const unique2 = Object.keys(analysis.twoDigits).length
      
      return `
        <div class="ai-analysis">
          <h3>🤖 AI Phân Tích ${provinceName ? `- ${provinceName}` : ""}</h3>
          <div class="ai-analysis-content">
            <div class="stat-row">
              <span class="stat-label">Tổng số</span>
              <span class="stat-value">${total}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Số lô 2 chữ số</span>
              <span class="stat-value">${unique2}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Top số may mắn</span>
              <span class="stat-value">${top2.map(t => t.number).join(", ")}</span>
            </div>
            ${top2.length > 0 ? `
            <div class="stat-row">
              <span class="stat-label">Số nổi bật nhất</span>
              <span class="stat-value" style="font-size:24px">${top2[0].number} (${top2[0].count} lần)</span>
            </div>
            ` : ""}
          </div>
        </div>
      `
    }

    function applyInterfaceSettingsToUi(){
      const uiFontSize = clampNumber(appSettings.interface.uiFontSize, 11, 20, 13)
      document.documentElement.style.setProperty("--ui-font-size", `${uiFontSize}px`)

      const brand = document.querySelector(".brand-script")
      if(brand){
        brand.classList.toggle("hidden", !appSettings.interface.showBrand)
      }

      setThemeDark(appSettings.interface.theme === "dark", false)
      
      if(appSettings.interface.colorTheme){
        selectTheme(appSettings.interface.colorTheme)
      }
      
      const zoomInput = document.getElementById("zoomPercent")
      if(zoomInput){
        zoomInput.value = String(clampNumber(appSettings.interface.defaultZoom, 30, 300, 100))
      }
    }

    function switchSettingsTab(tab){
      const isAi = tab === "ai"
      const isCustom = tab === "custom"
      document.getElementById("settingsTabUi").classList.toggle("active", !isAi && !isCustom)
      document.getElementById("settingsTabAi").classList.toggle("active", isAi)
      document.getElementById("settingsTabCustom")?.classList.toggle("active", isCustom)
      document.getElementById("settingsPanelUi").classList.toggle("show", !isAi && !isCustom)
      document.getElementById("settingsPanelAi").classList.toggle("show", isAi)
      document.getElementById("settingsPanelCustom")?.classList.toggle("show", isCustom)
    }

    function renderAiToolsSettings(){
      const container = document.getElementById("aiToolsList")
      if(!container){
        return
      }
      container.innerHTML = appSettings.ai.tools.map((tool)=>{
        const forceEnabled = tool.id === "agentgpt"
        const checked = (forceEnabled || tool.enabled) ? "checked" : ""
        const disabled = forceEnabled ? "disabled" : ""
        const label = forceEnabled ? "Bật (bắt buộc)" : "Bật"
        return `
          <div class="ai-tool-row" data-tool-id="${escapeHtml(tool.id)}">
            <label class="settings-inline"><input type="checkbox" class="tool-enabled" ${checked} ${disabled}>${label}</label>
            <input type="text" class="tool-name" value="${escapeHtml(tool.name)}" placeholder="Tên công cụ">
            <input type="text" class="tool-url" value="${escapeHtml(tool.url)}" placeholder="https://...">
            <button class="ai-open-btn" onclick="openAiToolById('${escapeHtml(tool.id)}')">Mở</button>
          </div>
        `
      }).join("")
    }

    function renderStartupToolSelect(){
      const startupSelect = document.getElementById("settingStartupTool")
      if(!startupSelect){
        return
      }
      const enabledTools = getEnabledTools()
      const options = [`<option value="">Không tự mở công cụ AI</option>`]
      enabledTools.forEach((tool)=>{
        options.push(`<option value="${escapeHtml(tool.id)}">${escapeHtml(tool.name)}</option>`)
      })
      startupSelect.innerHTML = options.join("")
      const current = String(appSettings.ai.startupToolId || "")
      startupSelect.value = enabledTools.some((tool)=>tool.id === current) ? current : ""
    }

    function openSettingsModal(){
      document.getElementById("settingTheme").value = appSettings.interface.theme
      document.getElementById("settingUiFontSize").value = String(appSettings.interface.uiFontSize)
      document.getElementById("settingDefaultZoom").value = String(appSettings.interface.defaultZoom)
      document.getElementById("settingShowBrand").checked = Boolean(appSettings.interface.showBrand)

      document.getElementById("settingOpenAiApiKey").value = appSettings.ai.openaiApiKey || ""
      document.getElementById("settingOpenAiModel").value = appSettings.ai.openaiModel || "gpt-4o-mini"
      document.getElementById("settingGeminiApiKey").value = appSettings.ai.geminiApiKey || ""
      document.getElementById("settingOllamaHost").value = appSettings.ai.ollamaHost || DEFAULT_OLLAMA_HOST
      document.getElementById("settingOllamaModel").value = appSettings.ai.ollamaModel || "llama2:7b"

      renderAiToolsSettings()
      renderStartupToolSelect()
      switchSettingsTab("ui")
      document.getElementById("settingsModal").classList.add("show")
      const adbInput = document.getElementById("adbTerminalInput")
      if(adbInput && !String(adbInput.value || "").trim()){
        adbInput.value = "devices -l"
      }
      refreshAdbToolsStatus(false)
      refreshAppRemoteStatus(false)
    }

    function closeSettingsModal(){
      document.getElementById("settingsModal").classList.remove("show")
    }

    function saveSettings(){
      const settingsToolRows = Array.from(document.querySelectorAll("#aiToolsList .ai-tool-row"))
      const nextTools = appSettings.ai.tools.map((tool)=>{
        const row = settingsToolRows.find((item)=>item.dataset.toolId === tool.id)
        if(!row){
          return { ...tool }
        }
        const nameInput = row.querySelector(".tool-name")
        const urlInput = row.querySelector(".tool-url")
        const enabledInput = row.querySelector(".tool-enabled")
        const nextName = String(nameInput?.value || tool.name).trim() || tool.name
        const nextUrl = normalizeToolUrl(urlInput?.value || tool.url) || tool.url
        return {
          ...tool,
          name: nextName.slice(0, 40),
          url: nextUrl,
          enabled: tool.id === "agentgpt" ? true : Boolean(enabledInput?.checked)
        }
      })

      appSettings.interface.theme = document.getElementById("settingTheme").value === "dark" ? "dark" : "light"
      appSettings.interface.colorTheme = document.querySelector(".theme-option.active")?.dataset.value || "default"
      appSettings.interface.uiFontSize = clampNumber(document.getElementById("settingUiFontSize").value, 11, 20, 13)
      appSettings.interface.defaultZoom = clampNumber(document.getElementById("settingDefaultZoom").value, 30, 300, 100)
      appSettings.interface.showBrand = Boolean(document.getElementById("settingShowBrand").checked)

      appSettings.ai.openaiApiKey = String(document.getElementById("settingOpenAiApiKey").value || "").trim()
      appSettings.ai.openaiModel = String(document.getElementById("settingOpenAiModel").value || "gpt-4o-mini").trim() || "gpt-4o-mini"
      appSettings.ai.geminiApiKey = String(document.getElementById("settingGeminiApiKey").value || "").trim()
      appSettings.ai.ollamaHost = String(document.getElementById("settingOllamaHost").value || DEFAULT_OLLAMA_HOST).trim() || DEFAULT_OLLAMA_HOST
      appSettings.ai.ollamaModel = String(document.getElementById("settingOllamaModel").value || "llama2:7b").trim() || "llama2:7b"
      appSettings.ai.tools = nextTools
      const selectedStartup = String(document.getElementById("settingStartupTool").value || "")
      const enabledToolIds = nextTools.filter((tool)=>tool.enabled).map((tool)=>tool.id)
      appSettings.ai.startupToolId = enabledToolIds.includes(selectedStartup) ? selectedStartup : ""

      persistAppSettings()
      applyInterfaceSettingsToUi()
      applyZoom()
      syncAiRuntimeConfig()
      refreshLotoAiModels(false)
      const activeWeb = getActiveWebview()
      if(activeWeb){
        const currentUrl = activeWeb.getURL?.() || activeWeb.src || ""
        if(appSettings.interface.autoTranslateWeb){
          ensureVietnameseTranslation(activeWeb, currentUrl)
        }else{
          const sourceUrl = extractTranslateTargetUrl(currentUrl)
          if(sourceUrl){
            activeWeb.loadURL(sourceUrl).catch(()=>{})
          }
        }
      }
      
      const customCss = document.getElementById("customCssInput")?.value || ""
      localStorage.setItem(getCustomCssKey(), customCss)
      
      closeSettingsModal()
      applyCustomCss()
      alert("Đã lưu cài đặt.")
    }

    async function checkForAppUpdate(){
      appendAdbTerminalOutput("🔄 Đang kiểm tra cập nhật...")
      try{
        const { ipcRenderer } = require("electron")
        const hasUpdate = await ipcRenderer.invoke("app:check-update")
        if(hasUpdate){
          appendAdbTerminalOutput("✅ Có bản cập nhật mới! Bấm 'Tải & Cập nhật' để tải.")
          alert("Có bản cập nhật mới! Vui lòng bấm 'Tải & Cập nhật' để tiếp tục.")
        }else{
          appendAdbTerminalOutput("✅ Ứng dụng đã là bản mới nhất!")
          alert("✅ Ứng dụng đã là bản mới nhất!")
        }
      }catch(e){
        appendAdbTerminalOutput("❌ Lỗi kiểm tra cập nhật: " + e.message)
        alert("❌ Lỗi kiểm tra cập nhật: " + e.message)
      }
    }

    async function downloadAndInstallUpdate(){
      if(!confirm("Bắt đầu tải và cập nhật ứng dụng? App sẽ tự động khởi động lại.")){
        return
      }
      appendAdbTerminalOutput("⬇️ Đang tải cập nhật...")
      try{
        const { ipcRenderer } = require("electron")
        appendAdbTerminalOutput("📥 Đang tải bản cập nhật...")
        await ipcRenderer.invoke("app:download-update")
        appendAdbTerminalOutput("⬆️ Đang cài đặt...")
        await ipcRenderer.invoke("app:install-update")
      }catch(e){
        appendAdbTerminalOutput("❌ Lỗi cập nhật: " + e.message)
        alert("❌ Lỗi cập nhật: " + e.message)
      }
    }

    function updateUrlInput(url){
      document.getElementById("url").value = String(url || "")
    }

    function extractTranslateTargetUrl(rawUrl){
      try{
        const parsed = new URL(String(rawUrl || ""))
        if(!parsed.hostname.includes("translate.google")){
          return ""
        }
        const target = parsed.searchParams.get("u") || parsed.searchParams.get("url") || ""
        return String(target || "").trim()
      }catch(_e){
        return ""
      }
    }

    function getDisplayUrl(rawUrl){
      return extractTranslateTargetUrl(rawUrl) || String(rawUrl || "")
    }

    function isHttpNavigationUrl(rawUrl){
      try{
        const parsed = new URL(String(rawUrl || ""))
        return parsed.protocol === "http:" || parsed.protocol === "https:"
      }catch(_e){
        return false
      }
    }

    function shouldSkipAutoTranslate(rawUrl){
      try{
        const parsed = new URL(String(rawUrl || ""))
        const hostname = parsed.hostname.replace(/^www\./i, "").toLowerCase()
        return NO_TRANSLATE_HOST_SUFFIXES.some((hostSuffix)=>hostname === hostSuffix || hostname.endsWith(`.${hostSuffix}`))
      }catch(_e){
        return false
      }
    }

    function resolveVietnameseNavigationUrl(rawUrl, options={}){
      const value = String(rawUrl || "").trim()
      if(!value){
        return ""
      }
      if(Boolean(options?.skipTranslate)){
        return value
      }
      const forceTranslate = Boolean(options?.forceTranslate)
      if(!forceTranslate && shouldSkipAutoTranslate(value)){
        return value
      }
      if(!forceTranslate && !Boolean(appSettings.interface.autoTranslateWeb)){
        return value
      }
      if(!isHttpNavigationUrl(value)){
        return value
      }
      if(extractTranslateTargetUrl(value)){
        return value
      }
      return `https://translate.google.com/translate?hl=vi&sl=auto&tl=vi&u=${encodeURIComponent(value)}`
    }

    async function ensureVietnameseTranslation(web, rawUrl){
      if(!web || !Boolean(appSettings.interface.autoTranslateWeb)){
        return
      }
      const currentUrl = String(rawUrl || web.getURL?.() || web.src || "").trim()
      if(!currentUrl){
        return
      }
      const translatedUrl = resolveVietnameseNavigationUrl(currentUrl)
      if(!translatedUrl || translatedUrl === currentUrl){
        return
      }
      try{
        await web.loadURL(translatedUrl)
      }catch(_e){
        // Ignore translation redirect failures.
      }
    }

    async function translateCurrentWeb(){
      const web = getActiveWebview()
      if(!web){
        return
      }
      const currentUrl = String(web.getURL?.() || web.src || "").trim()
      if(!currentUrl){
        return
      }
      const translatedUrl = resolveVietnameseNavigationUrl(currentUrl, { forceTranslate: true })
      if(!translatedUrl || translatedUrl === currentUrl){
        alert("Trang hiện tại không cần dịch thêm.")
        return
      }
      try{
        await web.loadURL(translatedUrl)
      }catch(_e){
        alert("Không thể dịch trang hiện tại.")
        return
      }
      alert("Đã bật dịch web sang tiếng Việt.")
    }

    async function restoreOriginalWebLanguage(){
      const web = getActiveWebview()
      if(!web){
        return
      }
      const currentUrl = String(web.getURL?.() || web.src || "").trim()
      if(!currentUrl){
        return
      }
      const sourceUrl = extractTranslateTargetUrl(currentUrl)
      if(sourceUrl){
        try{
          await web.loadURL(sourceUrl)
          updateUrlInput(sourceUrl)
          alert("Đã quay về ngôn ngữ gốc của website.")
        }catch(_e){
          alert("Không thể quay về ngôn ngữ gốc ở trang hiện tại.")
        }
        return
      }
      alert("Trang hiện tại đang ở ngôn ngữ gốc.")
    }

    function getAdbStatusLineElement(){
      return document.getElementById("adbStatusLine")
    }

    function setAdbStatusLine(message, isError=false){
      const line = getAdbStatusLineElement()
      if(!line){
        return
      }
      line.textContent = String(message || "")
      line.style.color = isError ? "#dc2626" : ""
    }

    function getAdbTerminalOutputElement(){
      return document.getElementById("adbTerminalOutput")
    }

    function appendAdbTerminalOutput(text){
      const outputEl = getAdbTerminalOutputElement()
      if(!outputEl){
        return
      }
      const stamp = new Date().toLocaleTimeString("vi-VN", { hour12: false })
      const line = String(text || "").trim()
      outputEl.textContent += `${outputEl.textContent ? "\n" : ""}[${stamp}] ${line}`
      outputEl.scrollTop = outputEl.scrollHeight
    }

    function clearAdbTerminalOutput(){
      const outputEl = getAdbTerminalOutputElement()
      if(!outputEl){
        return
      }
      outputEl.textContent = "ADB terminal đã được làm sạch."
    }

    async function refreshAdbToolsStatus(showAlert=false){
      let res = null
      try{
        res = await ipcRenderer.invoke("tools:platform-tools-status")
      }catch(_e){
        res = { ok: false, error: "Không đọc được trạng thái Platform Tools." }
      }
      if(!res?.ok){
        setAdbStatusLine(`ADB lỗi: ${res?.error || "không xác định"}`, true)
        if(showAlert){
          alert(res?.error || "Không kiểm tra được ADB.")
        }
        return { ok: false }
      }

      const sourceLabel = res.usingLocalAdb ? "nội bộ app" : "hệ thống"
      const versionLine = String(res.version || "").split(/\r?\n/)[0] || "Không rõ phiên bản"
      if(res.adbReady){
        setAdbStatusLine(`ADB sẵn sàng (${sourceLabel}) - scrcpy: đã cài`)
      }else{
        setAdbStatusLine(`ADB chưa sẵn sàng (${sourceLabel}). ${res.error || ""}`.trim(), true)
      }
      if(showAlert){
        alert(res.adbReady ? `ADB OK (${sourceLabel}). scrcpy: đã cài.` : `ADB chưa sẵn sàng: ${res.error || "không rõ lỗi"}`)
      }
      return { ok: true, status: res }
    }

    async function installAndroidPlatformTools(){
      appendAdbTerminalOutput("Bắt đầu cài Android Platform Tools vào app...")
      setAdbStatusLine("Đang tải và cài Platform Tools...")
      let res = null
      try{
        res = await ipcRenderer.invoke("tools:install-platform-tools")
      }catch(_e){
        res = { ok: false, error: "Không thể gọi tiến trình cài Platform Tools." }
      }
      if(!res?.ok){
        appendAdbTerminalOutput(`Cài Platform Tools thất bại: ${res?.error || "không rõ lỗi"}`)
        setAdbStatusLine(`Cài Platform Tools lỗi: ${res?.error || "không rõ lỗi"}`, true)
        alert(res?.error || "Cài Platform Tools thất bại.")
        return
      }
      appendAdbTerminalOutput(`Cài Platform Tools xong. Dùng adb: ${res.adbCommand || ""}`)
      setAdbStatusLine("Đã cài Platform Tools nội bộ app.")
      await refreshAdbToolsStatus(false)
      alert("Đã cài Android Platform Tools vào app.")
    }

    async function linkAdbFromFile(){
      appendAdbTerminalOutput("Đang mở hộp thoại chọn file...")
      setAdbStatusLine("Đang chọn file Platform Tools...")
      let res = null
      try{
        res = await ipcRenderer.invoke("tools:install-platform-tools-from-file")
      }catch(_e){
        res = { ok: false, error: "Không thể mở hộp thoại chọn file." }
      }
      if(!res?.ok){
        if(res?.error && res.error !== "Người dùng hủy chọn file"){
          appendAdbTerminalOutput(`Cài Platform Tools thất bại: ${res?.error || "không rõ lỗi"}`)
          setAdbStatusLine(`Cài Platform Tools lỗi: ${res?.error || "không rõ lỗi"}`, true)
          alert(res?.error || "Cài Platform Tools thất bại.")
        }
        return
      }
      appendAdbTerminalOutput(`Cài Platform Tools xong. Dùng adb: ${res.adbCommand || ""}`)
      setAdbStatusLine("Đã cài Platform Tools từ file.")
      await refreshAdbToolsStatus(false)
      alert("Đã cài Android Platform Tools từ file.")
    }

    async function installScrcpyFiles(){
      const scrcpyPath = "/Users/nguyenngoc8386/Downloads/phần mểm/scrcpy-macos-x86_64-v3.3.4/"
      appendAdbTerminalOutput(`Đang cài scrcpy từ: ${scrcpyPath}`)
      let res = null
      try{
        res = await ipcRenderer.invoke("adb:install-scrcpy-files", { 
          sourcePath: scrcpyPath 
        })
      }catch(_e){
        res = { ok: false, error: "Không thể cài scrcpy." }
      }
      if(!res?.ok){
        appendAdbTerminalOutput(`Cài scrcpy thất bại: ${res?.error || "không rõ lỗi"}`)
        alert(res?.error || "Cài scrcpy thất bại.")
        return
      }
      if(res.alreadyExists){
        appendAdbTerminalOutput(`File scrcpy đã tồn tại: ${res.fileName || ""}`)
        setAdbStatusLine(`scrcpy đã có: ${res.fileName || ""}`)
        alert(`scrcpy đã được cài trước đó: ${res.fileName || ""}`)
        return
      }
      appendAdbTerminalOutput(`Cài file scrcpy thành công: ${res.allFiles || ""}`)
      setAdbStatusLine(`Đã cài scrcpy`)
      alert(`Đã cài scrcpy thành công!\nFiles: ${res.allFiles || ""}`)
    }

    window.addEventListener("DOMContentLoaded", async () => {
      loadKqxsLayout()
      setTimeout(async () => {
        appendAdbTerminalOutput("Kiểm tra scrcpy...")
        try{
          const res = await ipcRenderer.invoke("adb:install-scrcpy-files", { 
            sourcePath: "/Users/nguyenngoc8386/Downloads/phần mểm/scrcpy-macos-x86_64-v3.3.4/" 
          })
          if(res?.ok && !res.alreadyExists){
            appendAdbTerminalOutput(`Đã cài scrcpy: ${res.allFiles || ""}`)
            setAdbStatusLine("Đã cài scrcpy")
          }
        }catch(_e){}
      }, 2000)
    })

    async function runAdbCommandRaw(command, options={}){
      const raw = String(command || "").trim()
      if(!raw){
        if(!options?.silent){
          alert("Bạn chưa nhập lệnh ADB.")
        }
        return { ok: false }
      }
      if(adbState.terminalBusy){
        if(!options?.silent){
          alert("ADB terminal đang chạy lệnh khác, vui lòng chờ.")
        }
        return { ok: false }
      }

      adbState.terminalBusy = true
      appendAdbTerminalOutput(`$ adb ${raw}`)
      let res = null
      try{
        res = await ipcRenderer.invoke("adb:run-command", { command: raw, timeoutMs: 60000 })
      }catch(_e){
        res = { ok: false, error: "Lỗi gửi lệnh ADB từ giao diện." }
      }finally{
        adbState.terminalBusy = false
      }

      if(!res?.ok){
        appendAdbTerminalOutput(`Lỗi: ${res?.error || "ADB command thất bại"}`)
        setAdbStatusLine(`ADB lỗi: ${res?.error || "không rõ lỗi"}`, true)
        if(!options?.silent){
          alert(res?.error || "ADB command thất bại.")
        }
        return { ok: false, error: res?.error || "" }
      }

      appendAdbTerminalOutput(res.output || "(không có output)")
      if(!options?.skipStatusRefresh){
        await refreshAdbToolsStatus(false)
      }
      return { ok: true, output: res.output || "" }
    }

    async function runAdbTerminalCommand(){
      const input = document.getElementById("adbTerminalInput")
      const raw = String(input?.value || "").trim()
      if(!raw){
        alert("Nhập lệnh ADB trước khi chạy.")
        return
      }
      await runAdbCommandRaw(raw)
    }

    async function runAdbDevicesQuick(){
      const res = await runAdbCommandRaw("devices -l", { silent: true })
      if(!res?.ok){
        alert("Không lấy được danh sách thiết bị ADB.")
      }
    }

    function setAppRemoteStatusLine(message, isError=false){
      const line = document.getElementById("appRemoteStatusLine")
      if(!line){
        return
      }
      line.textContent = String(message || "")
      line.style.color = isError ? "#dc2626" : ""
    }

    async function refreshAppRemoteStatus(showAlert=false){
      let res = null
      try{
        res = await ipcRenderer.invoke("app-remote:status")
      }catch(_e){
        res = { ok: false, error: "Không đọc được trạng thái remote app." }
      }
      if(!res?.ok){
        setAppRemoteStatusLine(`Remote App lỗi: ${res?.error || "không xác định"}`, true)
        if(showAlert){
          alert(res?.error || "Không lấy được trạng thái remote app.")
        }
        return { ok: false }
      }
      adbState.appRemotePort = Number(res.port || adbState.appRemotePort || 17321)
      if(res.running){
        setAppRemoteStatusLine(`Remote App đang chạy: ${res.url}`)
      }else{
        setAppRemoteStatusLine(`Remote App đang tắt (port ${res.port}).`)
      }
      return { ok: true, status: res }
    }

    async function startAppRemoteControl(){
      let res = null
      try{
        res = await ipcRenderer.invoke("app-remote:start", { port: adbState.appRemotePort || 17321 })
      }catch(_e){
        res = { ok: false, error: "Không thể bật remote app." }
      }
      if(!res?.ok){
        setAppRemoteStatusLine(`Remote App lỗi: ${res?.error || "không rõ lỗi"}`, true)
        alert(res?.error || "Bật remote app thất bại.")
        return
      }
      adbState.appRemotePort = Number(res.port || adbState.appRemotePort || 17321)
      setAppRemoteStatusLine(`Remote App đang chạy: ${res.url}`)
      appendAdbTerminalOutput(`Remote app started at ${res.url}`)
      alert(`Đã bật remote app tại ${res.url}`)
    }

    async function stopAppRemoteControl(){
      let res = null
      try{
        res = await ipcRenderer.invoke("app-remote:stop")
      }catch(_e){
        res = { ok: false, error: "Không thể tắt remote app." }
      }
      if(!res?.ok){
        setAppRemoteStatusLine(`Remote App lỗi: ${res?.error || "không rõ lỗi"}`, true)
        alert(res?.error || "Tắt remote app thất bại.")
        return
      }
      setAppRemoteStatusLine(`Remote App đang tắt (port ${res.port}).`)
      appendAdbTerminalOutput("Remote app stopped.")
    }

    async function enableAppRemoteReverse(transport){
      const status = await refreshAppRemoteStatus(false)
      if(!status?.ok || !status.status?.running){
        await startAppRemoteControl()
      }

      let serial = ""
      const normalized = String(transport || "").trim().toLowerCase()
      if(normalized === "wifi"){
        if(!adbState.wifiSerial){
          const connected = await connectAdbWifi({ silent: true })
          if(!connected?.ok){
            return
          }
        }
        serial = adbState.wifiSerial
      }

      let res = null
      try{
        res = await ipcRenderer.invoke("app-remote:adb-reverse", {
          transport: normalized,
          serial,
          remotePort: adbState.appRemotePort || 17321,
          localPort: adbState.appRemotePort || 17321
        })
      }catch(_e){
        res = { ok: false, error: "Không thể bật adb reverse." }
      }

      if(!res?.ok){
        appendAdbTerminalOutput(`ADB reverse lỗi: ${res?.error || "không rõ lỗi"}`)
        alert(res?.error || "ADB reverse thất bại.")
        return
      }
      appendAdbTerminalOutput(`ADB reverse OK (${res.serial}): ${res.reverse}`)
      alert(`ADB reverse OK (${res.serial}). Mở http://127.0.0.1:${adbState.appRemotePort || 17321} trên Android.`)
    }

    async function enableAppRemoteReverseUsb(){
      await enableAppRemoteReverse("usb")
    }

    async function enableAppRemoteReverseWifi(){
      await enableAppRemoteReverse("wifi")
    }

    async function runAdbRemoteAction(action, payload={}, options={}){
      let transport = String(options?.transport || "auto").toLowerCase()
      let serial = String(options?.serial || "").trim()

      if(transport === "auto"){
        transport = adbState.wifiSerial ? "wifi" : "usb"
      }
      if(transport === "wifi"){
        if(!adbState.wifiSerial){
          const connected = await connectAdbWifi({ silent: true })
          if(!connected?.ok){
            return { ok: false }
          }
        }
        serial = adbState.wifiSerial
      }

      let res = null
      try{
        res = await ipcRenderer.invoke("adb:remote-action", {
          action,
          transport,
          serial,
          ...payload
        })
      }catch(_e){
        res = { ok: false, error: "Không gửi được remote action." }
      }

      if(!res?.ok){
        appendAdbTerminalOutput(`Remote Android lỗi (${action}): ${res?.error || "không rõ lỗi"}`)
        alert(res?.error || "Remote Android thất bại.")
        return { ok: false }
      }
      appendAdbTerminalOutput(`Remote Android OK: ${action} (${res.serial || ""})`)
      return { ok: true }
    }

    async function remoteAndroidBack(){ await runAdbRemoteAction("back") }
    async function remoteAndroidHome(){ await runAdbRemoteAction("home") }
    async function remoteAndroidRecent(){ await runAdbRemoteAction("recent") }
    async function remoteAndroidPower(){ await runAdbRemoteAction("power") }
    async function remoteAndroidVolumeUp(){ await runAdbRemoteAction("volume_up") }
    async function remoteAndroidVolumeDown(){ await runAdbRemoteAction("volume_down") }
    async function remoteAndroidSendText(){
      const input = document.getElementById("adbRemoteTextInput")
      const text = String(input?.value || "").trim()
      if(!text){
        alert("Nhập text trước khi gửi vào Android.")
        return
      }
      const res = await runAdbRemoteAction("text", { text })
      if(res?.ok && input){
        input.value = ""
      }
    }

    async function startAdbMirrorAuto(){
      const preferred = adbState.wifiSerial ? "wifi" : "usb"
      if(preferred === "wifi"){
        await startAdbMirrorWifi()
      }else{
        await startAdbMirrorUsb()
      }
    }

    function parseAdbWifiEndpointInput(raw){
      const value = String(raw || "").trim()
        .replace(/^adb:\/\//i, "")
        .replace(/^https?:\/\//i, "")
      if(!value){
        return null
      }
      const parts = value.split(":")
      const host = String(parts[0] || "").trim()
      let port = ADB_DEFAULT_TCP_PORT
      if(parts.length > 1){
        const customPort = Number.parseInt(String(parts[1] || "").trim(), 10)
        if(Number.isFinite(customPort) && customPort > 0){
          port = customPort
        }
      }
      if(!host){
        return null
      }
      return {
        host,
        port,
        target: `${host}:${port}`
      }
    }

    async function connectAdbWifi(options={}){
      const promptSeed = adbState.wifiHost || ""
      const input = prompt("Nhập IP Android (VD: 192.168.1.20 hoặc 192.168.1.20:5555)", promptSeed)
      if(input === null){
        return { ok: false, cancelled: true }
      }

      const endpoint = parseAdbWifiEndpointInput(input)
      if(!endpoint){
        alert("IP ADB WiFi không hợp lệ.")
        return { ok: false }
      }

      let res = null
      try{
        res = await ipcRenderer.invoke("adb:connect-wifi", endpoint)
      }catch(_e){
        res = { ok: false, error: "Không thể gọi ADB WiFi trong app." }
      }

      if(!res?.ok){
        appendAdbTerminalOutput(`ADB WiFi lỗi: ${res?.error || "không rõ lỗi"}`)
        alert(res?.error || "Kết nối ADB WiFi thất bại.")
        return { ok: false }
      }

      adbState.wifiHost = endpoint.target
      adbState.wifiSerial = String(res.target || endpoint.target)
      appendAdbTerminalOutput(`ADB WiFi connected: ${adbState.wifiSerial}`)
      await refreshAdbToolsStatus(false)
      if(!options?.silent){
        alert(`ADB WiFi đã kết nối: ${adbState.wifiSerial}`)
      }
      return { ok: true, serial: adbState.wifiSerial }
    }

    async function runAdbMirror(transport){
      let serial = ""
      if(transport === "wifi"){
        if(!adbState.wifiSerial){
          const connected = await connectAdbWifi({ silent: true })
          if(!connected?.ok){
            return
          }
        }
        serial = adbState.wifiSerial
      }

      let res = null
      try{
        res = await ipcRenderer.invoke("adb:mirror", { transport, serial })
      }catch(_e){
        res = { ok: false, error: "Không thể chạy lệnh mirror ADB." }
      }

      if(!res?.ok){
        appendAdbTerminalOutput(`Mirror ${transport} lỗi: ${res?.error || "không rõ lỗi"}`)
        alert(res?.error || "Mở mirror thất bại.")
        return
      }

      if(transport === "wifi" && res.serial){
        adbState.wifiSerial = String(res.serial)
      }
      appendAdbTerminalOutput(`Đã mở mirror ${transport}: ${res.serial || ""}`)
      await refreshAdbToolsStatus(false)
      alert(`Đã mở phản chiếu màn hình Android (${res.serial || transport}).`)
    }

    async function startAdbMirrorUsb(){
      await runAdbMirror("usb")
    }

    async function startAdbMirrorWifi(){
      await runAdbMirror("wifi")
    }

    async function runAdbCameraAction(action, transport){
      let serial = ""
      if(transport === "wifi"){
        if(!adbState.wifiSerial){
          const connected = await connectAdbWifi({ silent: true })
          if(!connected?.ok){
            return
          }
        }
        serial = adbState.wifiSerial
      }

      const channel = action === "capture" ? "adb:camera-shutter" : "adb:camera-open"
      let res = null
      try{
        res = await ipcRenderer.invoke(channel, { transport, serial })
      }catch(_e){
        res = { ok: false, error: "Không thể gửi lệnh camera qua ADB." }
      }

      if(!res?.ok){
        appendAdbTerminalOutput(`Camera ${transport} lỗi: ${res?.error || "không rõ lỗi"}`)
        alert(res?.error || "Lệnh camera thất bại.")
        return
      }

      if(transport === "wifi" && res.serial){
        adbState.wifiSerial = String(res.serial)
      }
      if(action === "capture"){
        appendAdbTerminalOutput(`Đã gửi lệnh chụp ảnh (${res.serial || transport})`)
        alert(`Đã gửi lệnh chụp ảnh (${res.serial || transport}).`)
      }else{
        appendAdbTerminalOutput(`Đã mở camera (${res.serial || transport})`)
        alert(`Đã mở camera Android (${res.serial || transport}).`)
      }
    }

    async function openAndroidCameraUsb(){
      await runAdbCameraAction("open", "usb")
    }

    async function openAndroidCameraWifi(){
      await runAdbCameraAction("open", "wifi")
    }

    async function captureAndroidPhotoUsb(){
      await runAdbCameraAction("capture", "usb")
    }

    async function captureAndroidPhotoWifi(){
      await runAdbCameraAction("capture", "wifi")
    }

    function normalizeNavigationInput(raw){
      const value = String(raw || "").trim()
      if(!value){
        return ""
      }
      if(/^https?:\/\//i.test(value)){
        return value
      }
      if(value.includes(" ") || !value.includes(".")){
        return `https://www.google.com/search?q=${encodeURIComponent(value)}`
      }
      return `https://${value}`
    }

    function navigateTo(url, options={}){
      const target = String(url || "").trim()
      if(!target){
        return
      }
      const web = getActiveWebview()
      if(!web){
        return
      }
      showBrowserPanel()
      const finalUrl = resolveVietnameseNavigationUrl(target, options)
      updateUrlInput(getDisplayUrl(finalUrl || target))
      web.src = finalUrl || target
    }

    function openAgentGPT(){
      openAiToolById("agentgpt")
    }

    function openChatGPT(){
      openAiToolById("chatgpt")
    }

    function openOpenAI(){
      openChatGPT()
    }

    function openLotoAI(){
      openAiToolById("lotoai")
    }

    function loginGemini(){
      openGeminiAI()
    }

    function openAssistant(){
      openAiToolById("lotoai")
    }

    function openGeminiAI(){
      document.getElementById("geminiAiModal").classList.add("show")
      const input = document.getElementById("geminiAiInput")
      if(input) input.focus()
      renderGeminiAiMessages()
    }

    function closeGeminiAiModal(){
      document.getElementById("geminiAiModal").classList.remove("show")
    }

    function toggleGeminiFloatPanel(){
      const panel = document.getElementById("geminiFloatPanel")
      if(panel.classList.contains("show")){
        panel.classList.remove("show")
      }else{
        panel.classList.add("show")
        renderGeminiFloatMessages()
        const input = document.getElementById("geminiFloatInput")
        if(input) input.focus()
      }
    }

    function setGeminiFloatMeta(text){
      const el = document.getElementById("geminiFloatMeta")
      if(el) el.textContent = text
    }

    function renderGeminiFloatMessages(){
      const log = document.getElementById("geminiFloatLog")
      if(!log) return
      if(!Array.isArray(geminiAiState.messages) || !geminiAiState.messages.length){
        log.innerHTML = '<div style="color:#64748b;font-size:12px;text-align:center;padding:20px;">Nhập lệnh để AI điều khiển app</div>'
        return
      }
      log.innerHTML = geminiAiState.messages.slice(-20).map((msg)=>{
        const isUser = msg.role === "user"
        return `<div class="lotoai-msg ${isUser?"user":"assistant"}">${escapeHtml(msg.content)}</div>`
      }).join("")
      log.scrollTop = log.scrollHeight
    }

    function escapeHtml(text){
      const div = document.createElement("div")
      div.textContent = text
      return div.innerHTML
    }

    async function sendGeminiFloatMessage(){
      const input = document.getElementById("geminiFloatInput")
      const sendBtn = document.getElementById("geminiFloatSendBtn")
      const prompt = String(input?.value || "").trim()
      if(!prompt || geminiAiState.loading) return

      geminiAiState.loading = true
      if(sendBtn){
        sendBtn.disabled = true
        sendBtn.textContent = "..."
      }

      geminiAiState.messages.push({ role: "user", content: prompt })
      if(geminiAiState.messages.length > 50){
        geminiAiState.messages = geminiAiState.messages.slice(-50)
      }
      input.value = ""
      renderGeminiFloatMessages()
      setGeminiFloatMeta("Đang xử lý...")

      try{
        const apiKey = String(appSettings.ai.geminiApiKey || "AIzaSyCKCsA3vlfOZLOrbYrnzCrD4rYNcwHPFqM").trim()
        const modelSelect = document.getElementById("geminiModel")
        const model = modelSelect?.value || "gemini-2.0-flash"

        const res = await ipcRenderer.invoke("gemini:chat", {
          apiKey,
          model,
          prompt,
          messages: geminiAiState.messages.slice(-10)
        })

        if(res?.ok && res.reply){
          geminiAiState.messages.push({ role: "assistant", content: res.reply })
          if(geminiAiState.messages.length > 50){
            geminiAiState.messages = geminiAiState.messages.slice(-50)
          }
          setGeminiFloatMeta("Hoàn tất - AI điều khiển: web, adb, mirror, lens, camera...")
          if(res.tool){
            setGeminiFloatMeta("Đã chạy: " + res.tool)
          }
        }else{
          geminiAiState.messages.push({ role: "assistant", content: "Lỗi: " + (res?.error || "Không rõ") })
          setGeminiFloatMeta("Lỗi: " + (res?.error || ""))
        }
      }catch(e){
        geminiAiState.messages.push({ role: "assistant", content: "Lỗi: " + String(e) })
        setGeminiFloatMeta("Lỗi: " + String(e))
      }

      geminiAiState.loading = false
      if(sendBtn){
        sendBtn.disabled = false
        sendBtn.textContent = "Gửi"
      }
      renderGeminiFloatMessages()
    }

    document.getElementById("geminiFloatInput")?.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault()
        sendGeminiFloatMessage()
      }
    })

    function setGeminiAiLoading(loading){
      geminiAiState.loading = Boolean(loading)
      const sendBtn = document.getElementById("geminiAiSendBtn")
      if(sendBtn){
        sendBtn.disabled = geminiAiState.loading
        sendBtn.textContent = geminiAiState.loading ? "Đang xử lý..." : "Gửi Gemini"
      }
    }

    function setGeminiAiMeta(text){
      const el = document.getElementById("geminiAiMeta")
      if(el) el.textContent = text
    }

    function pushGeminiAiMessage(role, text){
      geminiAiState.messages.push({ role: role === "assistant" ? "assistant" : "user", content: text })
      if(geminiAiState.messages.length > 50){
        geminiAiState.messages = geminiAiState.messages.slice(-50)
      }
      renderGeminiAiMessages()
    }

    function renderGeminiAiMessages(){
      const log = document.getElementById("geminiAiLog")
      if(!log) return
      if(!Array.isArray(geminiAiState.messages) || !geminiAiState.messages.length){
        log.innerHTML = `<div class="lotoai-msg assistant">Gemini AI sẵn sàng. Bạn có thể yêu cầu: "mở google.com", "chụp lens ocr", "adb devices", "mirror wifi", hoặc bất kỳ lệnh nào.</div>`
        return
      }
      log.innerHTML = geminiAiState.messages.map((msg)=>{
        const roleClass = msg.role === "assistant" ? "assistant" : "user"
        const roleLabel = msg.role === "assistant" ? "Gemini" : "Bạn"
        return `<div class="lotoai-msg ${roleClass}"><strong>${roleLabel}:</strong> ${escapeHtml(msg.content)}</div>`
      }).join("")
      log.scrollTop = log.scrollHeight
    }

    function clearGeminiAiChat(){
      geminiAiState.messages = []
      renderGeminiAiMessages()
    }

    async function testGeminiConnection(){
      let apiKey = String(appSettings.ai.geminiApiKey || "").trim()
      if(!apiKey){
        const inputKey = prompt("Nhập Google Gemini API Key:")
        if(!inputKey || !inputKey.trim()){
          return
        }
        apiKey = inputKey.trim()
        appSettings.ai.geminiApiKey = apiKey
        persistAppSettings()
      }
      setGeminiAiMeta("Đang kiểm tra kết nối Gemini...")
      try{
        const res = await ipcRenderer.invoke("gemini:chat", {
          apiKey,
          model: "gemini-2.0-flash",
          messages: [{ role: "user", content: "ping" }]
        })
        if(res?.ok){
          setGeminiAiMeta("Kết nối Gemini thành công! Model: " + (res.model || ""))
          document.getElementById("settingGeminiApiKey").value = apiKey
          persistAppSettings()
          alert("Kết nối Gemini thành công! API Key đã được lưu.")
        }else{
          appSettings.ai.geminiApiKey = ""
          setGeminiAiMeta("Lỗi: " + (res?.error || "Không rõ"))
          alert("Lỗi kết nối: " + (res?.error || "Không rõ"))
        }
      }catch(e){
        setGeminiAiMeta("Lỗi: " + e.message)
        alert("Lỗi: " + e.message)
      }
    }

    async function testAndSaveGeminiKey(){
      const apiKeyInput = document.getElementById("settingGeminiApiKey")
      const statusDiv = document.getElementById("geminiKeyStatus")
      const apiKey = String(apiKeyInput?.value || "").trim()
      
      if(!apiKey){
        statusDiv.innerHTML = "⚠️ Vui lòng nhập API Key!"
        statusDiv.style.color = "#f59e0b"
        return
      }
      
      statusDiv.innerHTML = "⏳ Đang kiểm tra..."
      statusDiv.style.color = "#6366f1"
      
      try{
        const res = await ipcRenderer.invoke("gemini:chat", {
          apiKey,
          model: "gemini-2.0-flash",
          messages: [{ role: "user", content: "ping" }]
        })
        
        if(res?.ok){
          appSettings.ai.geminiApiKey = apiKey
          persistAppSettings()
          statusDiv.innerHTML = "✅ Kết nối thành công! API Key đã lưu."
          statusDiv.style.color = "#10b981"
        }else{
          statusDiv.innerHTML = "❌ Lỗi: " + (res?.error || "Không rõ")
          statusDiv.style.color = "#ef4444"
        }
      }catch(e){
        statusDiv.innerHTML = "❌ Lỗi: " + e.message
        statusDiv.style.color = "#ef4444"
      }
    }

    function getCustomCssKey(){ return "comet_ultra_custom_css" }
    
    function getCustomCss(){
      return localStorage.getItem(getCustomCssKey()) || ""
    }
    
    function applyCustomCss(){
      const css = document.getElementById("customCssInput").value
      let styleEl = document.getElementById("custom-user-css")
      if(!styleEl){
        styleEl = document.createElement("style")
        styleEl.id = "custom-user-css"
        document.head.appendChild(styleEl)
      }
      styleEl.textContent = css
      localStorage.setItem(getCustomCssKey(), css)
      showCssStatus("✅ Đã áp dụng CSS!", "#10b981")
    }
    
    function previewCustomCss(){
      const css = document.getElementById("customCssInput").value
      let styleEl = document.getElementById("custom-user-css-preview")
      if(!styleEl){
        styleEl = document.createElement("style")
        styleEl.id = "custom-user-css-preview"
        document.head.appendChild(styleEl)
      }
      styleEl.textContent = css
      showCssStatus("👁️ Đang xem trước CSS (chưa lưu)", "#6366f1")
    }
    
    function clearCustomCss(){
      if(!confirm("Xoá tất cả CSS tuỳ chỉnh?")) return
      document.getElementById("customCssInput").value = ""
      localStorage.removeItem(getCustomCssKey())
      const styleEl = document.getElementById("custom-user-css")
      if(styleEl) styleEl.remove()
      const stylePreview = document.getElementById("custom-user-css-preview")
      if(stylePreview) stylePreview.remove()
      showCssStatus("🗑️ Đã xoá CSS tuỳ chỉnh", "#f59e0b")
    }
    
    function resetCustomCss(){
      const defaultCss = ""
      document.getElementById("customCssInput").value = defaultCss
      localStorage.setItem(getCustomCssKey(), defaultCss)
      const styleEl = document.getElementById("custom-user-css")
      if(styleEl) styleEl.remove()
      const stylePreview = document.getElementById("custom-user-css-preview")
      if(stylePreview) stylePreview.remove()
      showCssStatus("🔄 Đã khôi phục mặc định", "#10b981")
    }
    
    function showCssStatus(msg, color){
      const statusEl = document.getElementById("customCssStatus")
      if(statusEl){
        statusEl.innerHTML = msg
        statusEl.style.color = color
        setTimeout(() => { statusEl.innerHTML = "" }, 3000)
      }
    }
    
    const CSS_SNIPPETS = {
      neon: `.navbar { box-shadow: 0 0 20px rgba(99,102,241,0.5) !important; }
.navbar button { border: 2px solid #6366f1 !important; }
.brand-script { text-shadow: 0 0 10px #6366f1 !important; }`,
      glass: `.navbar { backdrop-filter: blur(30px) !important; background: rgba(255,255,255,0.3) !important; }
.modal-box { backdrop-filter: blur(20px) !important; }`,
      minimal: `* { border-radius: 0px !important; }
.navbar { padding: 5px 10px !important; }
.navbar button { padding: 5px 8px !important; font-size: 12px !important; }`,
      colorful: `.navbar { background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3) !important; }
.navbar button { background: white !important; }`
    }
    
    function insertSnippet(name){
      const snippet = CSS_SNIPPETS[name]
      if(snippet){
        document.getElementById("customCssInput").value = snippet
        showCssStatus("💡 Đã chèn snippet: " + name, "#6366f1")
      }
    }
    
    function loadCustomCssOnStartup(){
      const savedCss = getCustomCss()
      if(savedCss){
        document.getElementById("customCssInput").value = savedCss
        applyCustomCss()
      }
    }

    async function sendGeminiAiMessage(){
      if(geminiAiState.loading) return
      const input = document.getElementById("geminiAiInput")
      const prompt = String(input?.value || "").trim()
      if(!prompt){
        alert("Bạn chưa nhập nội dung cho Gemini AI.")
        return
      }

      pushGeminiAiMessage("user", prompt)
      input.value = ""
      setGeminiAiLoading(true)

      try{
        const commandApplied =
          (await executeVietnameseCommand(prompt)) ||
          (await executeAiControlCommand(prompt, { source: "gemini" }))

        if(commandApplied){
          pushGeminiAiMessage("assistant", "Đã thực thi lệnh điều khiển app theo yêu cầu.")
          setGeminiAiLoading(false)
          return
        }

        const apiKey = String(appSettings.ai.geminiApiKey || "").trim()
        if(!apiKey){
          pushGeminiAiMessage("assistant", "Chưa có Gemini API Key. Vào Cài đặt → nhập Google Gemini API Key.")
          setGeminiAiLoading(false)
          return
        }

        const modelSelect = document.getElementById("geminiModel")
        const model = modelSelect?.value || "gemini-2.0-flash"
        
        setGeminiAiMeta(`Đang chat với Gemini ${model}...`)
        
        const systemPrompt = `Bạn là AI assistant điều khiển app Comet Ultra. Bạn có quyền điều khiển đầy đủ app bao gồm:
- Mở/điều khiển web: mở URL, quay lại, tiến tới, tải lại, zoom
- ADB Android: adb devices, adb shell, mirror usb/wifi, camera, chụp ảnh
- Lens OCR/AI: chụp màn hình, nhận dạng văn bản, phân tích hình ảnh
- Terminal: chạy lệnh shell
- Cài đặt: cài adb, cài scrcpy, kiểm tra tools
- Web: tìm kiếm, dịch web, thay đổi ngôn ngữ

Khi user yêu cầu thực hiện hành động, hãy thực hiện lệnh trực tiếp. Nếu cần xác nhận, hãy hỏi user.`

        const res = await ipcRenderer.invoke("gemini:chat", {
          apiKey,
          model,
          systemPrompt,
          prompt,
          messages: geminiAiState.messages.slice(-10)
        })
        
        if(!res || !res.ok){
          pushGeminiAiMessage("assistant", res?.error || "Lỗi gọi Gemini API.")
          return
        }
        pushGeminiAiMessage("assistant", String(res.reply || ""))
        setGeminiAiMeta("Gemini AI sẵn sàng.")
      }catch(e){
        pushGeminiAiMessage("assistant", "Lỗi kết nối: " + e.message)
      }finally{
        setGeminiAiLoading(false)
      }
    }

    function getToolSourceUrl(tool){
      const directUrl = normalizeToolUrl(tool?.url || "")
      if(!directUrl){
        return ""
      }
      if(tool?.id === "agentgpt"){
        return directUrl
      }
      return directUrl
    }

    function extractHostFromUrl(rawUrl){
      try{
        const parsed = new URL(String(rawUrl || ""))
        if(parsed.hostname.includes("translate.google")){
          const target = extractTranslateTargetUrl(rawUrl)
          if(target){
            return extractHostFromUrl(target)
          }
        }
        return parsed.hostname.replace(/^www\./i, "")
      }catch(_e){
        return ""
      }
    }

    function detectCurrentAiToolIndex(enabledTools){
      if(activeAiToolId){
        const activeIndex = enabledTools.findIndex((tool)=>tool.id === activeAiToolId)
        if(activeIndex >= 0){
          return activeIndex
        }
      }
      const web = getActiveWebview()
      const currentUrl = web?.getURL?.() || web?.src || ""
      const currentHost = extractHostFromUrl(currentUrl)
      if(!currentHost){
        return -1
      }

      return enabledTools.findIndex((tool)=>{
        const toolHost = extractHostFromUrl(getToolSourceUrl(tool))
        if(!toolHost){
          return false
        }
        return currentHost === toolHost || currentHost.endsWith(`.${toolHost}`) || toolHost.endsWith(`.${currentHost}`)
      })
    }

    function switchAiTool(step=1, notify=true){
      const enabledTools = getEnabledTools()
      if(!enabledTools.length){
        if(notify){
          alert("Chưa có công cụ AI nào đang bật.")
        }
        return false
      }

      const currentIndex = detectCurrentAiToolIndex(enabledTools)
      const baseIndex = currentIndex >= 0 ? currentIndex : -1
      const offset = Number.isFinite(step) ? Math.trunc(step) : 1
      const nextIndex = ((baseIndex + offset) % enabledTools.length + enabledTools.length) % enabledTools.length
      const nextTool = enabledTools[nextIndex]

      const opened = openAiToolById(nextTool.id)
      if(opened && notify){
        const switchBtn = document.getElementById("aiSwitchBtn")
        if(switchBtn){
          switchBtn.textContent = `AI: ${nextTool.name}`
          setTimeout(()=>{
            switchBtn.textContent = "AI Switch"
          }, 1200)
        }
      }
      return opened
    }

    function updateMicButton(){
      const buttons = ["micCommandBtn", "settingMicBtn"]
        .map((id)=>document.getElementById(id))
        .filter(Boolean)
      if(!buttons.length){
        return
      }
      buttons.forEach((btn)=>{
        if(isVoiceListening){
          btn.textContent = "Mic: ON"
          btn.classList.add("scan-btn")
        }else{
          btn.textContent = "Mic"
          btn.classList.remove("scan-btn")
        }
      })
    }

    function getSpeechRecognitionCtor(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null
    }

    function stopVoiceCommand(){
      if(voiceRecognition){
        try{
          voiceRecognition.stop()
        }catch(_e){
          // Ignore stop errors.
        }
      }
      isVoiceListening = false
      updateMicButton()
    }

    async function executeVoiceTranscript(transcript){
      const command = String(transcript || "").trim()
      if(!command){
        return
      }

      updateUrlInput(command)
      if(await executeVietnameseCommand(command)){
        return
      }
      if(await executeAiControlCommand(command, { notify: true })){
        return
      }
      navigateTo(normalizeNavigationInput(command))
    }

    async function toggleVoiceCommand(){
      if(isVoiceListening){
        stopVoiceCommand()
        return
      }

      const SpeechCtor = getSpeechRecognitionCtor()
      if(!SpeechCtor){
        alert("Trình duyệt trong app chưa hỗ trợ nhận diện giọng nói.")
        return
      }

      if(!voiceRecognition){
        voiceRecognition = new SpeechCtor()
        voiceRecognition.lang = "vi-VN"
        voiceRecognition.interimResults = false
        voiceRecognition.continuous = false
        voiceRecognition.maxAlternatives = 1

        voiceRecognition.onstart = ()=>{
          isVoiceListening = true
          updateMicButton()
        }

        voiceRecognition.onend = ()=>{
          isVoiceListening = false
          updateMicButton()
        }

        voiceRecognition.onerror = (event)=>{
          isVoiceListening = false
          updateMicButton()
          const code = String(event?.error || "")
          if(code && code !== "no-speech"){
            alert(`Mic lỗi: ${code}`)
          }
        }

        voiceRecognition.onresult = async (event)=>{
          const transcript = String(event?.results?.[0]?.[0]?.transcript || "").trim()
          await executeVoiceTranscript(transcript)
        }
      }

      try{
        voiceRecognition.start()
      }catch(_e){
        alert("Không thể bật micro. Hãy thử lại.")
      }
    }

    async function applyVietnameseForAgentGPT(web, notify=false){
      const activeWeb = web || getActiveWebview()
      const currentUrl = activeWeb?.getURL?.() || activeWeb?.src || ""
      if(!activeWeb || !isAgentGPTUrl(currentUrl)){
        if(notify){
          alert("Hãy mở AgentGPT trước rồi bật tiếng Việt.")
        }
        return false
      }

      const viScript = `
        (() => {
          const dictionary = ${JSON.stringify(AGENT_GPT_VI_DICTIONARY)}
          const replaceText = (value) => {
            let output = String(value || "")
            Object.keys(dictionary).forEach((key) => {
              if (output.includes(key)) {
                output = output.split(key).join(dictionary[key])
              }
            })
            return output
          }

          const walk = (node) => {
            if (!node) return
            if (node.nodeType === Node.TEXT_NODE) {
              const original = node.textContent || ""
              const next = replaceText(original)
              if (next !== original) {
                node.textContent = next
              }
              return
            }
            if (node.nodeType !== Node.ELEMENT_NODE) return

            ;["placeholder", "title", "aria-label"].forEach((attr) => {
              const val = node.getAttribute && node.getAttribute(attr)
              if (!val) return
              const next = replaceText(val)
              if (next !== val) {
                node.setAttribute(attr, next)
              }
            })

            node.childNodes.forEach(walk)
          }

          document.documentElement.setAttribute("lang", "vi")
          if (document.body) {
            walk(document.body)
          }

          if (window.__agentgptViObserver) {
            window.__agentgptViObserver.disconnect()
          }
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === "characterData") {
                walk(mutation.target)
              } else {
                mutation.addedNodes.forEach(walk)
              }
            })
          })
          if (document.body) {
            observer.observe(document.body, { childList: true, subtree: true, characterData: true })
          }
          window.__agentgptViObserver = observer
          return "ok"
        })()
      `

      try{
        await activeWeb.executeJavaScript(viScript, true)
        if(notify){
          alert("Đã bật Việt hóa cho giao diện AgentGPT trong app.")
        }
        return true
      }catch(_e){
        if(notify){
          alert("Không thể bật Việt hóa AgentGPT ở trang hiện tại.")
        }
        return false
      }
    }

    function scheduleAgentGPTEnhancement(web){
      if(!web){
        return
      }
      setTimeout(()=>{ applyVietnameseForAgentGPT(web) }, 120)
      setTimeout(()=>{ applyVietnameseForAgentGPT(web) }, 850)
    }

    function extractFirstJsonObject(rawText){
      const text = String(rawText || "").trim()
      if(!text){
        return null
      }
      try{
        return JSON.parse(text)
      }catch(_e){
        // Continue with slice parse.
      }
      const start = text.indexOf("{")
      const end = text.lastIndexOf("}")
      if(start === -1 || end === -1 || end <= start){
        return null
      }
      try{
        return JSON.parse(text.slice(start, end + 1))
      }catch(_e){
        return null
      }
    }

    function parseAiAction(rawText){
      const parsed = extractFirstJsonObject(rawText)
      if(!parsed || typeof parsed !== "object"){
        return null
      }
      const action = normalizeVietnameseCommand(parsed.action || "")
      if(!action){
        return null
      }
      return {
        action,
        target: String(parsed.target || "").trim(),
        value: String(parsed.value || "").trim(),
        toolId: String(parsed.toolId || "").trim(),
        message: String(parsed.message || "").trim()
      }
    }

    async function applyAiAction(actionData){
      const action = normalizeVietnameseCommand(actionData?.action || "")
      const target = String(actionData?.target || "").trim()
      const value = String(actionData?.value || "").trim()
      const toolId = String(actionData?.toolId || "").trim()
      const mergedValue = value || target

      if(action === "none"){
        return false
      }
      if(action === "open_tool"){
        const token = normalizeVietnameseCommand(toolId || mergedValue)
        if(!token){
          return false
        }
        const byId = appSettings.ai.tools.find((tool)=>normalizeVietnameseCommand(tool.id) === token)
        if(byId){
          return openAiToolById(byId.id)
        }
        const byName = appSettings.ai.tools.find((tool)=>normalizeVietnameseCommand(tool.name) === token)
        if(byName){
          return openAiToolById(byName.id)
        }
        return false
      }
      if(action === "switch_ai"){
        const direction = normalizeVietnameseCommand(mergedValue)
        const step = direction.includes("prev") || direction.includes("truoc") || direction.includes("lui") ? -1 : 1
        return switchAiTool(step, true)
      }
      if(action === "navigate_url"){
        if(!mergedValue){
          return false
        }
        navigateTo(normalizeNavigationInput(mergedValue))
        return true
      }
      if(action === "search_web"){
        if(!mergedValue){
          return false
        }
        navigateTo(`https://www.google.com/search?q=${encodeURIComponent(mergedValue)}`)
        return true
      }
      if(action === "show_kqxs"){
        showHistoryPanel()
        return true
      }
      if(action === "show_browser"){
        showBrowserPanel()
        return true
      }
      if(action === "open_settings"){
        openSettingsModal()
        return true
      }
      if(action === "open_ai_settings"){
        openSettingsModal()
        switchSettingsTab("ai")
        return true
      }
      if(action === "back"){
        goBack()
        return true
      }
      if(action === "forward"){
        goForward()
        return true
      }
      if(action === "reload"){
        reload()
        return true
      }
      if(action === "theme_dark"){
        setThemeDark(true, true)
        return true
      }
      if(action === "theme_light"){
        setThemeDark(false, true)
        return true
      }
      if(action === "theme_toggle"){
        toggleTheme()
        return true
      }
      if(action === "lens_print"){
        printLatestTicket()
        return true
      }
      if(action === "lens_ocr"){
        startLensOcr()
        return true
      }
      if(action === "lens_ai"){
        startLensAi()
        return true
      }
      if(action === "zoom_in"){
        zoomStep(10)
        return true
      }
      if(action === "zoom_out"){
        zoomStep(-10)
        return true
      }
      if(action === "zoom_set"){
        const zoomValue = Number(mergedValue)
        if(Number.isFinite(zoomValue)){
          document.getElementById("zoomPercent").value = String(Math.max(30, Math.min(300, Math.round(zoomValue))))
          applyZoom()
          return true
        }
        return false
      }
      if(action === "run_command"){
        if(!mergedValue){
          return false
        }
        return executeVietnameseCommand(mergedValue)
      }
      return false
    }

    async function executeAiControlCommand(raw, options={}){
      const command = String(raw || "").trim()
      if(!command){
        return false
      }

      const source = String(options?.source || "input")
      const web = getActiveWebview()
      const currentUrl = web?.getURL?.() || web?.src || ""
      const payload = {
        command,
        source,
        currentUrl,
        availableTools: getEnabledTools().map((tool)=>({
          id: tool.id,
          name: tool.name,
          url: normalizeToolUrl(tool.url)
        }))
      }

      try{
        const rawRes = await ipcRenderer.invoke("ask-ai", payload)
        const parsed = parseAiAction(rawRes)
        if(!parsed){
          return false
        }
        return Boolean(await applyAiAction(parsed))
      }catch(_e){
        return false
      }
    }

    async function executeVietnameseCommand(raw){
      const command = String(raw || "").trim()
      if(!command){
        return false
      }

      const normalized = normalizeVietnameseCommand(command)
      if(!normalized){
        return false
      }

      if(["cai dat","mo cai dat","settings","setting"].includes(normalized)){
        openSettingsModal()
        return true
      }
      if(["cong cu ai","mo cong cu ai"].includes(normalized)){
        openSettingsModal()
        switchSettingsTab("ai")
        return true
      }
      if(["agentgpt","mo agentgpt","mo agent gpt","mo ai"].includes(normalized)){
        openAgentGPT()
        return true
      }
      if(["chatgpt","chat gpt","mo chatgpt","mo chat gpt","openai","mo openai","mo open ai"].includes(normalized)){
        openChatGPT()
        return true
      }
      if(["lotoai","mo lotoai","mo loto ai","loto ai"].includes(normalized)){
        openLotoAI()
        return true
      }
      if(["llama2","llama 2","mo llama2","mo llama 2","llama2 7b"].includes(normalized)){
        openAiToolById("ollama_llama2_7b")
        return true
      }
      if(["alpaca","mo alpaca","alpaca 7b"].includes(normalized)){
        openAiToolById("ollama_alpaca_7b")
        return true
      }
      if(["vicuna","mo vicuna","vicuna 7b"].includes(normalized)){
        openAiToolById("ollama_vicuna_7b")
        return true
      }
      if(["mistral mini","mo mistral","mistral"].includes(normalized)){
        openAiToolById("ollama_mistral_mini")
        return true
      }
      if(["tinytext","tiny","nanogpt","tinyllama"].includes(normalized)){
        openAiToolById("ollama_tiny")
        return true
      }
      if(["gptq","gptq 4bit","4bit"].includes(normalized)){
        openAiToolById("ollama_gptq_4bit")
        return true
      }
      if(["pull model","pull ollama","tai model","tai model local"].includes(normalized)){
        openLotoAI()
        pullSelectedLotoAiModel()
        return true
      }
      if(["pull all","pull tat ca","tai tat ca model","tai full model"].includes(normalized)){
        openLotoAI()
        pullAllLotoAiPresets()
        return true
      }
      if(["ai switch","ai swich","switch ai","doi ai","chuyen ai","doi cong cu ai"].includes(normalized)){
        switchAiTool()
        return true
      }
      if(["mic","micro","bat mic","tat mic","lenh giong noi"].includes(normalized)){
        toggleVoiceCommand()
        return true
      }
      if(["quay lai","back","lui"].includes(normalized)){
        goBack()
        return true
      }
      if(["tien toi","tiep","forward"].includes(normalized)){
        goForward()
        return true
      }
      if(["tai lai","reload","f5"].includes(normalized)){
        reload()
        return true
      }
      if(["dich web","dich trang","translate web","translate page"].includes(normalized)){
        await translateCurrentWeb()
        return true
      }
      if(["ngon ngu goc","ve ngon ngu goc","hien thi goc","trang goc"].includes(normalized)){
        await restoreOriginalWebLanguage()
        return true
      }
      if(["cai adb","cai platform tools","cai android platform tools"].includes(normalized)){
        await installAndroidPlatformTools()
        return true
      }
      if(["adb devices","kiem tra adb","adb terminal"].includes(normalized)){
        await runAdbDevicesQuick()
        return true
      }
      if(["adb wifi","ket noi adb wifi","wifi adb"].includes(normalized)){
        await connectAdbWifi()
        return true
      }
      if(["mirror usb","adb mirror usb","phan chieu usb"].includes(normalized)){
        await startAdbMirrorUsb()
        return true
      }
      if(["mirror wifi","adb mirror wifi","phan chieu wifi"].includes(normalized)){
        await startAdbMirrorWifi()
        return true
      }
      if(["camera usb","cam usb","mo camera usb","mo may anh usb"].includes(normalized)){
        await openAndroidCameraUsb()
        return true
      }
      if(["camera wifi","cam wifi","mo camera wifi","mo may anh wifi"].includes(normalized)){
        await openAndroidCameraWifi()
        return true
      }
      if(["chup usb","chup anh usb","shutter usb"].includes(normalized)){
        await captureAndroidPhotoUsb()
        return true
      }
      if(["chup wifi","chup anh wifi","shutter wifi"].includes(normalized)){
        await captureAndroidPhotoWifi()
        return true
      }
      if(["mo kqxs","kqxs","xo so"].includes(normalized)){
        showHistoryPanel()
        return true
      }
      if(["ve browser","mo browser","dong kqxs","ve trinh duyet","mo trinh duyet"].includes(normalized)){
        showBrowserPanel()
        return true
      }
      if(["che do toi","dark mode","toi"].includes(normalized)){
        setThemeDark(true, true)
        return true
      }
      if(["che do sang","light mode","sang"].includes(normalized)){
        setThemeDark(false, true)
        return true
      }
      if(["bat dich web","bat dich tieng viet","tu dong dich","dich tu dong"].includes(normalized)){
        await translateCurrentWeb()
        return true
      }
      if(["tat dich web","tat dich tieng viet","tat tu dong dich"].includes(normalized)){
        await restoreOriginalWebLanguage()
        return true
      }
      if(["doi giao dien","doi theme"].includes(normalized)){
        toggleTheme()
        return true
      }
      if(["in","in ve","in vung"].includes(normalized)){
        printLatestTicket()
        return true
      }
      if(["lens ocr","ocr","quet ocr","lens+ocr"].includes(normalized)){
        startLensOcr()
        return true
      }
      if(["lens ai","quet ai","lens+ai"].includes(normalized)){
        startLensAi()
        return true
      }
      if(["tieng viet","viet hoa","viet hoa agentgpt","agentgpt tieng viet","bat tieng viet"].includes(normalized)){
        await applyVietnameseForAgentGPT(getActiveWebview(), true)
        return true
      }
      if(["tro giup","help","lenh","huong dan"].includes(normalized)){
        alert("Lệnh hỗ trợ: mở AgentGPT/ChatGPT/LotoAI, llama2, alpaca, vicuna, mistral, tinytext, gptq, pull model, pull all, AI Switch, mic, lens ocr, lens ai, dịch web, ngôn ngữ gốc, cài adb, adb devices, ADB WiFi, mirror usb/wifi, camera usb/wifi, chụp usb/wifi, mở cài đặt, mở công cụ AI, quay lại, tiến tới, tải lại, mở KQXS, về trình duyệt, chế độ tối, chế độ sáng, tiếng việt, zoom 120, mở google.com, tìm <từ khóa>.")
        return true
      }

      const zoomMatch = normalized.match(/(?:zoom|phong to|co trang)\s*(\d{2,3})/)
      if(zoomMatch){
        document.getElementById("zoomPercent").value = zoomMatch[1]
        applyZoom()
        return true
      }
      if(["phong to","zoom in"].includes(normalized)){
        zoomStep(10)
        return true
      }
      if(["thu nho","zoom out"].includes(normalized)){
        zoomStep(-10)
        return true
      }

      if(normalized.startsWith("tim ")){
        const query = command.slice(4).trim()
        if(query){
          navigateTo(`https://www.google.com/search?q=${encodeURIComponent(query)}`)
          return true
        }
      }

      if(normalized.startsWith("mo ")){
        const target = command.slice(3).trim()
        if(target){
          const normalizedTarget = normalizeVietnameseCommand(target)
          const matchedTool = getEnabledTools().find((tool)=>normalizeVietnameseCommand(tool.name) === normalizedTarget)
          if(matchedTool){
            openAiToolById(matchedTool.id)
            return true
          }
          navigateTo(normalizeNavigationInput(target))
          return true
        }
      }

      return false
    }

    async function openUrl(){
        const raw = document.getElementById("url").value
        if(await executeVietnameseCommand(raw)){
          return
        }
        if(await executeAiControlCommand(raw, { source: "input" })){
          return
        }
        const url = normalizeNavigationInput(raw)
        navigateTo(url)
    }

    function goBack(){getActiveWebview()?.goBack()}
    function goForward(){getActiveWebview()?.goForward()}
    function reload(){getActiveWebview()?.reload()}
    
    function scrollPageUp(){
      const webview = getActiveWebview()
      if(webview){
        webview.executeJavaScript(`
          (function(){
            window.scrollBy(0, -window.innerHeight * 0.8);
            return true;
          })();
        `)
      }
    }
    
    function scrollPageDown(){
      const webview = getActiveWebview()
      if(webview){
        webview.executeJavaScript(`
          (function(){
            window.scrollBy(0, window.innerHeight * 0.8);
            return true;
          })();
        `)
      }
    }
    
    function scrollToTop(){
      const webview = getActiveWebview()
      if(webview){
        webview.executeJavaScript(`window.scrollTo(0, 0);`)
      }
    }
    
    function scrollToBottom(){
      const webview = getActiveWebview()
      if(webview){
        webview.executeJavaScript(`window.scrollTo(0, document.body.scrollHeight);`)
      }
    }
    
    function scrollSettingsUp(){
      const box = document.getElementById("settingsModalBox")
      if(box){
        box.scrollBy({top: -300, behavior: "smooth"})
      }
    }
    
    function scrollSettingsDown(){
      const box = document.getElementById("settingsModalBox")
      if(box){
        box.scrollBy({top: 300, behavior: "smooth"})
      }
    }
    
    function handleSettingsWheel(e){
      const box = document.getElementById("settingsModalBox")
      if(box){
        e.preventDefault()
        box.scrollBy({top: e.deltaY, behavior: "smooth"})
      }
    }
    
    function toggleTheme(){
      const toDark = !document.documentElement.classList.contains("dark")
      setThemeDark(toDark, true)
    }
    function getActiveWebview(){return document.getElementById("mainWebview")}

    function attachWebviewEvents(web){
      if(!web || web.dataset.eventsBound === "1"){
        return
      }

      web.dataset.eventsBound = "1"
      web.addEventListener("dom-ready", ()=>{
        applyZoom()
        const currentUrl = web.getURL?.() || web.src || ""
        updateUrlInput(getDisplayUrl(currentUrl))
        ensureVietnameseTranslation(web, currentUrl)
        scheduleAgentGPTEnhancement(web)
      })
      web.addEventListener("did-stop-loading", ()=>{
        scheduleAgentGPTEnhancement(web)
      })
      web.addEventListener("did-navigate", (event)=>{
        const currentUrl = event?.url || web.getURL?.() || web.src || ""
        updateUrlInput(getDisplayUrl(currentUrl))
        ensureVietnameseTranslation(web, currentUrl)
        scheduleAgentGPTEnhancement(web)
      })
      web.addEventListener("did-navigate-in-page", (event)=>{
        const currentUrl = event?.url || web.getURL?.() || web.src || ""
        updateUrlInput(getDisplayUrl(currentUrl))
        ensureVietnameseTranslation(web, currentUrl)
        scheduleAgentGPTEnhancement(web)
      })
    }

    function applyZoom(){
      const web = getActiveWebview()
      if(!web){
        return
      }
      if(typeof web.setZoomFactor !== "function"){
        return
      }
      const input = document.getElementById("zoomPercent")
      let percent = Number(input.value || 100)
      if(!Number.isFinite(percent)) percent = 100
      percent = Math.max(30, Math.min(300, percent))
      input.value = String(percent)
      web.setZoomFactor(percent / 100)
    }

    function zoomStep(step){
      const input = document.getElementById("zoomPercent")
      const current = Number(input.value || 100)
      input.value = String((Number.isFinite(current) ? current : 100) + step)
      applyZoom()
    }
    function toggleHistoryPanel(){
      const panel = document.getElementById("historyWrap")
      const main = document.querySelector(".main")
      const btn = document.getElementById("toggleHistoryBtn")
      const showKQXS = panel.classList.contains("hidden")

      if(showKQXS){
        panel.classList.remove("hidden")
        panel.classList.add("full-view")
        main.classList.add("hidden")
        btn.textContent = "Về trình duyệt"
        loadKQXSData()
      }else{
        panel.classList.add("hidden")
        panel.classList.remove("full-view")
        main.classList.remove("hidden")
        btn.textContent = "KQXS"
      }
    }

    function escapeHtml(text){
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;")
    }

    const STATION_DISPLAY_MAP = {
      "an giang": "An Giang",
      "bac lieu": "Bạc Liêu",
      "ben tre": "Bến Tre",
      "binh duong": "Bình Dương",
      "binh phuoc": "Bình Phước",
      "binh thuan": "Bình Thuận",
      "ca mau": "Cà Mau",
      "can tho": "Cần Thơ",
      "da lat": "Đà Lạt",
      "dong nai": "Đồng Nai",
      "dong thap": "Đồng Tháp",
      "hau giang": "Hậu Giang",
      "kien giang": "Kiên Giang",
      "long an": "Long An",
      "mien nam": "Miền Nam",
      "mien trung": "Miền Trung",
      "mien bac": "Miền Bắc",
      "soc trang": "Sóc Trăng",
      "tay ninh": "Tây Ninh",
      "tien giang": "Tiền Giang",
      "tp hcm": "TP HCM",
      "tphcm": "TP HCM",
      "ho chi minh": "TP HCM",
      "tra vinh": "Trà Vinh",
      "vinh long": "Vĩnh Long",
      "vung tau": "Vũng Tàu",
      "ba ria vung tau": "Vũng Tàu",
      "brvt": "Vũng Tàu"
    }

    function normalizeStationToken(text){
      return String(text || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/đ/g, "d")
        .replace(/Đ/g, "d")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, " ")
        .replace(/\s+/g, " ")
        .trim()
    }

    function toTitleWords(text){
      return String(text || "")
        .split(/\s+/g)
        .filter(Boolean)
        .map((word)=>word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ")
    }

    function displayStationName(station){
      const raw = String(station || "").trim()
      if(!raw){
        return "Chưa rõ đài"
      }
      const normalized = normalizeStationToken(raw)
      if(normalized === "thu cong" || normalized === "khong ro dai"){
        return "Chưa rõ đài"
      }
      if(STATION_DISPLAY_MAP[normalized]){
        return STATION_DISPLAY_MAP[normalized]
      }

      const parts = raw
        .split(/\s*[|,;]\s*|\s*\.\s*/g)
        .map((item)=>item.trim())
        .filter(Boolean)

      if(!parts.length){
        return raw
      }

      const formatted = parts.map((part)=>{
        const key = normalizeStationToken(part)
        if(STATION_DISPLAY_MAP[key]){
          return STATION_DISPLAY_MAP[key]
        }
        if(part === part.toLowerCase()){
          return toTitleWords(part)
        }
        return part
      })

      return formatted.join(" | ")
    }

    async function collectStationHint(){
      const web = getActiveWebview()
      if(!web){
        return {}
      }

      try{
        const hint = await web.executeJavaScript(`
          (() => ({
            title: document.title || "",
            url: location.href || "",
            hostname: location.hostname || ""
          }))()
        `)
        return hint && typeof hint === "object" ? hint : {}
      }catch(e){
        return {}
      }
    }

    function formatCopiedLayout(rawText){
      return `<pre class="copy-raw">${escapeHtml(rawText || "")}</pre>`
    }

    function formatTicketLayout(item, index, forPrint=false){
      const ticket = item?.ticket || {}
      const rows = Array.isArray(ticket.prizes) ? ticket.prizes : []
      if(!rows.length){
        return formatCopiedLayout(item?.rawText || "")
      }

      const station = displayStationName(ticket.station || "Chưa rõ đài")
      const drawDate = ticket.drawDate || ""
      const bodyRows = rows.map((row)=>{
        const values = Array.isArray(row.numbers) ? row.numbers.join("  ") : ""
        return `<tr><td>${escapeHtml(row.label || row.key || "")}</td><td>${escapeHtml(values)}</td></tr>`
      }).join("")

      return `
        <div class="ticket-card">
          <div class="ticket-head">Vé dò KQXS</div>
          ${forPrint ? "" : `<div class="ticket-tools"><button class="print-ticket-btn" onclick="printTicketByIndex(${index})">IN</button></div>`}
          <div class="ticket-meta">Đài: ${escapeHtml(station)}${drawDate ? ` | Ngày: ${escapeHtml(drawDate)}` : ""}</div>
          <table class="ticket-table">
            <thead><tr><th>Giải</th><th>Kết quả</th></tr></thead>
            <tbody>${bodyRows}</tbody>
          </table>
        </div>
      `
    }

    function openManualScanModal(){
      document.getElementById("manualScanModal").classList.add("show")
      const input = document.getElementById("manualScanInput")
      input.focus()
    }

    function closeManualScanModal(){
      document.getElementById("manualScanModal").classList.remove("show")
      document.getElementById("manualScanInput").value = ""
    }

    async function pasteFromClipboard(){
      try{
        const text = await navigator.clipboard.readText()
        const textarea = document.getElementById("manualScanInput")
        textarea.value = text
        textarea.focus()
      }catch(e){
        alert("Không thể đọc clipboard: " + e.message)
      }
    }

    async function pasteImageFromClipboard(){
      try{
        const items = await navigator.clipboard.read()
        for(const item of items){
          for(const type of item.types){
            if(type.startsWith("image/")){
              const blob = await item.getType(type)
              await processKqxsImage(blob)
              return
            }
          }
        }
        alert("Không có ảnh trong clipboard.")
      }catch(e){
        alert("Không thể dán ảnh: " + e.message + "\nVui lòng chụp màn hình và dán (Ctrl+V).")
      }
    }

    async function openFileForKqxs(){
      try{
        const res = await ipcRenderer.invoke("dialog:open-file", {
          filters: [
            { name: "Images", extensions: ["png", "jpg", "jpeg", "gif", "bmp", "webp"] },
            { name: "Text", extensions: ["txt", "csv"] },
            { name: "All Files", extensions: ["*"] }
          ]
        })
        
        if(res?.canceled || !res?.filePaths?.length){
          return
        }
        
        const filePath = res.filePaths[0]
        const ext = filePath.split(".").pop().toLowerCase()
        
        if(["png", "jpg", "jpeg", "gif", "bmp", "webp"].includes(ext)){
          const fileRes = await ipcRenderer.invoke("fs:read-file", { path: filePath })
          if(!fileRes?.ok){
            alert("Không đọc được file: " + fileRes?.error)
            return
          }
          const data = new Uint8Array(fileRes.data)
          await processKqxsImage(new Blob([data], { type: `image/${ext}` }))
        }else{
          const textRes = await ipcRenderer.invoke("fs:read-file-text", { path: filePath })
          if(!textRes?.ok){
            alert("Không đọc được file: " + textRes?.error)
            return
          }
          document.getElementById("manualScanInput").value = textRes.text
        }
      }catch(e){
        alert("Lỗi mở file: " + e.message)
      }
    }

    function clearManualScanInput(){
      document.getElementById("manualScanInput").value = ""
    }

    function openLensResultModal({ title, meta, text }){
      lensResultState = {
        title: String(title || "Kết quả Lens"),
        meta: String(meta || ""),
        text: String(text || "")
      }

      document.getElementById("lensResultTitle").textContent = lensResultState.title
      document.getElementById("lensResultMeta").textContent = lensResultState.meta
      document.getElementById("lensResultInput").value = lensResultState.text
      document.getElementById("lensResultModal").classList.add("show")
    }

    function closeLensResultModal(){
      document.getElementById("lensResultModal").classList.remove("show")
    }

    function adjustLensFontSize(delta){
      lensEditorState.fontSize = Math.max(10, Math.min(32, lensEditorState.fontSize + delta))
      const input = document.getElementById("lensResultInput")
      input.style.fontSize = `${lensEditorState.fontSize}px`
      document.getElementById("lensFontSizeLabel").textContent = `${lensEditorState.fontSize}px`
    }

    function toggleLensFullView(){
      lensEditorState.fullscreen = !lensEditorState.fullscreen
      const input = document.getElementById("lensResultInput")
      const toolbar = document.querySelector(".lens-editor-toolbar")
      if(lensEditorState.fullscreen){
        input.classList.add("lens-fullscreen")
        toolbar.classList.add("active")
      }else{
        input.classList.remove("lens-fullscreen")
        toolbar.classList.remove("active")
      }
    }

    function toggleLensEditMode(){
      lensEditorState.editMode = !lensEditorState.editMode
      const input = document.getElementById("lensResultInput")
      if(lensEditorState.editMode){
        input.classList.add("lens-edit-mode")
        input.focus()
      }else{
        input.classList.remove("lens-edit-mode")
      }
    }

    async function analyzeLensWithAI(){
      const text = String(document.getElementById("lensResultInput").value || "").trim()
      if(!text){
        alert("Không có nội dung để phân tích")
        return
      }

      const modal = document.getElementById("lensResultModal")
      modal.classList.remove("show")
      
      setTimeout(() => {
        openLotoAi()
        setTimeout(() => {
          const input = document.getElementById("lotoAiInput")
          if(input){
            input.value = `Phân tích KQXS sau đây:\n${text}\n\nHãy phân tích các con số may mắn, tần suất xuất hiện, và đưa ra dự đoán.`
            input.focus()
          }
        }, 500)
      }, 300)
    }

    async function copyLensResultText(){
      const text = String(document.getElementById("lensResultInput").value || "").trim()
      if(!text){
        alert("Không có nội dung để chép")
        return
      }
      try{
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text)
        }else{
          const input = document.getElementById("lensResultInput")
          input.focus()
          input.select()
          document.execCommand("copy")
        }
        alert("Đã chép nội dung lens.")
      }catch(_e){
        alert("Không thể chép nội dung lens")
      }
    }

    async function saveLensResultToHistory(){
      const text = String(document.getElementById("lensResultInput").value || "").trim()
      if(!text){
        alert("Không có nội dung để lưu")
        return
      }

      try{
        const stationHint = await collectStationHint()
        const res = await ipcRenderer.invoke("kqxs:save-manual-copy", { text, stationHint })
        if(!res || !res.ok){
          alert(res?.error || "Lưu nội dung lens thất bại")
          return
        }
        applySavedResult(res)
        alert("Đã lưu vào lịch sử KQXS.")
      }catch(_e){
        alert("Lưu nội dung lens thất bại")
      }
    }

    async function saveManualScanText(){
      const rawText = document.getElementById("manualScanInput").value
      const text = String(rawText || "").trim()
      if(!text){
        alert("Bạn chưa nhập nội dung để quét")
        return
      }

      try{
        const stationHint = await collectStationHint()
        const res = await ipcRenderer.invoke("kqxs:save-manual-copy", { text: rawText, stationHint })
        if(!res || !res.ok){
          alert(res?.error || "Lưu nội dung thất bại")
          return
        }
        applySavedResult(res)
        closeManualScanModal()
      }catch(e){
        alert("Lưu nội dung thất bại")
      }
    }

    function applySavedResult(res){
      renderKQXSHistory(res?.history || [])
      renderTopStats(res?.topByStation || [])
    }

    async function printLatestTicket(){
      if(document.querySelector(".main").classList.contains("hidden")){
        toggleHistoryPanel()
      }
      startLensRegionMode("print")
    }

    async function startLensOcr(){
      if(document.querySelector(".main").classList.contains("hidden")){
        toggleHistoryPanel()
      }
      startLensRegionMode("ocr")
    }

    async function startLensAi(){
      if(document.querySelector(".main").classList.contains("hidden")){
        toggleHistoryPanel()
      }
      startLensRegionMode("ai")
    }

    function getLensModeTip(mode){
      if(mode === "ocr"){
        return "Lens+OCR: Kéo khoanh vùng để nhận diện chữ trong ảnh. Nhấn ESC để huỷ."
      }
      if(mode === "ai"){
        return "Lens+AI: Kéo khoanh vùng để AI xử lý nội dung. Nhấn ESC để huỷ."
      }
      return "Lens+IN: Kéo khoanh vùng cần in. Nội dung quét sẽ tự thử lưu lịch sử KQXS. Nhấn ESC để huỷ."
    }

    function startLensRegionMode(mode){
      if(lensRegionState){
        return
      }

      const web = getActiveWebview()
      const main = document.querySelector(".main")
      if(!web || !main){
        alert("Không tìm thấy trang web để quét")
        return
      }

      const overlay = document.createElement("div")
      overlay.className = "print-region-overlay"
      overlay.innerHTML = `
        <div class="print-region-tip">${escapeHtml(getLensModeTip(mode))}</div>
        <div class="print-region-box"></div>
      `

      const box = overlay.querySelector(".print-region-box")
      let dragging = false
      let startX = 0
      let startY = 0

      function getLocalPoint(event){
        const rect = overlay.getBoundingClientRect()
        return {
          x: Math.max(0, Math.min(rect.width, event.clientX - rect.left)),
          y: Math.max(0, Math.min(rect.height, event.clientY - rect.top))
        }
      }

      function drawBox(x, y, w, h){
        box.style.display = "block"
        box.style.left = `${x}px`
        box.style.top = `${y}px`
        box.style.width = `${w}px`
        box.style.height = `${h}px`
      }

      const onMouseDown = (event)=>{
        dragging = true
        const p = getLocalPoint(event)
        startX = p.x
        startY = p.y
        drawBox(startX, startY, 0, 0)
      }

      const onMouseMove = (event)=>{
        if(!dragging){
          return
        }
        const p = getLocalPoint(event)
        const left = Math.min(startX, p.x)
        const top = Math.min(startY, p.y)
        const width = Math.abs(p.x - startX)
        const height = Math.abs(p.y - startY)
        drawBox(left, top, width, height)
      }

      const onMouseUp = async (event)=>{
        if(!dragging){
          return
        }
        dragging = false

        const p = getLocalPoint(event)
        const left = Math.min(startX, p.x)
        const top = Math.min(startY, p.y)
        const width = Math.abs(p.x - startX)
        const height = Math.abs(p.y - startY)

        if(width < 12 || height < 12){
          cancelLensRegionMode()
          return
        }

        await captureLensRegion(mode, { left, top, width, height }, overlay, web)
      }

      const onKeyDown = (event)=>{
        if(event.key === "Escape"){
          cancelLensRegionMode()
        }
      }

      overlay.addEventListener("mousedown", onMouseDown)
      overlay.addEventListener("mousemove", onMouseMove)
      overlay.addEventListener("mouseup", onMouseUp)
      window.addEventListener("keydown", onKeyDown)
      main.appendChild(overlay)

      lensRegionState = {
        mode,
        overlay,
        onMouseDown,
        onMouseMove,
        onMouseUp,
        onKeyDown
      }
    }

    function cancelLensRegionMode(){
      if(!lensRegionState){
        return
      }

      const { overlay, onMouseDown, onMouseMove, onMouseUp, onKeyDown } = lensRegionState
      overlay.removeEventListener("mousedown", onMouseDown)
      overlay.removeEventListener("mousemove", onMouseMove)
      overlay.removeEventListener("mouseup", onMouseUp)
      window.removeEventListener("keydown", onKeyDown)
      overlay.remove()
      lensRegionState = null
    }

    function resolveCaptureRect(rect, overlay, web){
      const overlayRect = overlay.getBoundingClientRect()
      const webRect = web.getBoundingClientRect()

      const globalLeft = overlayRect.left + rect.left
      const globalTop = overlayRect.top + rect.top
      const x = Math.max(0, Math.round(globalLeft - webRect.left))
      const y = Math.max(0, Math.round(globalTop - webRect.top))
      const width = Math.min(Math.round(rect.width), Math.max(1, Math.round(webRect.width - x)))
      const height = Math.min(Math.round(rect.height), Math.max(1, Math.round(webRect.height - y)))

      if(width < 5 || height < 5){
        return null
      }

      return { x, y, width, height }
    }

    function scoreLensText(text){
      const value = String(text || "").trim()
      if(!value) return 0
      const digitCount = (value.match(/\d/g) || []).length
      return value.length + digitCount * 4
    }

    function pickBestLensText(primary, secondary){
      const first = String(primary || "").trim()
      const second = String(secondary || "").trim()
      if(scoreLensText(second) > scoreLensText(first)){
        return second
      }
      return first
    }

    async function saveScannedTextToHistory(rawText, stationHint){
      const text = String(rawText || "").trim()
      if(!text){
        return { ok: false, error: "Nội dung quét trống" }
      }

      try{
        const saveRes = await ipcRenderer.invoke("kqxs:save-manual-copy", { text, stationHint })
        if(saveRes?.ok){
          applySavedResult(saveRes)
          return { ok: true }
        }
        return { ok: false, error: saveRes?.error || "Lưu lịch sử thất bại" }
      }catch(e){
        return { ok: false, error: e?.message || "Lưu lịch sử thất bại" }
      }
    }

    async function runLensOcrByAi(imageDataUrl){
      try{
        const res = await ipcRenderer.invoke("lens:ocr-image", { imageDataUrl })
        if(!res || !res.ok){
          return { ok: false, text: "", error: res?.error || "OCR thất bại" }
        }
        return { ok: true, text: String(res.text || "").trim(), error: "" }
      }catch(e){
        return { ok: false, text: "", error: e?.message || "OCR thất bại" }
      }
    }

    async function runLensAiProcess(imageDataUrl, textHint){
      try{
        const res = await ipcRenderer.invoke("lens:ai-process", {
          imageDataUrl,
          textHint,
          instruction: "Xử lý nội dung vùng quét để hỗ trợ đọc kết quả xổ số và đối chiếu vé."
        })
        if(!res || !res.ok){
          return { ok: false, result: "", error: res?.error || "AI xử lý thất bại" }
        }
        return { ok: true, result: String(res.result || "").trim(), error: "" }
      }catch(e){
        return { ok: false, result: "", error: e?.message || "AI xử lý thất bại" }
      }
    }

    async function captureLensRegion(mode, rect, overlay, web){
      try{
        const captureRect = resolveCaptureRect(rect, overlay, web)
        if(!captureRect){
          alert("Vùng quét không hợp lệ")
          return
        }

        const stationHint = await collectStationHint()
        const extractedDomText = await extractTextFromRegion(web, captureRect)
        const image = await web.capturePage(captureRect)
        const imageDataUrl = `data:image/png;base64,${image.toPNG().toString("base64")}`

        if(mode === "print"){
          if(extractedDomText){
            await saveScannedTextToHistory(extractedDomText, stationHint)
          }
          const jpegDataUrl = `data:image/jpeg;base64,${image.toJPEG(92).toString("base64")}`
          printImageDataUrl(jpegDataUrl)
          return
        }

        const ocrRes = await runLensOcrByAi(imageDataUrl)
        const recognizedText = pickBestLensText(extractedDomText, ocrRes.text)
        const savedRes = recognizedText
          ? await saveScannedTextToHistory(recognizedText, stationHint)
          : { ok: false, error: "Không có dữ liệu text để lưu lịch sử" }

        if(mode === "ocr"){
          const metaLines = []
          if(ocrRes.ok){
            metaLines.push("OCR thành công.")
          }else{
            metaLines.push(`OCR lỗi: ${ocrRes.error}`)
          }
          if(savedRes.ok){
            metaLines.push("Đã tự lưu vào lịch sử KQXS.")
          }else if(recognizedText){
            metaLines.push(`Không tự lưu được lịch sử: ${savedRes.error}`)
          }

          openLensResultModal({
            title: "Kết quả Lens+OCR",
            meta: metaLines.join("\n"),
            text: recognizedText || "(Không nhận diện được nội dung)"
          })
          return
        }

        const aiRes = await runLensAiProcess(imageDataUrl, recognizedText)
        const metaLines = []
        if(savedRes.ok){
          metaLines.push("Đã tự lưu text vùng quét vào lịch sử KQXS.")
        }else if(recognizedText){
          metaLines.push(`Chưa tự lưu được lịch sử KQXS: ${savedRes.error}`)
        }
        if(!aiRes.ok){
          metaLines.push(`AI lỗi: ${aiRes.error}`)
        }

        openLensResultModal({
          title: "Kết quả Lens+AI",
          meta: metaLines.join("\n"),
          text: aiRes.ok
            ? aiRes.result
            : (recognizedText || "Không có kết quả AI.")
        })
      }catch(e){
        alert("Không thể xử lý vùng quét")
      }finally{
        cancelLensRegionMode()
      }
    }

    async function extractTextFromRegion(web, region){
      const safeRegion = {
        x: Math.max(0, Math.round(region.x || 0)),
        y: Math.max(0, Math.round(region.y || 0)),
        width: Math.max(1, Math.round(region.width || 1)),
        height: Math.max(1, Math.round(region.height || 1))
      }

      try{
        const regionJson = JSON.stringify(safeRegion)
        const text = await web.executeJavaScript(`
          (() => {
            const region = ${regionJson}
            const rx2 = region.x + region.width
            const ry2 = region.y + region.height

            const intersects = (r) => !(r.right < region.x || r.left > rx2 || r.bottom < region.y || r.top > ry2)
            const isVisible = (el) => {
              const s = window.getComputedStyle(el)
              if (s.display === "none" || s.visibility === "hidden" || Number(s.opacity || "1") === 0) return false
              const r = el.getBoundingClientRect()
              return r.width > 0 && r.height > 0
            }

            const nodes = []
            document.querySelectorAll("body *").forEach((el) => {
              if (!isVisible(el)) return
              const rect = el.getBoundingClientRect()
              if (!intersects(rect)) return
              if (el.children.length > 0) return
              const text = String(el.innerText || el.textContent || "").replace(/\\s+/g, " ").trim()
              if (!text) return
              nodes.push({ text, top: rect.top, left: rect.left })
            })

            nodes.sort((a, b) => (a.top - b.top) || (a.left - b.left))
            const lines = []
            let prev = ""
            nodes.forEach((n) => {
              if (n.text === prev) return
              lines.push(n.text)
              prev = n.text
            })

            return lines.join("\\n").trim()
          })()
        `)

        return String(text || "").trim()
      }catch(_err){
        return ""
      }
    }

    function printImageDataUrl(dataUrl){
      const printWindow = window.open("", "_blank", "width=1000,height=760")
      if(!printWindow){
        alert("Không mở được cửa sổ in")
        return
      }

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>In Vùng Đã Khoanh</title>
          <style>
            html,body{margin:0;padding:0;background:#fff}
            .wrap{padding:12px}
            img{
              display:block;
              max-width:100%;
              height:auto;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
            @media print{
              .wrap{padding:0}
            }
          </style>
        </head>
        <body>
          <div class="wrap"><img src="${dataUrl}" alt="Vung in"/></div>
        </body>
        </html>
      `)
      printWindow.document.close()
      printWindow.focus()
      setTimeout(()=>{
        printWindow.print()
        printWindow.close()
      }, 250)
    }

    function printTicketByIndex(index){
      const item = latestHistory[index]
      if(!item || !item.ticket || !Array.isArray(item.ticket.prizes) || !item.ticket.prizes.length){
        alert("Không tìm thấy bảng KQXS để in")
        return
      }

      const printContent = formatTicketLayout(item, index, true)
      const printWindow = window.open("", "_blank", "width=900,height=700")
      if(!printWindow){
        alert("Không mở được cửa sổ in")
        return
      }

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>In Vé Dò KQXS</title>
          <style>
            body{font-family:Arial,sans-serif;padding:16px;color:#111}
            .ticket-card{border:1px solid #cbd5e1;border-radius:8px;padding:8px}
            .ticket-head{font-weight:700;margin-bottom:6px}
            .ticket-meta{font-size:12px;margin-bottom:6px}
            .ticket-table{width:100%;border-collapse:collapse}
            .ticket-table th,.ticket-table td{border:1px solid #cbd5e1;padding:6px;text-align:left}
            .ticket-table th{background:#f1f5f9}
          </style>
        </head>
        <body>
          ${printContent}
        </body>
        </html>
      `)
      printWindow.document.close()
      printWindow.focus()
      setTimeout(()=>{
        printWindow.print()
        printWindow.close()
      }, 250)
    }

    const PRIZE_ORDER = ["g8","g7","g6","g5","g4","g3","g2","g1","gdb"]
    const PRIZE_LABEL = { g8:"G8", g7:"G7", g6:"G6", g5:"G5", g4:"G4", g3:"G3", g2:"G2", g1:"G1", gdb:"ĐB" }

    function normalizePrizeKeyFromRow(row){
      const key = String(row?.key || "").toLowerCase()
      if(PRIZE_ORDER.includes(key)){
        return key
      }
      const label = String(row?.label || "").toUpperCase().replace(/\s+/g,"")
      if(label === "ĐB" || label === "DB"){
        return "gdb"
      }
      const m = label.match(/^G([1-8])$/)
      return m ? `g${m[1]}` : ""
    }

    function findNumbersByPrize(ticket, prizeKey){
      const rows = Array.isArray(ticket?.prizes) ? ticket.prizes : []
      for(const row of rows){
        if(normalizePrizeKeyFromRow(row) === prizeKey){
          return Array.isArray(row.numbers) ? row.numbers : []
        }
      }
      return []
    }

    function renderResultNumbers(numbers, prizeKey){
      const safeList = (Array.isArray(numbers) ? numbers : []).map((n)=>escapeHtml(String(n || ""))).filter(Boolean)
      const cls = prizeKey === "gdb" || prizeKey === "g7" ? `${prizeKey} db` : prizeKey
      if(!safeList.length){
        return `<div class="result-values ${cls}">-</div>`
      }
      return `<div class="result-values ${cls}">${safeList.join("<br>")}</div>`
    }

    function resolveDrawTitle(item){
      const ticketDate = String(item?.ticket?.drawDate || "").trim()
      if(ticketDate){
        return ticketDate
      }
      const iso = String(item?.date || "").trim()
      if(!iso){
        return "Chưa rõ ngày"
      }
      const d = new Date(iso)
      if(Number.isNaN(d.getTime())){
        return iso
      }
      const dd = String(d.getDate()).padStart(2,"0")
      const mm = String(d.getMonth()+1).padStart(2,"0")
      const yyyy = d.getFullYear()
      return `${dd}/${mm}/${yyyy}`
    }

    function renderKQXSHistory(history){
      latestHistory = Array.isArray(history) ? history : []
      const boardsEl = document.getElementById("historyBoards")
      boardsEl.innerHTML = ""
      if(!Array.isArray(history) || !history.length){
        boardsEl.innerHTML = `<div class="history-draw"><div class="history-draw-title">Chưa có lịch sử quét</div></div>`
        return
      }

      const tickets = history.filter((item)=>Array.isArray(item?.ticket?.prizes) && item.ticket.prizes.length)
      if(!tickets.length){
        boardsEl.innerHTML = `<div class="history-draw"><div class="history-draw-title">Chưa có lịch sử bảng KQXS</div></div>`
        return
      }

      const drawMap = new Map()
      tickets.forEach((item)=>{
        const drawTitle = resolveDrawTitle(item)
        if(!drawMap.has(drawTitle)){
          drawMap.set(drawTitle, [])
        }
        drawMap.get(drawTitle).push(item)
      })

      drawMap.forEach((items, drawTitle)=>{
        const stationMap = new Map()
        items.forEach((item)=>{
          const station = displayStationName(item?.ticket?.station || item?.station || "")
          if(!stationMap.has(station)){
            stationMap.set(station, item)
          }
        })

        const stations = Array.from(stationMap.entries())
        if(!stations.length){
          return
        }

        const headerCols = stations.map(([station])=>`<th>${escapeHtml(station)}</th>`).join("")
        const bodyRows = PRIZE_ORDER.map((prizeKey)=>{
          const cols = stations.map(([,item])=>{
            const nums = findNumbersByPrize(item.ticket, prizeKey)
            return `<td>${renderResultNumbers(nums, prizeKey)}</td>`
          }).join("")
          return `<tr><td class="result-prize">${PRIZE_LABEL[prizeKey]}</td>${cols}</tr>`
        }).join("")

        const drawDiv = document.createElement("div")
        drawDiv.className = "history-draw"
        drawDiv.innerHTML = `
          <div class="history-draw-title">Kết quả đã lưu ngày ${escapeHtml(drawTitle)}</div>
          <table class="result-table">
            <thead><tr><th></th>${headerCols}</tr></thead>
            <tbody>${bodyRows}</tbody>
          </table>
        `
        boardsEl.appendChild(drawDiv)
      })
    }

    function enableKqxsCustomLayout(){
      kqxsLayoutState.enableCustomLayout = !kqxsLayoutState.enableCustomLayout
      
      const boards = document.querySelectorAll(".history-draw table")
      boards.forEach(table => {
        if(kqxsLayoutState.enableCustomLayout){
          table.classList.add("layout-editable")
          makeTableSortable(table)
        }else{
          table.classList.remove("layout-editable")
        }
      })
      
      alert(kqxsLayoutState.enableCustomLayout 
        ? "Đã bật chế độ tùy chỉnh bố cục. Kéo thả các cột để sắp xếp lại. Bấm 'Lưu bố cục' để lưu." 
        : "Đã tắt chế độ tùy chỉnh bố cục.")
    }

    function makeTableSortable(table){
      const headers = table.querySelectorAll("thead th")
      headers.forEach((header, index) => {
        if(index === 0) return
        header.style.cursor = "move"
        header.draggable = true
        
        header.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", index)
          header.classList.add("dragging")
        })
        
        header.addEventListener("dragend", () => {
          header.classList.remove("dragging")
        })
        
        header.addEventListener("dragover", (e) => {
          e.preventDefault()
        })
        
        header.addEventListener("drop", (e) => {
          e.preventDefault()
          const fromIndex = parseInt(e.dataTransfer.getData("text/plain"))
          const toIndex = index
          if(fromIndex !== toIndex){
            reorderTableColumns(table, fromIndex, toIndex)
            saveKqxsLayout(table)
          }
        })
      })
    }

    function reorderTableColumns(table, fromIndex, toIndex){
      const rows = table.querySelectorAll("tr")
      rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll("th, td"))
        if(fromIndex < cells.length && toIndex < cells.length){
          const fromCell = cells[fromIndex]
          const toCell = cells[toIndex]
          const temp = fromCell.innerHTML
          fromCell.innerHTML = toCell.innerHTML
          toCell.innerHTML = temp
        }
      })
    }

    function saveKqxsLayout(table){
      const headers = Array.from(table.querySelectorAll("thead th"))
      const order = headers.map((h, i) => ({ index: i, text: h.textContent.trim() }))
      kqxsLayoutState.customLayout = order
      
      try{
        localStorage.setItem("kqxs_custom_layout", JSON.stringify(order))
        appendAdbTerminalOutput("Đã lưu bố cục KQXS tùy chỉnh.")
      }catch(_e){}
    }

    function loadKqxsLayout(){
      try{
        const saved = localStorage.getItem("kqxs_custom_layout")
        if(saved){
          kqxsLayoutState.customLayout = JSON.parse(saved)
        }
      }catch(_e){}
    }

    async function aiRecognizeLayout(){
      const historyText = latestHistory.map(item => {
        return `Ngày: ${resolveDrawTitle(item)}, Đài: ${item?.ticket?.station || ""}, KQ: ${JSON.stringify(item?.ticket?.prizes || [])}`
      }).join("\n\n")

      if(!historyText){
        alert("Chưa có dữ liệu KQXS để AI nhận diện bố cục.")
        return
      }

      const modal = document.getElementById("lensResultModal")
      document.getElementById("lensResultTitle").textContent = "AI nhận diện bố cục KQXS"
      document.getElementById("lensResultMeta").textContent = "AI đang phân tích bố cục KQXS của bạn..."
      document.getElementById("lensResultInput").value = "Đang phân tích..."
      modal.classList.add("show")

      try{
        const prompt = `Dựa trên dữ liệu KQXS sau đây, hãy:\n1. Nhận diện bố cục hiện tại\n2. Đề xuất bố cục tối ưu để phân tích\n3. Sắp xếp các đài theo thứ tự u tiên phân tích\n\nDữ liệu KQXS:\n${historyText}\n\nHãy trả lời bằng tiếng Việt và đưa ra đề xuất cụ thể.`

        const res = await ipcRenderer.invoke("lotoai:chat", {
          provider: appSettings.ai.internalProvider || "ollama",
          model: appSettings.ai.ollamaModel || "llama2:7b",
          messages: [
            { role: "user", content: prompt }
          ]
        })

        if(res?.ok && res.response){
          document.getElementById("lensResultInput").value = res.response
          document.getElementById("lensResultMeta").textContent = "AI đã phân tích xong bố cục KQXS."
        }else{
          document.getElementById("lensResultInput").value = "Lỗi: " + (res?.error || "Không thể kết nối AI")
        }
      }catch(e){
        document.getElementById("lensResultInput").value = "Lỗi: " + e.message
      }
    }

    function copyKqxsSelection(){
      const selected = document.querySelectorAll(".history-draw.selected")
      if(selected.length === 0){
        alert("Chưa chọn bảng để sao chép. Bấm vào bảng để chọn.")
        return
      }
      
      let text = ""
      selected.forEach(draw => {
        const title = draw.querySelector(".history-draw-title")?.textContent || ""
        text += `\n${title}\n`
        const rows = draw.querySelectorAll("tr")
        rows.forEach(row => {
          const cells = Array.from(row.querySelectorAll("th, td")).map(c => c.textContent.trim()).join(" | ")
          text += cells + "\n"
        })
      })
      
      navigator.clipboard.writeText(text).then(() => {
        alert(`Đã sao chép ${selected.length} bảng vào clipboard.`)
      }).catch(() => {
        alert("Không thể sao chép.")
      })
    }

    async function pasteKqxsData(){
      try{
        const text = await navigator.clipboard.readText()
        if(!text || !text.trim()){
          alert("Không có dữ liệu trong clipboard.")
          return
        }
        
        const modal = document.getElementById("manualScanModal")
        document.getElementById("manualScanInput").value = text
        modal.classList.add("show")
      }catch(e){
        alert("Không thể đọc clipboard. Vui lòng cấp quyền truy cập clipboard.")
      }
    }

    function addKqxsFromImage(){
      alert("Chức năng thêm từ ảnh:\n\nBạn có thể:\n1. Dán ảnh (Ctrl+V) vào ô nhập liệu\n2. Sử dụng Lens+OCR để quét ảnh\n3. Sử dụng Lens+AI để AI nhận diện")
      
      const modal = document.getElementById("manualScanModal")
      modal.classList.add("show")
      
      const textarea = document.getElementById("manualScanInput")
      textarea.focus()
      
      textarea.addEventListener("paste", async (e) => {
        const items = e.clipboardData?.items
        if(!items) return
        
        for(const item of items){
          if(item.type.startsWith("image/")){
            e.preventDefault()
            const blob = item.getAsFile()
            if(blob){
              processKqxsImage(blob)
            }
            break
          }
        }
      }, { once: true })
    }

    async function processKqxsImage(blob){
      try{
        const arrayBuffer = await blob.arrayBuffer()
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
        
        appendAdbTerminalOutput("Đang xử lý ảnh KQXS...")
        
        const res = await ipcRenderer.invoke("lens:ocr-image", {
          imageBase64: `data:image/png;base64,${base64}`
        })
        
        if(res?.ok && res.text){
          document.getElementById("manualScanInput").value = res.text
          appendAdbTerminalOutput("Đã nhận diện text từ ảnh.")
        }else{
          alert("Không nhận diện được text từ ảnh: " + (res?.error || ""))
        }
      }catch(e){
        alert("Lỗi xử lý ảnh: " + e.message)
      }
    }

    function deleteKqxsSelection(){
      const selected = document.querySelectorAll(".history-draw.selected")
      if(selected.length === 0){
        alert("Chưa chọn bảng để xoá. Bấm vào bảng để chọn.")
        return
      }
      
      if(!confirm(`Bạn có chắc muốn xoá ${selected.length} bảng đã chọn?`)){
        return
      }
      
      selected.forEach(draw => draw.remove())
      
      const remaining = document.querySelectorAll(".history-draw")
      if(remaining.length === 0){
        document.getElementById("historyBoards").innerHTML = `<div class="history-draw"><div class="history-draw-title">Chưa có lịch sử quét</div></div>`
      }
      
      appendAdbTerminalOutput(`Đã xoá ${selected.length} bảng KQXS.`)
    }

    document.addEventListener("click", (e) => {
      if(kqxsLayoutState.enableCustomLayout){
        const draw = e.target.closest(".history-draw")
        if(draw){
          if(draw.classList.contains("selected")){
            draw.classList.remove("selected")
          }else{
            draw.classList.add("selected")
          }
        }
      }
    })

    document.addEventListener("keydown", async (e) => {
      const settingsModal = document.getElementById("settingsModal")
      const isSettingsOpen = settingsModal?.classList.contains("show")
      
      if(isSettingsOpen && (e.key === "Escape")){
        closeSettingsModal()
        return
      }
      
      if(e.ctrlKey || e.metaKey){
        if(e.key === "v" && document.getElementById("historyWrap").classList.contains("hidden") === false){
          const modal = document.getElementById("manualScanModal")
          if(modal.classList.contains("show")){
            return
          }
          
          try{
            const text = await navigator.clipboard.readText()
            if(text){
              document.getElementById("manualScanInput").value = text
              document.getElementById("manualScanModal").classList.add("show")
            }
          }catch(_e){}
        }
      }
      
      // Scroll settings with keyboard when modal is open
      if(isSettingsOpen){
        if(e.key === "PageUp"){
          e.preventDefault()
          scrollSettingsUp()
        }else if(e.key === "PageDown"){
          e.preventDefault()
          scrollSettingsDown()
        }else if(e.key === "Home" && !e.ctrlKey){
          e.preventDefault()
          document.getElementById("settingsModalBox").scrollTo({top:0, behavior:"smooth"})
        }else if(e.key === "End"){
          e.preventDefault()
          const box = document.getElementById("settingsModalBox")
          box.scrollTo({top:box.scrollHeight, behavior:"smooth"})
        }
        return
      }
      
      // Keyboard shortcuts for navigation
      if(e.altKey){
        if(e.key === "ArrowLeft"){
          e.preventDefault()
          goBack()
        }else if(e.key === "ArrowRight"){
          e.preventDefault()
          goForward()
        }
      }
      
      if(e.key === "PageUp"){
        e.preventDefault()
        scrollPageUp()
      }else if(e.key === "PageDown"){
        e.preventDefault()
        scrollPageDown()
      }else if(e.key === "Home"){
        if(!e.ctrlKey){
          e.preventDefault()
          scrollToTop()
        }
      }else if(e.key === "End"){
        e.preventDefault()
        scrollToBottom()
      }
    })

    function normalizeKqxsDigits(value){
      return String(value || "").replace(/\D/g, "")
    }

    function increaseCounter(counterMap, key){
      if(!key){
        return
      }
      counterMap.set(key, Number(counterMap.get(key) || 0) + 1)
    }

    function toTopCounterList(counterMap, limit=10){
      return Array.from(counterMap.entries())
        .map(([number, count])=>({ number, count: Number(count || 0) }))
        .sort((a, b)=>{
          if(b.count !== a.count){
            return b.count - a.count
          }
          return String(a.number).localeCompare(String(b.number), "vi")
        })
        .slice(0, limit)
    }

    function formatCounterEntry(entry){
      if(!entry || !entry.number){
        return "-"
      }
      return `${entry.number} (${entry.count} lần)`
    }

    function formatCounterSeries(entries, limit=3){
      const series = (Array.isArray(entries) ? entries : [])
        .slice(0, limit)
        .map((entry)=>formatCounterEntry(entry))
      return series.length ? series.join(" | ") : "-"
    }

    function buildLoStatsFromHistory(history){
      const rows = Array.isArray(history) ? history : []
      const tickets = rows.filter((item)=>Array.isArray(item?.ticket?.prizes) && item.ticket.prizes.length)
      const overall = {
        2: new Map(),
        3: new Map(),
        4: new Map()
      }
      const stationMap = new Map()
      let tokenCount = 0

      tickets.forEach((item)=>{
        const station = displayStationName(item?.ticket?.station || item?.station || "")
        if(!stationMap.has(station)){
          stationMap.set(station, {
            2: new Map(),
            3: new Map(),
            4: new Map(),
            tokens: 0
          })
        }
        const stationBucket = stationMap.get(station)
        const prizes = Array.isArray(item?.ticket?.prizes) ? item.ticket.prizes : []
        prizes.forEach((prize)=>{
          const numbers = Array.isArray(prize?.numbers) ? prize.numbers : []
          numbers.forEach((rawNumber)=>{
            const digits = normalizeKqxsDigits(rawNumber)
            if(!digits){
              return
            }
            tokenCount += 1
            stationBucket.tokens += 1
            ;[2,3,4].forEach((length)=>{
              if(digits.length < length){
                return
              }
              const tail = digits.slice(-length)
              increaseCounter(overall[length], tail)
              increaseCounter(stationBucket[length], tail)
            })
          })
        })
      })

      const stationRows = Array.from(stationMap.entries())
        .map(([station, bucket])=>({
          station,
          tokens: Number(bucket.tokens || 0),
          top2: toTopCounterList(bucket[2], 3),
          top3: toTopCounterList(bucket[3], 3),
          top4: toTopCounterList(bucket[4], 3)
        }))
        .filter((row)=>row.top2.length || row.top3.length || row.top4.length)
        .sort((a, b)=>{
          if(b.tokens !== a.tokens){
            return b.tokens - a.tokens
          }
          return a.station.localeCompare(b.station, "vi")
        })

      return {
        tokenCount,
        overallTop: {
          2: toTopCounterList(overall[2], 10),
          3: toTopCounterList(overall[3], 10),
          4: toTopCounterList(overall[4], 10)
        },
        stationRows
      }
    }

    function renderLoTopChips(entries){
      const items = Array.isArray(entries) ? entries : []
      if(!items.length){
        return `<div class="analysis-chip-list"><span class="analysis-chip">Chưa có dữ liệu</span></div>`
      }
      return `
        <div class="analysis-chip-list">
          ${items.map((entry)=>`<span class="analysis-chip"><strong>${escapeHtml(entry.number)}</strong>${escapeHtml(String(entry.count || 0))} lần</span>`).join("")}
        </div>
      `
    }

    function renderTopStats(top, history){
      const groupsEl = document.getElementById("analysisBoards")
      const note = document.getElementById("topStatsNote")
      groupsEl.innerHTML = ""

      const groups = Array.isArray(top)
        ? top.filter((group)=>Array.isArray(group?.top) && group.top.length)
        : []
      const loStats = buildLoStatsFromHistory(history)
      const hasLoData = Boolean(
        loStats.overallTop[2].length ||
        loStats.overallTop[3].length ||
        loStats.overallTop[4].length
      )

      if(!groups.length && !hasLoData){
        groupsEl.innerHTML = `<div class="analysis-card"><div class="analysis-title">Chưa có dữ liệu phân tích</div></div>`
        note.textContent = "AI chưa đủ dữ liệu để nhận định theo đài."
        return
      }

      let best = null
      const stationSummaries = []
      const sections = []

      if(groups.length){
        const TOP_BY_STATION_LIMIT = 3
        const sortedGroups = groups
          .map((group)=>({
            station: displayStationName(group.dai || ""),
            top: group.top.slice(0, TOP_BY_STATION_LIMIT)
          }))
          .sort((a, b)=>a.station.localeCompare(b.station, "vi"))

        let maxRows = 0
        sortedGroups.forEach((group)=>{
          const station = group.station
          const topList = group.top
          if(topList.length > maxRows){
            maxRows = topList.length
          }
          const topOne = topList[0]
          const topNumber = topOne?.number || "-"
          const topCount = Number(topOne?.count || 0)
          stationSummaries.push(`${station}: ${topNumber} (${topCount} lần)`)

          topList.forEach((entry)=>{
            const number = entry?.number || ""
            const count = Number(entry?.count || 0)
            if(!best || count > best.count){
              best = { station, number, count }
            }
          })
        })

        maxRows = Math.max(1, Math.min(TOP_BY_STATION_LIMIT, maxRows))
        const headerCols = sortedGroups.map((group)=>`<th>${escapeHtml(group.station)}</th>`).join("")
        const bodyRows = []
        for(let i=0;i<maxRows;i++){
          const cols = sortedGroups.map((group)=>{
            const entry = group.top[i]
            if(!entry){
              return `<td>-</td>`
            }
            const number = String(entry.number || "-")
            const count = Number(entry.count || 0)
            return `<td><span class="analysis-number">${escapeHtml(number)}</span> <span class="analysis-count">(${count} lần)</span></td>`
          }).join("")
          bodyRows.push(`<tr><td class="analysis-rank">Top ${i+1}</td>${cols}</tr>`)
        }

        sections.push(`
          <div class="analysis-card analysis-card-wide">
            <div class="analysis-title">Top số xuất hiện theo từng đài</div>
            <table class="analysis-table analysis-columns-table">
              <thead><tr><th>Hạng</th>${headerCols}</tr></thead>
              <tbody>${bodyRows.join("")}</tbody>
            </table>
          </div>
        `)
      }

      if(hasLoData){
        sections.push(`
          <div class="analysis-card analysis-card-wide">
            <div class="analysis-title">AI Phân Tích Top Lô 2 - 3 - 4 Số</div>
            <div class="analysis-smart-grid">
              <div class="ticket-card">
                <div class="analysis-subtitle">Top lô 2 số</div>
                ${renderLoTopChips(loStats.overallTop[2])}
              </div>
              <div class="ticket-card">
                <div class="analysis-subtitle">Top lô 3 số</div>
                ${renderLoTopChips(loStats.overallTop[3])}
              </div>
              <div class="ticket-card">
                <div class="analysis-subtitle">Top lô 4 số</div>
                ${renderLoTopChips(loStats.overallTop[4])}
              </div>
            </div>
          </div>
        `)

        const stationRows = loStats.stationRows.slice(0, 12)
        if(stationRows.length){
          const stationLoRows = stationRows.map((row)=>`
            <tr>
              <td>${escapeHtml(row.station)}</td>
              <td>${escapeHtml(formatCounterSeries(row.top2))}</td>
              <td>${escapeHtml(formatCounterSeries(row.top3))}</td>
              <td>${escapeHtml(formatCounterSeries(row.top4))}</td>
            </tr>
          `).join("")

          sections.push(`
            <div class="analysis-card analysis-card-wide">
              <div class="analysis-title">AI Phân Tích Theo Đài (Lô 2/3/4)</div>
              <table class="analysis-mini-table">
                <thead>
                  <tr>
                    <th>Đài</th>
                    <th>Top lô 2 số</th>
                    <th>Top lô 3 số</th>
                    <th>Top lô 4 số</th>
                  </tr>
                </thead>
                <tbody>${stationLoRows}</tbody>
              </table>
            </div>
          `)
        }
      }

      groupsEl.innerHTML = sections.join("")

      const insightLines = []
      if(best){
        insightLines.push(`AI nhận định theo đài: ${best.station} có số nổi bật ${best.number} (${best.count} lần).`)
      }
      if(hasLoData){
        const top2 = formatCounterEntry(loStats.overallTop[2][0])
        const top3 = formatCounterEntry(loStats.overallTop[3][0])
        const top4 = formatCounterEntry(loStats.overallTop[4][0])
        insightLines.push(`Top toàn bộ: lô 2 số ${top2}; lô 3 số ${top3}; lô 4 số ${top4}.`)
      }
      if(stationSummaries.length){
        insightLines.push(`Tổng hợp nhanh theo đài: ${stationSummaries.slice(0, 8).join(" | ")}.`)
      }
      if(loStats.tokenCount){
        insightLines.push(`Dữ liệu AI đã quét ${loStats.tokenCount} cụm số từ lịch sử KQXS.`)
      }

      note.innerHTML = insightLines.length
        ? insightLines.map((line)=>escapeHtml(line)).join("<br>")
        : "AI chưa đủ dữ liệu để nhận định theo đài."
    }

    async function loadKQXSData(){
      try{
        const [historyRes, topRes] = await Promise.all([
          ipcRenderer.invoke("kqxs:get-history"),
          ipcRenderer.invoke("kqxs:get-top-by-station")
        ])

        const history = historyRes?.ok ? (historyRes.history || []) : []
        renderKQXSHistory(history)

        if(!topRes || !topRes.ok){
          renderTopStats([], history)
        }else{
          renderTopStats(topRes.topByStation || [], history)
        }
      }catch(e){
        renderKQXSHistory([])
        renderTopStats([], [])
      }
    }

    async function clearKQXSHistory(){
      const ok = confirm("Bạn chắc chắn muốn xoá toàn bộ lịch sử KQXS?")
      if(!ok){
        return
      }

      try{
        const res = await ipcRenderer.invoke("kqxs:clear-history")
        if(!res || !res.ok){
          alert(res?.error || "Xoá lịch sử thất bại")
          return
        }
        renderKQXSHistory([])
        renderTopStats(res.topByStation || [], [])
      }catch(e){
        alert("Xoá lịch sử thất bại")
      }
    }

    function openStartupAiTool(){
      const startupToolId = String(appSettings.ai.startupToolId || "")
      if(!startupToolId){
        return
      }
      const startupTool = getAiToolById(startupToolId)
      if(startupTool && startupTool.enabled){
        openAiToolById(startupToolId)
        return
      }
      const firstEnabled = getEnabledTools()[0]
      if(firstEnabled){
        openAiToolById(firstEnabled.id)
      }
    }

    const startupWeb = getActiveWebview()
    applyInterfaceSettingsToUi()
    loadCustomCssOnStartup()
    syncAiRuntimeConfig()
    refreshLotoAiModels(false)
    updateMicButton()
    if(startupWeb){
      attachWebviewEvents(startupWeb)
      openStartupAiTool()
    }
    document.getElementById("url").addEventListener("keydown", (event)=>{
      if(event.key === "Enter"){
        event.preventDefault()
        openUrl()
      }
    })
    document.getElementById("lotoAiInput").addEventListener("keydown", (event)=>{
      if(event.key === "Enter" && !event.shiftKey){
        event.preventDefault()
        sendLotoAiMessage()
      }
    })
    document.getElementById("geminiAiInput").addEventListener("keydown", (event)=>{
      if(event.key === "Enter" && !event.shiftKey){
        event.preventDefault()
        sendGeminiAiMessage()
      }
    })
    document.getElementById("adbTerminalInput").addEventListener("keydown", (event)=>{
      if(event.key === "Enter"){
        event.preventDefault()
        runAdbTerminalCommand()
      }
    })
    refreshAdbToolsStatus(false)
    applyZoom()
    loadKQXSData()
    window.addEventListener("beforeunload", ()=>{
      stopVoiceCommand()
    })
</script>

</body>
</html>
